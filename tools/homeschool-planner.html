<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homeschool Planner & Gradebook</title>
    <style>
        /* ===== CSS Reset & Base Styles ===== */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f9fafb;
            --card-bg: #ffffff;
            --text: #111827;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 8px;
            --sidebar-width: 240px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ===== Layout ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--card-bg);
            border-right: 1px solid var(--border);
            padding: 1.5rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        .sidebar-header {
            padding: 0 1.5rem 1.5rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .sidebar-header h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg);
            border-left-color: var(--primary);
        }

        .nav-item.active {
            background: var(--bg);
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 2rem;
            max-width: 1400px;
        }

        .top-bar {
            background: var(--card-bg);
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .top-bar-left {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            width: 250px;
            font-size: 0.875rem;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        /* ===== Cards ===== */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
        }

        /* ===== Buttons ===== */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-outline:hover {
            background: var(--bg);
        }

        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
        }

        /* ===== Forms ===== */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        /* ===== Tables ===== */
        .table-container {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
        }

        thead {
            background: var(--bg);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text);
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        tr:hover {
            background: var(--bg);
        }

        .table-input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.875rem;
        }

        /* ===== Lists ===== */
        .list-item {
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .list-item:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .list-item-content h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .list-item-content p {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .list-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* ===== Badges ===== */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-primary {
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary);
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--secondary);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        /* ===== Modal ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* ===== Tabs ===== */
        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-light);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== Nested Structure ===== */
        .nested-item {
            margin-left: 2rem;
            padding-left: 1rem;
            border-left: 2px solid var(--border);
        }

        .collapsible {
            cursor: pointer;
            user-select: none;
        }

        .collapsible::before {
            content: '‚ñº';
            display: inline-block;
            margin-right: 0.5rem;
            transition: transform 0.2s;
        }

        .collapsible.collapsed::before {
            transform: rotate(-90deg);
        }

        /* ===== Utilities ===== */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }

        .flex {
            display: flex;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gap-1 {
            gap: 0.5rem;
        }

        .gap-2 {
            gap: 1rem;
        }

        /* ===== Print Styles ===== */
        @media print {
            body {
                background: white;
            }

            .sidebar, .top-bar, .no-print {
                display: none !important;
            }

            .main-content {
                margin-left: 0;
                padding: 0;
            }

            .card {
                box-shadow: none;
                page-break-inside: avoid;
            }

            .print-page {
                font-family: Georgia, 'Times New Roman', serif;
                max-width: 8.5in;
                margin: 0 auto;
                padding: 0.5in;
            }

            .print-header {
                text-align: center;
                margin-bottom: 2rem;
                border-bottom: 2px solid #000;
                padding-bottom: 1rem;
            }

            .print-header h1 {
                font-size: 18pt;
                margin-bottom: 0.5rem;
            }

            .print-header p {
                font-size: 10pt;
                margin: 0.25rem 0;
            }

            .print-section {
                margin: 1.5rem 0;
                page-break-inside: avoid;
            }

            .print-section h2 {
                font-size: 14pt;
                margin-bottom: 1rem;
                border-bottom: 1px solid #000;
                padding-bottom: 0.5rem;
            }

            table {
                border-collapse: collapse;
                width: 100%;
                font-size: 10pt;
            }

            th, td {
                border: 1px solid #000;
                padding: 0.5rem;
            }

            .signature-line {
                margin-top: 3rem;
                border-top: 1px solid #000;
                padding-top: 0.5rem;
                width: 300px;
            }
        }

        /* ===== Save Indicator ===== */
        .save-indicator {
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .save-indicator.saved {
            background: rgba(16, 185, 129, 0.1);
            color: var(--secondary);
        }

        .save-indicator.saving {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        /* ===== Empty State ===== */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        /* ===== Accordion ===== */
        .accordion-item {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
            overflow: hidden;
        }

        .accordion-header {
            padding: 1rem;
            background: var(--bg);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .accordion-header:hover {
            background: #f3f4f6;
        }

        .accordion-content {
            padding: 1rem;
            display: none;
        }

        .accordion-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>üìö Homeschool</h1>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active" data-view="dashboard">Dashboard</li>
                <li class="nav-item" data-view="students">Students</li>
                <li class="nav-item" data-view="subjects">Subjects</li>
                <li class="nav-item" data-view="courses">Courses</li>
                <li class="nav-item" data-view="gradebook">Gradebook</li>
                <li class="nav-item" data-view="planner">Lesson Planner</li>
                <li class="nav-item" data-view="transcript">Transcripts</li>
                <li class="nav-item" data-view="portfolio">Portfolio & Files</li>
                <li class="nav-item" data-view="alt-credits">Alt Credits</li>
                <li class="nav-item" data-view="reports">Reports</li>
                <li class="nav-item" data-view="settings">Settings</li>
                <li class="nav-item" data-view="backup">Backup & Export</li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar no-print">
                <div class="top-bar-left">
                    <div class="search-box">
                        <span class="search-icon">üîç</span>
                        <input type="text" placeholder="Search..." id="global-search">
                    </div>
                    <select class="form-select" id="year-selector" style="width: auto;">
                        <option>2024-2025</option>
                        <option>2025-2026</option>
                        <option>All Years</option>
                    </select>
                </div>
                <div class="save-indicator saved" id="save-indicator">
                    ‚úì All changes saved
                </div>
            </div>

            <!-- Important Notice -->
            <div class="card no-print" style="background: linear-gradient(135deg, #fef3e2 0%, #fff7e8 100%); border-left: 4px solid #f59e0b; margin-bottom: 1.5rem;">
                <div style="padding: 1rem;">
                    <h3 style="color: #d97706; font-size: 1.1rem; margin-bottom: 0.75rem; font-weight: 600;">üìã Important: Data Storage Notice</h3>
                    <p style="color: #78350f; line-height: 1.6; margin-bottom: 0.75rem;">
                        This planner uses browser local storage to save your data. To use the tool on another device or browser, you will need to export your data using the <strong>Backup & Export</strong> section and re-upload it on the new device.
                    </p>
                    <p style="color: #78350f; line-height: 1.6; margin: 0;">
                        <strong>Interested in a local version?</strong> If you would like to purchase a copy of the lesson planner with local file saving capabilities, please <a href="../contact.html" style="color: #d97706; text-decoration: underline;">reach out to discuss options</a>.
                    </p>
                </div>
            </div>

            <!-- Dashboard View -->
            <div id="view-dashboard" class="view-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Dashboard</h2>
                    </div>
                    <div id="dashboard-content"></div>
                </div>
            </div>

            <!-- Students View -->
            <div id="view-students" class="view-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Students</h2>
                        <button class="btn btn-primary" onclick="showStudentModal()">+ Add Student</button>
                    </div>
                    <div id="students-list"></div>
                </div>
            </div>

            <!-- Subjects View -->
            <div id="view-subjects" class="view-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Subjects</h2>
                        <button class="btn btn-primary" onclick="showSubjectModal()">+ Add Subject</button>
                    </div>
                    <div id="subjects-list"></div>
                </div>
            </div>

            <!-- Courses View -->
            <div id="view-courses" class="view-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Courses</h2>
                        <button class="btn btn-primary" onclick="showCourseModal()">+ Add Course</button>
                    </div>
                    <div id="courses-list"></div>
                </div>
            </div>

            <!-- Gradebook View -->
            <div id="view-gradebook" class="view-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Gradebook</h2>
                    </div>
                    <div id="gradebook-content"></div>
                </div>
            </div>

            <!-- Lesson Planner View -->
            <div id="view-planner" class="view-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Lesson Planner</h2>
                    </div>
                    <div id="planner-content"></div>
                </div>
            </div>

            <!-- Transcript View -->
            <div id="view-transcript" class="view-content hidden">
                <div class="card no-print">
                    <div class="card-header">
                        <h2 class="card-title">Transcript Generator</h2>
                    </div>
                    <div id="transcript-controls"></div>
                </div>
                <div id="transcript-content"></div>
            </div>

            <!-- Portfolio & Files View -->
            <div id="view-portfolio" class="view-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Student Portfolio & Work Samples</h2>
                    </div>
                    <div id="portfolio-content"></div>
                </div>
            </div>

            <!-- Alt Credits View -->
            <div id="view-alt-credits" class="view-content hidden">
                <div class="card">
                    <div class="tabs">
                        <button class="tab active" onclick="switchAltTab('generator')">Generator</button>
                        <button class="tab" onclick="switchAltTab('tracker')">Tracker</button>
                    </div>
                    <div id="alt-tab-generator" class="tab-content active">
                        <h3 class="mb-2">Alternative Credit Generator</h3>
                        <div id="alt-credit-generator"></div>
                    </div>
                    <div id="alt-tab-tracker" class="tab-content">
                        <h3 class="mb-2">Alternative Credits Tracker</h3>
                        <div id="alt-credit-tracker"></div>
                    </div>
                </div>
            </div>

            <!-- Reports View -->
            <div id="view-reports" class="view-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Reports</h2>
                    </div>
                    <div id="reports-content"></div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="view-settings" class="view-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Settings</h2>
                    </div>
                    <div id="settings-content"></div>
                </div>
            </div>

            <!-- Backup View -->
            <div id="view-backup" class="view-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Backup & Export</h2>
                    </div>
                    <div id="backup-content"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Modal</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        // ===== Data Models & State =====
        const AppState = {
            students: [],
            subjects: [],
            courses: [],
            altCredits: [],
            studentFiles: {}, // { studentId: [{ id, name, type, date, base64Data, courseId?, notes }] }
            attendance: {}, // { studentId: { 'YYYY-MM-DD': { status: 'present'|'absent'|'excused'|'holiday', notes: '' } } }
            settings: {
                schoolName: 'Homeschool Academy',
                schoolAddress: '',
                schoolContact: '',
                gradeLevelCutoff: '09-01',
                gradeScale: {
                    'A': { min: 90, max: 100, gpa: 4.0 },
                    'A-': { min: 87, max: 89, gpa: 3.7 },
                    'B+': { min: 83, max: 86, gpa: 3.3 },
                    'B': { min: 80, max: 82, gpa: 3.0 },
                    'B-': { min: 77, max: 79, gpa: 2.7 },
                    'C+': { min: 73, max: 76, gpa: 2.3 },
                    'C': { min: 70, max: 72, gpa: 2.0 },
                    'C-': { min: 67, max: 69, gpa: 1.7 },
                    'D+': { min: 63, max: 66, gpa: 1.3 },
                    'D': { min: 60, max: 62, gpa: 1.0 },
                    'F': { min: 0, max: 59, gpa: 0.0 }
                },
                defaultFullYearCredits: 1.0,
                defaultHalfYearCredits: 0.5,
                defaultQuarterCredits: 0.25,
                useMessianicTerms: true
            },
            currentView: 'dashboard'
        };

        // ===== Utility Functions =====
        
        /**
         * Calculate grade level from date of birth
         * Formula: Determine age as of September 1 of current school year
         * Age 5 = Kindergarten, Age 6 = 1st grade, ... Age 17 = 12th grade
         */
        function calculateGradeLevel(dob, cutoffDate = AppState.settings.gradeLevelCutoff) {
            if (!dob) return null;
            
            const birthDate = new Date(dob);
            const today = new Date();
            const currentYear = today.getFullYear();
            
            // Parse cutoff (format: MM-DD)
            const [cutoffMonth, cutoffDay] = cutoffDate.split('-').map(Number);
            
            // Determine school year
            let schoolYear = currentYear;
            if (today.getMonth() + 1 < cutoffMonth || 
                (today.getMonth() + 1 === cutoffMonth && today.getDate() < cutoffDay)) {
                schoolYear -= 1;
            }
            
            // Calculate age as of cutoff date
            const cutoffThisYear = new Date(schoolYear, cutoffMonth - 1, cutoffDay);
            let age = cutoffThisYear.getFullYear() - birthDate.getFullYear();
            const monthDiff = cutoffThisYear.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && cutoffThisYear.getDate() < birthDate.getDate())) {
                age--;
            }
            
            // Map age to grade: 5‚ÜíK, 6‚Üí1, 7‚Üí2, ... 17‚Üí12
            if (age === 5) return 'K';
            if (age >= 6 && age <= 17) return (age - 5).toString();
            if (age >= 18) return '12'; // Cap at 12th grade
            return 'Pre-K'; // Younger than 5
        }

        /**
         * Calculate weighted average for grades
         * Formula: sum(pointsEarned * weight) / sum(pointsPossible * weight)
         */
        function calculateWeightedAverage(items) {
            if (!items || items.length === 0) return 0;
            
            let totalWeightedPoints = 0;
            let totalPossibleWeighted = 0;
            
            items.forEach(item => {
                const weight = item.weight || 1;
                const earned = item.pointsEarned || 0;
                const possible = item.pointsPossible || 0;
                
                totalWeightedPoints += earned * weight;
                totalPossibleWeighted += possible * weight;
            });
            
            if (totalPossibleWeighted === 0) return 0;
            return (totalWeightedPoints / totalPossibleWeighted) * 100;
        }

        /**
         * Convert percentage to letter grade based on scale
         */
        function percentToLetterGrade(percent) {
            const scale = AppState.settings.gradeScale;
            for (const [letter, range] of Object.entries(scale)) {
                if (percent >= range.min && percent <= range.max) {
                    return letter;
                }
            }
            return 'F';
        }

        /**
         * Get GPA value for letter grade
         */
        function getGPAForLetter(letter) {
            return AppState.settings.gradeScale[letter]?.gpa || 0;
        }

        /**
         * Generate unique ID
         */
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        /**
         * Save state to localStorage
         */
        function saveState() {
            try {
                localStorage.setItem('homeschool-data', JSON.stringify(AppState));
                updateSaveIndicator('saved');
            } catch (e) {
                console.error('Error saving data:', e);
                alert('Error saving data. Please export your data as backup.');
            }
        }

        /**
         * Load state from localStorage
         */
        function loadState() {
            try {
                const saved = localStorage.getItem('homeschool-data');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    Object.assign(AppState, loaded);
                } else {
                    // Load seed data if no saved data
                    loadSeedData();
                }
            } catch (e) {
                console.error('Error loading data:', e);
                loadSeedData();
            }
        }

        /**
         * Update save indicator
         */
        function updateSaveIndicator(status) {
            const indicator = document.getElementById('save-indicator');
            if (status === 'saving') {
                indicator.className = 'save-indicator saving';
                indicator.textContent = '‚è≥ Saving...';
            } else {
                indicator.className = 'save-indicator saved';
                indicator.textContent = '‚úì All changes saved';
            }
        }

        /**
         * Load seed data for testing
         */
        function loadSeedData() {
            AppState.students = [
                {
                    id: 'student1',
                    firstName: 'Sarah',
                    lastName: 'Johnson',
                    dob: '2012-05-15',
                    gradeOverride: null,
                    hideGradeLevel: false
                }
            ];

            AppState.subjects = [
                { id: 'subj1', name: 'Mathematics', description: 'Math courses' },
                { id: 'subj2', name: 'Language Arts', description: 'Reading, writing, literature' }
            ];

            AppState.courses = [
                {
                    id: 'course1',
                    studentId: 'student1',
                    subjectId: 'subj1',
                    name: 'Algebra 1',
                    year: '2024-2025',
                    credits: 1.0,
                    units: [
                        {
                            id: 'unit1',
                            name: 'Linear Equations',
                            modules: [
                                {
                                    id: 'mod1',
                                    name: 'Solving Equations',
                                    lessons: [
                                        {
                                            id: 'lesson1',
                                            name: 'One-Step Equations',
                                            date: '2024-09-05',
                                            items: [
                                                { id: 'item1', name: 'Homework 1', pointsEarned: 18, pointsPossible: 20, weight: 1 },
                                                { id: 'item2', name: 'Quiz', pointsEarned: 45, pointsPossible: 50, weight: 2 }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ];

            AppState.altCredits = [];
            
            saveState();
        }

        // ===== View Management =====
        function switchView(viewName) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.view === viewName) {
                    item.classList.add('active');
                }
            });

            // Update content
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');

            AppState.currentView = viewName;

            // Render view
            switch(viewName) {
                case 'dashboard': renderDashboard(); break;
                case 'students': renderStudents(); break;
                case 'subjects': renderSubjects(); break;
                case 'courses': renderCourses(); break;
                case 'gradebook': renderGradebook(); break;
                case 'planner': renderPlanner(); break;
                case 'transcript': renderTranscriptControls(); break;
                case 'portfolio': renderPortfolio(); break;
                case 'alt-credits': renderAltCredits(); break;
                case 'reports': renderReports(); break;
                case 'settings': renderSettings(); break;
                case 'backup': renderBackup(); break;
            }
        }

        // ===== Dashboard =====
        function renderDashboard() {
            const container = document.getElementById('dashboard-content');
            const studentCount = AppState.students.length;
            const courseCount = AppState.courses.length;
            const subjectCount = AppState.subjects.length;
            const altCreditCount = AppState.altCredits.length;

            // Quick stats
            let statsHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="card" style="text-align: center; cursor: pointer;" onclick="switchView('students')">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üë®‚Äçüéì</div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${studentCount}</div>
                        <div style="color: var(--text-light);">Students</div>
                    </div>
                    <div class="card" style="text-align: center; cursor: pointer;" onclick="switchView('courses')">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìñ</div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${courseCount}</div>
                        <div style="color: var(--text-light);">Active Courses</div>
                    </div>
                    <div class="card" style="text-align: center; cursor: pointer;" onclick="switchView('subjects')">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìö</div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${subjectCount}</div>
                        <div style="color: var(--text-light);">Subjects</div>
                    </div>
                    <div class="card" style="text-align: center; cursor: pointer;" onclick="switchView('alt-credits')">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚≠ê</div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${altCreditCount}</div>
                        <div style="color: var(--text-light);">Alt Credits</div>
                    </div>
                </div>
            `;

            // Student Overview Cards
            if (studentCount > 0) {
                statsHTML += '<h3 style="margin-bottom: 1rem;">Student Overview</h3>';
                statsHTML += '<div style="display: grid; gap: 1rem; margin-bottom: 2rem;">';
                
                AppState.students.forEach(student => {
                    const studentCourses = AppState.courses.filter(c => c.studentId === student.id);
                    const gradeLevel = student.gradeOverride || calculateGradeLevel(student.dob);
                    
                    // Calculate overall GPA
                    let totalPoints = 0;
                    let totalCredits = 0;
                    let coursesWithGrades = 0;
                    
                    studentCourses.forEach(course => {
                        const avg = calculateCourseAverage(course);
                        if (avg !== null) {
                            const letter = percentToLetterGrade(avg);
                            const gpa = getGPAForLetter(letter);
                            totalPoints += gpa * course.credits;
                            totalCredits += course.credits;
                            coursesWithGrades++;
                        }
                    });
                    
                    const overallGPA = totalCredits > 0 ? (totalPoints / totalCredits).toFixed(2) : 'N/A';
                    
                    statsHTML += `
                        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <h3 style="margin: 0; color: white;">${student.firstName} ${student.lastName}</h3>
                                    <p style="margin: 0.25rem 0 0 0; opacity: 0.9;">Grade ${gradeLevel || 'N/A'}</p>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.5rem; font-weight: bold;">${overallGPA}</div>
                                    <div style="font-size: 0.875rem; opacity: 0.9;">GPA</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.2);">
                                <div>
                                    <div style="font-size: 1.25rem; font-weight: bold;">${studentCourses.length}</div>
                                    <div style="font-size: 0.75rem; opacity: 0.9;">Courses</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.25rem; font-weight: bold;">${totalCredits.toFixed(1)}</div>
                                    <div style="font-size: 0.75rem; opacity: 0.9;">Credits</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.25rem; font-weight: bold;">${coursesWithGrades}/${studentCourses.length}</div>
                                    <div style="font-size: 0.75rem; opacity: 0.9;">Graded</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                statsHTML += '</div>';
            }

            // Course Progress
            if (courseCount > 0) {
                statsHTML += '<h3 style="margin-bottom: 1rem;">Course Progress</h3>';
                statsHTML += '<div style="display: grid; gap: 1rem; margin-bottom: 2rem;">';
                
                AppState.courses.slice(0, 5).forEach(course => {
                    const student = AppState.students.find(s => s.id === course.studentId);
                    const subject = AppState.subjects.find(s => s.id === course.subjectId);
                    const average = calculateCourseAverage(course);
                    const letter = average !== null ? percentToLetterGrade(average) : 'Not Graded';
                    
                    // Count lessons
                    let totalLessons = 0;
                    let gradedLessons = 0;
                    course.units?.forEach(unit => {
                        unit.modules?.forEach(module => {
                            module.lessons?.forEach(lesson => {
                                totalLessons++;
                                if (lesson.items && lesson.items.length > 0) {
                                    gradedLessons++;
                                }
                            });
                        });
                    });
                    
                    const progress = totalLessons > 0 ? (gradedLessons / totalLessons * 100) : 0;
                    
                    statsHTML += `
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                <div>
                                    <h4 style="margin: 0;">${course.name}</h4>
                                    <p style="margin: 0.25rem 0 0 0; color: var(--text-light); font-size: 0.875rem;">
                                        ${student?.firstName} ${student?.lastName} ‚Ä¢ ${subject?.name}
                                    </p>
                                </div>
                                <span class="badge ${average !== null ? 'badge-success' : 'badge-warning'}">${letter}</span>
                            </div>
                            <div style="margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.25rem;">
                                    <span>Progress: ${gradedLessons}/${totalLessons} lessons graded</span>
                                    <span>${progress.toFixed(0)}%</span>
                                </div>
                                <div style="background: var(--bg); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: var(--secondary); height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                statsHTML += '</div>';
            }

            // Alternative Credits in Progress
            const activeAltCredits = AppState.altCredits.filter(c => c.status === 'in-progress' || c.status === 'planned');
            if (activeAltCredits.length > 0) {
                statsHTML += '<h3 style="margin-bottom: 1rem;">Alternative Credits in Progress</h3>';
                statsHTML += '<div style="display: grid; gap: 1rem; margin-bottom: 2rem;">';
                
                activeAltCredits.slice(0, 3).forEach(credit => {
                    const student = AppState.students.find(s => s.id === credit.studentId);
                    const progress = credit.hours > 0 ? (credit.hoursCompleted / credit.hours * 100) : 0;
                    
                    statsHTML += `
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                <div>
                                    <h4 style="margin: 0;">${credit.title}</h4>
                                    <p style="margin: 0.25rem 0 0 0; color: var(--text-light); font-size: 0.875rem;">
                                        ${student?.firstName} ${student?.lastName}
                                    </p>
                                </div>
                                <span class="badge badge-warning">${credit.status}</span>
                            </div>
                            <div style="margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.25rem;">
                                    <span>${credit.hoursCompleted} / ${credit.hours} hours</span>
                                    <span>${progress.toFixed(0)}%</span>
                                </div>
                                <div style="background: var(--bg); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: var(--warning); height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                statsHTML += '</div>';
            }

            // Quick Actions
            statsHTML += `
                <h3 style="margin-bottom: 1rem;">Quick Actions</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <button class="btn btn-primary" onclick="showStudentModal()" style="padding: 1rem; height: auto;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ûï</div>
                        <div>Add Student</div>
                    </button>
                    <button class="btn btn-primary" onclick="showCourseModal()" style="padding: 1rem; height: auto;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìñ</div>
                        <div>Add Course</div>
                    </button>
                    <button class="btn btn-primary" onclick="switchView('planner')" style="padding: 1rem; height: auto;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìÖ</div>
                        <div>Lesson Planner</div>
                    </button>
                    <button class="btn btn-primary" onclick="switchView('transcript')" style="padding: 1rem; height: auto;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìú</div>
                        <div>Generate Transcript</div>
                    </button>
                </div>
            `;

            // Empty state if no data
            if (studentCount === 0) {
                statsHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div class="card" style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üë®‚Äçüéì</div>
                            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${studentCount}</div>
                            <div style="color: var(--text-light);">Students</div>
                        </div>
                        <div class="card" style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìö</div>
                            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${subjectCount}</div>
                            <div style="color: var(--text-light);">Subjects</div>
                        </div>
                        <div class="card" style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìñ</div>
                            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${courseCount}</div>
                            <div style="color: var(--text-light);">Courses</div>
                        </div>
                    </div>

                    <div class="empty-state">
                        <div class="empty-state-icon">üéì</div>
                        <h3>Welcome to Homeschool Planner!</h3>
                        <p>Get started by adding your first student, then create subjects and courses.</p>
                        <div style="margin-top: 2rem;">
                            <button class="btn btn-primary" onclick="showStudentModal()">Add Your First Student</button>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = statsHTML;
        }

        // ===== Students Management =====
        function renderStudents() {
            const container = document.getElementById('students-list');
            
            if (AppState.students.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë®‚Äçüéì</div>
                        <h3>No students yet</h3>
                        <p>Add your first student to get started.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = AppState.students.map(student => {
                const gradeLevel = student.gradeOverride || calculateGradeLevel(student.dob);
                const age = student.dob ? Math.floor((new Date() - new Date(student.dob)) / 31557600000) : null;
                
                return `
                    <div class="list-item">
                        <div class="list-item-content">
                            <h3>${student.firstName} ${student.lastName}</h3>
                            <p>
                                ${gradeLevel ? `Grade: ${gradeLevel}` : 'Grade: Not set'} 
                                ${age !== null ? `| Age: ${age}` : ''}
                                ${student.dob ? `| DOB: ${student.dob}` : ''}
                            </p>
                        </div>
                        <div class="list-item-actions">
                            <button class="btn btn-sm btn-outline" onclick="editStudent('${student.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteStudent('${student.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showStudentModal(studentId = null) {
            const student = studentId ? AppState.students.find(s => s.id === studentId) : null;
            const isEdit = !!student;

            document.getElementById('modal-title').textContent = isEdit ? 'Edit Student' : 'Add Student';
            document.getElementById('modal-body').innerHTML = `
                <form id="student-form" onsubmit="saveStudent(event, '${studentId || ''}')">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">First Name *</label>
                            <input type="text" class="form-input" name="firstName" value="${student?.firstName || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name *</label>
                            <input type="text" class="form-input" name="lastName" value="${student?.lastName || ''}" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" class="form-input" name="dob" value="${student?.dob || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Grade Override (optional)</label>
                            <input type="text" class="form-input" name="gradeOverride" value="${student?.gradeOverride || ''}" placeholder="e.g., 7, K, 12">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" name="hideGradeLevel" id="hideGradeLevel" ${student?.hideGradeLevel ? 'checked' : ''}>
                            <label for="hideGradeLevel">Hide grade level on reports and transcripts</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">${isEdit ? 'Update' : 'Add'} Student</button>
                    </div>
                </form>
            `;

            document.getElementById('modal-overlay').classList.add('active');
        }

        function saveStudent(event, studentId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const studentData = {
                id: studentId || generateId(),
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                dob: formData.get('dob'),
                gradeOverride: formData.get('gradeOverride') || null,
                hideGradeLevel: formData.get('hideGradeLevel') === 'on'
            };

            if (studentId) {
                const index = AppState.students.findIndex(s => s.id === studentId);
                AppState.students[index] = studentData;
            } else {
                AppState.students.push(studentData);
            }

            saveState();
            closeModal();
            renderStudents();
        }

        function editStudent(studentId) {
            showStudentModal(studentId);
        }

        function deleteStudent(studentId) {
            if (confirm('Are you sure you want to delete this student? This will also delete all their courses.')) {
                AppState.students = AppState.students.filter(s => s.id !== studentId);
                AppState.courses = AppState.courses.filter(c => c.studentId !== studentId);
                saveState();
                renderStudents();
            }
        }

        // ===== Subjects Management =====
        function renderSubjects() {
            const container = document.getElementById('subjects-list');
            
            if (AppState.subjects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <h3>No subjects yet</h3>
                        <p>Add subjects to organize your courses.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = AppState.subjects.map(subject => {
                const courseCount = AppState.courses.filter(c => c.subjectId === subject.id).length;
                return `
                    <div class="list-item">
                        <div class="list-item-content">
                            <h3>${subject.name}</h3>
                            <p>${subject.description || 'No description'} | ${courseCount} course(s)</p>
                        </div>
                        <div class="list-item-actions">
                            <button class="btn btn-sm btn-outline" onclick="editSubject('${subject.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSubject('${subject.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showSubjectModal(subjectId = null) {
            const subject = subjectId ? AppState.subjects.find(s => s.id === subjectId) : null;
            const isEdit = !!subject;

            document.getElementById('modal-title').textContent = isEdit ? 'Edit Subject' : 'Add Subject';
            document.getElementById('modal-body').innerHTML = `
                <form id="subject-form" onsubmit="saveSubject(event, '${subjectId || ''}')">
                    <div class="form-group">
                        <label class="form-label">Subject Name *</label>
                        <input type="text" class="form-input" name="name" value="${subject?.name || ''}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" name="description">${subject?.description || ''}</textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">${isEdit ? 'Update' : 'Add'} Subject</button>
                    </div>
                </form>
            `;

            document.getElementById('modal-overlay').classList.add('active');
        }

        function saveSubject(event, subjectId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const subjectData = {
                id: subjectId || generateId(),
                name: formData.get('name'),
                description: formData.get('description')
            };

            if (subjectId) {
                const index = AppState.subjects.findIndex(s => s.id === subjectId);
                AppState.subjects[index] = subjectData;
            } else {
                AppState.subjects.push(subjectData);
            }

            saveState();
            closeModal();
            renderSubjects();
        }

        function editSubject(subjectId) {
            showSubjectModal(subjectId);
        }

        function deleteSubject(subjectId) {
            const courseCount = AppState.courses.filter(c => c.subjectId === subjectId).length;
            if (courseCount > 0) {
                alert(`Cannot delete this subject. It has ${courseCount} course(s) associated with it.`);
                return;
            }
            if (confirm('Are you sure you want to delete this subject?')) {
                AppState.subjects = AppState.subjects.filter(s => s.id !== subjectId);
                saveState();
                renderSubjects();
            }
        }

        // ===== Courses Management =====
        function renderCourses() {
            const container = document.getElementById('courses-list');
            
            if (AppState.courses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìñ</div>
                        <h3>No courses yet</h3>
                        <p>Add courses for your students.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = AppState.courses.map(course => {
                const student = AppState.students.find(s => s.id === course.studentId);
                const subject = AppState.subjects.find(s => s.id === course.subjectId);
                const average = calculateCourseAverage(course);
                const letter = average !== null ? percentToLetterGrade(average) : 'Not Graded';
                const avgDisplay = average !== null ? `${average.toFixed(1)}%` : 'No grades yet';

                return `
                    <div class="list-item">
                        <div class="list-item-content">
                            <h3>${course.name}</h3>
                            <p>
                                ${student ? `${student.firstName} ${student.lastName}` : 'Unknown Student'} | 
                                ${subject ? subject.name : 'Unknown Subject'} | 
                                ${course.year} | 
                                ${course.credits} credit(s) | 
                                Grade: ${letter} ${average !== null ? `(${avgDisplay})` : ''}
                            </p>
                        </div>
                        <div class="list-item-actions">
                            <button class="btn btn-sm btn-outline" onclick="editCourse('${course.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCourse('${course.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function calculateCourseAverage(course) {
            const allItems = [];
            course.units?.forEach(unit => {
                unit.modules?.forEach(module => {
                    module.lessons?.forEach(lesson => {
                        if (lesson.items) {
                            allItems.push(...lesson.items);
                        }
                    });
                });
            });
            
            if (allItems.length === 0) return null; // Return null if no items
            return calculateWeightedAverage(allItems);
        }

        function showCourseModal(courseId = null) {
            const course = courseId ? AppState.courses.find(c => c.id === courseId) : null;
            const isEdit = !!course;

            const studentsOptions = AppState.students.map(s => 
                `<option value="${s.id}" ${course?.studentId === s.id ? 'selected' : ''}>${s.firstName} ${s.lastName}</option>`
            ).join('');

            const subjectsOptions = AppState.subjects.map(s => 
                `<option value="${s.id}" ${course?.subjectId === s.id ? 'selected' : ''}>${s.name}</option>`
            ).join('');

            document.getElementById('modal-title').textContent = isEdit ? 'Edit Course' : 'Add Course';
            document.getElementById('modal-body').innerHTML = `
                <form id="course-form" onsubmit="saveCourse(event, '${courseId || ''}')">
                    <div class="form-group">
                        <label class="form-label">Course Name *</label>
                        <input type="text" class="form-input" name="name" value="${course?.name || ''}" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Student *</label>
                            <select class="form-select" name="studentId" required>
                                <option value="">Select Student</option>
                                ${studentsOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subject *</label>
                            <select class="form-select" name="subjectId" required>
                                <option value="">Select Subject</option>
                                ${subjectsOptions}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Year *</label>
                            <input type="text" class="form-input" name="year" value="${course?.year || '2024-2025'}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Credits *</label>
                            <input type="number" class="form-input" name="credits" value="${course?.credits || 1.0}" step="0.25" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">${isEdit ? 'Update' : 'Add'} Course</button>
                    </div>
                </form>
            `;

            document.getElementById('modal-overlay').classList.add('active');
        }

        function saveCourse(event, courseId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const courseData = {
                id: courseId || generateId(),
                name: formData.get('name'),
                studentId: formData.get('studentId'),
                subjectId: formData.get('subjectId'),
                year: formData.get('year'),
                credits: parseFloat(formData.get('credits')),
                units: courseId ? AppState.courses.find(c => c.id === courseId).units || [] : []
            };

            if (courseId) {
                const index = AppState.courses.findIndex(c => c.id === courseId);
                AppState.courses[index] = courseData;
            } else {
                AppState.courses.push(courseData);
            }

            saveState();
            closeModal();
            renderCourses();
        }

        function editCourse(courseId) {
            showCourseModal(courseId);
        }

        function deleteCourse(courseId) {
            if (confirm('Are you sure you want to delete this course? All lessons and grades will be lost.')) {
                AppState.courses = AppState.courses.filter(c => c.id !== courseId);
                saveState();
                renderCourses();
            }
        }

        // ===== Gradebook =====
        function renderGradebook() {
            const container = document.getElementById('gradebook-content');

            if (AppState.courses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <h3>No courses for gradebook</h3>
                        <p>Add courses to start grading.</p>
                    </div>
                `;
                return;
            }

            // Group by student
            const byStudent = {};
            AppState.courses.forEach(course => {
                if (!byStudent[course.studentId]) byStudent[course.studentId] = [];
                byStudent[course.studentId].push(course);
            });

            container.innerHTML = Object.entries(byStudent).map(([studentId, courses]) => {
                const student = AppState.students.find(s => s.id === studentId);
                if (!student) return '';

                const coursesHTML = courses.map(course => {
                    const subject = AppState.subjects.find(s => s.id === course.subjectId);
                    const average = calculateCourseAverage(course);
                    const letter = average !== null ? percentToLetterGrade(average) : 'Not Graded';
                    const avgDisplay = average !== null ? average.toFixed(1) + '%' : 'No grades';

                    return `
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <div>
                                    <strong>${course.name}</strong> - ${subject?.name || 'Unknown'} 
                                    <span class="badge ${average !== null ? 'badge-success' : 'badge-warning'}">${letter}</span>
                                    <span style="color: var(--text-light); margin-left: 0.5rem;">${avgDisplay}</span>
                                </div>
                                <span>‚ñº</span>
                            </div>
                            <div class="accordion-content">
                                <button class="btn btn-sm btn-primary" style="margin-bottom: 1rem;" onclick="quickGradeEntry('${course.id}')">
                                    ‚ö° Quick Grade Entry
                                </button>
                                ${renderCourseGradebook(course)}
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="card">
                        <h3 style="margin-bottom: 1rem;">${student.firstName} ${student.lastName}</h3>
                        ${coursesHTML}
                    </div>
                `;
            }).join('');
        }

        function quickGradeEntry(courseId) {
            const course = AppState.courses.find(c => c.id === courseId);
            if (!course) return;

            // Collect all lessons that need grading
            const lessons = [];
            course.units?.forEach(unit => {
                unit.modules?.forEach(module => {
                    module.lessons?.forEach(lesson => {
                        lessons.push({
                            lesson: lesson,
                            unit: unit,
                            module: module,
                            path: `${unit.name} > ${module.name} > ${lesson.name}`
                        });
                    });
                });
            });

            if (lessons.length === 0) {
                alert('No lessons found in this course.\n\nTo add lessons:\n1. Go to Lesson Planner\n2. Find this course\n3. Add Units, Modules, and Lessons');
                return;
            }

            let formHTML = `
                <p style="margin-bottom: 1rem; padding: 1rem; background: var(--bg); border-radius: var(--radius);">
                    <strong>üìù Instructions:</strong> Fill in grades for any lessons below. Leave blank to skip.<br>
                    <strong>Score format:</strong> "85/100" or just "85" (assumes /100)
                </p>
                <div style="max-height: 60vh; overflow-y: auto;">
            `;
            
            lessons.forEach((item, index) => {
                const hasGrades = item.lesson.items && item.lesson.items.length > 0;
                formHTML += `
                    <div class="card" style="margin-bottom: 1rem; background: ${hasGrades ? '#e8f5e9' : 'var(--bg)'};">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">${item.path}</div>
                        <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.75rem;">
                            ${hasGrades ? `‚úì ${item.lesson.items.length} grade(s) already entered` : '‚¨ú No grades yet'}
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Assignment Name</label>
                                <input type="text" class="form-input" name="name_${index}" placeholder="Quiz, Test, Homework, etc.">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Score</label>
                                <input type="text" class="form-input" name="score_${index}" placeholder="85/100 or 85">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Weight</label>
                                <input type="number" class="form-input" name="weight_${index}" value="1" step="0.1" min="0.1">
                            </div>
                        </div>
                    </div>
                `;
            });

            formHTML += '</div>';

            document.getElementById('modal-title').textContent = `Quick Grade Entry (${lessons.length} lessons)`;
            document.getElementById('modal-body').innerHTML = `
                <form id="quick-grade-form" onsubmit="saveQuickGrades(event, '${courseId}', ${lessons.length})">
                    ${formHTML}
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">üíæ Save All Grades</button>
                    </div>
                </form>
            `;

            document.getElementById('modal-overlay').classList.add('active');
        }

        function saveQuickGrades(event, courseId, lessonCount) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const course = AppState.courses.find(c => c.id === courseId);
            let addedCount = 0;

            // Collect all lessons again in same order
            const lessons = [];
            course.units?.forEach(unit => {
                unit.modules?.forEach(module => {
                    module.lessons?.forEach(lesson => {
                        lessons.push({ lesson, unit, module });
                    });
                });
            });

            for (let i = 0; i < lessonCount; i++) {
                const name = formData.get(`name_${i}`);
                const scoreText = formData.get(`score_${i}`);
                const weight = parseFloat(formData.get(`weight_${i}`)) || 1;

                // Skip if no name or score
                if (!name || !scoreText || name.trim() === '' || scoreText.trim() === '') continue;

                // Parse score (format: "earned/possible" or just "earned")
                let earned, possible;
                
                if (scoreText.includes('/')) {
                    const scoreParts = scoreText.trim().split('/');
                    if (scoreParts.length !== 2) continue;
                    earned = parseFloat(scoreParts[0].trim());
                    possible = parseFloat(scoreParts[1].trim());
                } else {
                    // If just a number, assume out of 100
                    earned = parseFloat(scoreText.trim());
                    possible = 100;
                }

                if (isNaN(earned) || isNaN(possible) || possible === 0) continue;

                const lesson = lessons[i].lesson;
                if (!lesson.items) lesson.items = [];

                lesson.items.push({
                    id: generateId(),
                    name: name.trim(),
                    pointsEarned: earned,
                    pointsPossible: possible,
                    weight: weight
                });

                addedCount++;
            }

            if (addedCount > 0) {
                saveState();
                closeModal();
                alert(`Successfully added ${addedCount} grade(s)!`);
                renderGradebook();
            } else {
                alert('No valid grades were entered. Please check your input format.\n\nExamples:\n‚Ä¢ 85/100 (score out of possible)\n‚Ä¢ 95 (assumed out of 100)');
            }
        }

        function renderCourseGradebook(course) {
            const allItems = [];
            
            course.units?.forEach(unit => {
                unit.modules?.forEach(module => {
                    module.lessons?.forEach(lesson => {
                        lesson.items?.forEach(item => {
                            allItems.push({
                                ...item,
                                lessonName: lesson.name,
                                moduleName: module.name,
                                unitName: unit.name
                            });
                        });
                    });
                });
            });

            if (allItems.length === 0) {
                return '<p style="color: var(--text-light); padding: 1rem;">No graded items yet. Use the Lesson Planner to add assignments.</p>';
            }

            const rows = allItems.map(item => `
                <tr>
                    <td>${item.unitName}</td>
                    <td>${item.moduleName}</td>
                    <td>${item.lessonName}</td>
                    <td>${item.name}</td>
                    <td>
                        <input type="number" class="table-input" value="${item.pointsEarned || 0}" 
                            onchange="updateGradeItem('${course.id}', '${item.id}', 'pointsEarned', this.value)">
                    </td>
                    <td>
                        <input type="number" class="table-input" value="${item.pointsPossible || 0}"
                            onchange="updateGradeItem('${course.id}', '${item.id}', 'pointsPossible', this.value)">
                    </td>
                    <td>
                        <input type="number" class="table-input" value="${item.weight || 1}" step="0.1"
                            onchange="updateGradeItem('${course.id}', '${item.id}', 'weight', this.value)">
                    </td>
                    <td>${item.pointsPossible ? ((item.pointsEarned / item.pointsPossible) * 100).toFixed(1) : 0}%</td>
                </tr>
            `).join('');

            return `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Unit</th>
                                <th>Module</th>
                                <th>Lesson</th>
                                <th>Assignment</th>
                                <th>Earned</th>
                                <th>Possible</th>
                                <th>Weight</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function updateGradeItem(courseId, itemId, field, value) {
            const course = AppState.courses.find(c => c.id === courseId);
            if (!course) return;

            let found = false;
            course.units?.forEach(unit => {
                unit.modules?.forEach(module => {
                    module.lessons?.forEach(lesson => {
                        const item = lesson.items?.find(i => i.id === itemId);
                        if (item) {
                            item[field] = parseFloat(value);
                            found = true;
                        }
                    });
                });
            });

            if (found) {
                saveState();
                renderGradebook();
            }
        }

        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('span:last-child');
            content.classList.toggle('active');
            icon.style.transform = content.classList.contains('active') ? 'rotate(180deg)' : '';
        }

        // ===== Lesson Planner =====
        function renderPlanner() {
            const container = document.getElementById('planner-content');

            if (AppState.courses.length === 0 && AppState.altCredits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <h3>No courses or alternative credits to plan</h3>
                        <p>Add courses or alternative credits first to create lesson plans.</p>
                    </div>
                `;
                return;
            }

            // Group by student
            const byStudent = {};
            
            // Add courses
            AppState.courses.forEach(course => {
                if (!byStudent[course.studentId]) {
                    byStudent[course.studentId] = { courses: [], altCredits: [] };
                }
                byStudent[course.studentId].courses.push(course);
            });

            // Add alt credits
            AppState.altCredits.forEach(credit => {
                if (!byStudent[credit.studentId]) {
                    byStudent[credit.studentId] = { courses: [], altCredits: [] };
                }
                byStudent[credit.studentId].altCredits.push(credit);
            });

            let html = '';

            Object.entries(byStudent).forEach(([studentId, data]) => {
                const student = AppState.students.find(s => s.id === studentId);
                if (!student) return;

                html += `
                    <div class="card" style="margin-bottom: 2rem;">
                        <h2 style="margin-bottom: 1.5rem; color: var(--primary);">${student.firstName} ${student.lastName}</h2>
                `;

                // Courses section
                if (data.courses.length > 0) {
                    html += '<h3 style="margin-bottom: 1rem;">üìö Traditional Courses</h3>';
                    
                    data.courses.forEach(course => {
                        const subject = AppState.subjects.find(s => s.id === course.subjectId);
                        html += `
                            <div class="accordion-item">
                                <div class="accordion-header" onclick="toggleAccordion(this)">
                                    <div>
                                        <strong>${course.name}</strong> - ${subject?.name}
                                    </div>
                                    <span>‚ñº</span>
                                </div>
                                <div class="accordion-content">
                                    ${renderCoursePlan(course)}
                                </div>
                            </div>
                        `;
                    });
                }

                // Alternative credits section
                if (data.altCredits.length > 0) {
                    html += '<h3 style="margin-top: 2rem; margin-bottom: 1rem;">‚≠ê Alternative Credits</h3>';
                    
                    data.altCredits.forEach(credit => {
                        const progress = credit.hours > 0 ? (credit.hoursCompleted / credit.hours * 100) : 0;
                        
                        html += `
                            <div class="accordion-item">
                                <div class="accordion-header" onclick="toggleAccordion(this)">
                                    <div>
                                        <strong>${credit.title}</strong>
                                        <span class="badge ${credit.status === 'completed' ? 'badge-success' : credit.status === 'in-progress' ? 'badge-warning' : 'badge-primary'}" style="margin-left: 0.5rem;">${credit.status}</span>
                                        <span style="color: var(--text-light); margin-left: 0.5rem; font-size: 0.875rem;">
                                            ${credit.hoursCompleted}/${credit.hours} hrs (${progress.toFixed(0)}%)
                                        </span>
                                    </div>
                                    <span>‚ñº</span>
                                </div>
                                <div class="accordion-content">
                                    ${renderAltCreditPlan(credit)}
                                </div>
                            </div>
                        `;
                    });
                }

                html += '</div>';
            });

            container.innerHTML = html;
        }

        function renderAltCreditPlan(credit) {
            const progress = credit.hours > 0 ? (credit.hoursCompleted / credit.hours * 100) : 0;

            return `
                <div style="padding: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4>Alternative Credit Details</h4>
                        <button class="btn btn-sm btn-secondary" onclick="editAltCredit('${credit.id}')">Update Progress</button>
                    </div>

                    <div class="card" style="background: var(--bg); margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem;">üìã Overview</h4>
                        <p>${credit.description}</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div>
                                <strong>Status:</strong> ${credit.status}
                            </div>
                            <div>
                                <strong>Credits:</strong> ${credit.credits}
                            </div>
                            <div>
                                <strong>Date Added:</strong> ${credit.dateAdded}
                            </div>
                        </div>
                    </div>

                    <div class="card" style="background: var(--bg); margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem;">‚è±Ô∏è Time Tracking</h4>
                        <div style="margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.25rem;">
                                <span><strong>Hours Completed:</strong> ${credit.hoursCompleted} of ${credit.hours}</span>
                                <span>${progress.toFixed(1)}%</span>
                            </div>
                            <div style="background: white; height: 12px; border-radius: 6px; overflow: hidden; border: 1px solid var(--border);">
                                <div style="background: ${progress === 100 ? 'var(--secondary)' : 'var(--primary)'}; height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        ${credit.hours - credit.hoursCompleted > 0 ? `
                            <p style="margin-top: 0.5rem; color: var(--text-light); font-size: 0.875rem;">
                                <strong>${(credit.hours - credit.hoursCompleted).toFixed(1)} hours remaining</strong>
                            </p>
                        ` : `
                            <p style="margin-top: 0.5rem; color: var(--secondary); font-weight: bold; font-size: 0.875rem;">
                                ‚úì Hours requirement complete!
                            </p>
                        `}
                    </div>

                    <div class="card" style="background: var(--bg); margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem;">üì∏ Evidence & Artifacts</h4>
                        <ul style="margin-left: 1.5rem;">
                            ${credit.evidence.map(e => `<li>${e}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="card" style="background: var(--bg); margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem;">üìä Assessment Rubric</h4>
                        <ul style="margin-left: 1.5rem;">
                            ${credit.rubric.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="card" style="background: var(--bg); margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem;">üéØ Standards Alignment</h4>
                        <p>${credit.standards}</p>
                    </div>

                    ${credit.messianicNotes ? `
                        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 0.5rem; color: white;">‚ú°Ô∏è Messianic/Torah-Observant Perspective</h4>
                            <p style="margin: 0;">${credit.messianicNotes}</p>
                        </div>
                    ` : ''}

                    ${credit.notes ? `
                        <div class="card" style="background: var(--bg);">
                            <h4 style="margin-bottom: 0.5rem;">üìù Notes</h4>
                            <p style="margin: 0;">${credit.notes}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderCoursePlan(course) {
            return `
                <div style="margin: 1rem 0;">
                    <button class="btn btn-sm btn-primary" onclick="addUnit('${course.id}')">+ Add Unit</button>
                </div>
                ${course.units?.map(unit => renderUnit(course.id, unit)).join('') || '<p style="color: var(--text-light);">No units yet.</p>'}
            `;
        }

        function renderUnit(courseId, unit) {
            return `
                <div class="card" style="margin: 1rem 0; background: var(--bg);">
                    <div class="flex-between mb-1">
                        <h4>üìò ${unit.name}</h4>
                        <div class="flex gap-1">
                            <button class="btn btn-sm btn-outline" onclick="editUnit('${courseId}', '${unit.id}')">Edit</button>
                            <button class="btn btn-sm btn-secondary" onclick="addModule('${courseId}', '${unit.id}')">+ Module</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUnit('${courseId}', '${unit.id}')">Delete</button>
                        </div>
                    </div>
                    <div class="nested-item">
                        ${unit.modules?.map(module => renderModule(courseId, unit.id, module)).join('') || '<p style="color: var(--text-light); font-size: 0.875rem;">No modules yet.</p>'}
                    </div>
                </div>
            `;
        }

        function renderModule(courseId, unitId, module) {
            return `
                <div class="card" style="margin: 0.5rem 0;">
                    <div class="flex-between mb-1">
                        <h5>üìë ${module.name}</h5>
                        <div class="flex gap-1">
                            <button class="btn btn-sm btn-outline" onclick="editModule('${courseId}', '${unitId}', '${module.id}')">Edit</button>
                            <button class="btn btn-sm btn-secondary" onclick="addLesson('${courseId}', '${unitId}', '${module.id}')">+ Lesson</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteModule('${courseId}', '${unitId}', '${module.id}')">Delete</button>
                        </div>
                    </div>
                    <div class="nested-item">
                        ${module.lessons?.map(lesson => renderLesson(courseId, unitId, module.id, lesson)).join('') || '<p style="color: var(--text-light); font-size: 0.875rem;">No lessons yet.</p>'}
                    </div>
                </div>
            `;
        }

        function renderLesson(courseId, unitId, moduleId, lesson) {
            const average = lesson.items ? calculateWeightedAverage(lesson.items) : null;
            const letter = average !== null ? percentToLetterGrade(average) : 'Not Graded';
            
            const itemsHTML = lesson.items && lesson.items.length > 0 ? `
                <div class="nested-item" style="margin-top: 0.5rem;">
                    ${lesson.items.map(item => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--bg); border-radius: 4px; margin-bottom: 0.25rem; font-size: 0.875rem;">
                            <div>
                                <strong>${item.name}</strong>: ${item.pointsEarned}/${item.pointsPossible} pts (weight: ${item.weight})
                                <span style="color: var(--text-light); margin-left: 0.5rem;">
                                    ${item.pointsPossible ? ((item.pointsEarned / item.pointsPossible) * 100).toFixed(1) : 0}%
                                </span>
                            </div>
                            <div style="display: flex; gap: 0.25rem;">
                                <button class="btn btn-sm btn-outline" onclick="editGradeItem('${courseId}', '${unitId}', '${moduleId}', '${lesson.id}', '${item.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteGradeItem('${courseId}', '${unitId}', '${moduleId}', '${lesson.id}', '${item.id}')">Del</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '';
            
            return `
                <div class="list-item" style="margin: 0.5rem 0; padding: 0.75rem; display: block;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="list-item-content">
                            <h6 style="margin: 0;">üìù ${lesson.name} ${lesson.date ? `- ${lesson.date}` : ''}</h6>
                            ${lesson.items && lesson.items.length > 0 ? `<p style="margin: 0.25rem 0 0 0; font-size: 0.875rem;">Grade: ${letter} ${average !== null ? `(${average.toFixed(1)}%)` : ''} - ${lesson.items.length} item(s)</p>` : '<p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--text-light);">No grades yet</p>'}
                        </div>
                        <div class="list-item-actions">
                            <button class="btn btn-sm btn-outline" onclick="editLesson('${courseId}', '${unitId}', '${moduleId}', '${lesson.id}')">Edit</button>
                            <button class="btn btn-sm btn-secondary" onclick="addGradeItem('${courseId}', '${unitId}', '${moduleId}', '${lesson.id}')">+ Grade</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteLesson('${courseId}', '${unitId}', '${moduleId}', '${lesson.id}')">Delete</button>
                        </div>
                    </div>
                    ${itemsHTML}
                </div>
            `;
        }

        // Unit CRUD
        function addUnit(courseId) {
            const name = prompt('Enter unit name:');
            if (!name) return;

            const course = AppState.courses.find(c => c.id === courseId);
            if (!course.units) course.units = [];
            
            course.units.push({
                id: generateId(),
                name: name,
                modules: []
            });

            saveState();
            renderPlanner();
        }

        function editUnit(courseId, unitId) {
            const course = AppState.courses.find(c => c.id === courseId);
            const unit = course.units.find(u => u.id === unitId);
            const newName = prompt('Edit unit name:', unit.name);
            if (newName) {
                unit.name = newName;
                saveState();
                renderPlanner();
            }
        }

        function deleteUnit(courseId, unitId) {
            if (confirm('Delete this unit and all its contents?')) {
                const course = AppState.courses.find(c => c.id === courseId);
                course.units = course.units.filter(u => u.id !== unitId);
                saveState();
                renderPlanner();
            }
        }

        // Module CRUD
        function addModule(courseId, unitId) {
            const name = prompt('Enter module name:');
            if (!name) return;

            const course = AppState.courses.find(c => c.id === courseId);
            const unit = course.units.find(u => u.id === unitId);
            if (!unit.modules) unit.modules = [];
            
            unit.modules.push({
                id: generateId(),
                name: name,
                lessons: []
            });

            saveState();
            renderPlanner();
        }

        function editModule(courseId, unitId, moduleId) {
            const course = AppState.courses.find(c => c.id === courseId);
            const unit = course.units.find(u => u.id === unitId);
            const module = unit.modules.find(m => m.id === moduleId);
            const newName = prompt('Edit module name:', module.name);
            if (newName) {
                module.name = newName;
                saveState();
                renderPlanner();
            }
        }

        function deleteModule(courseId, unitId, moduleId) {
            if (confirm('Delete this module and all its lessons?')) {
                const course = AppState.courses.find(c => c.id === courseId);
                const unit = course.units.find(u => u.id === unitId);
                unit.modules = unit.modules.filter(m => m.id !== moduleId);
                saveState();
                renderPlanner();
            }
        }

        // Lesson CRUD
        function addLesson(courseId, unitId, moduleId) {
            const name = prompt('Enter lesson name:');
            if (!name) return;

            const course = AppState.courses.find(c => c.id === courseId);
            const unit = course.units.find(u => u.id === unitId);
            const module = unit.modules.find(m => m.id === moduleId);
            if (!module.lessons) module.lessons = [];
            
            module.lessons.push({
                id: generateId(),
                name: name,
                date: new Date().toISOString().split('T')[0],
                items: []
            });

            saveState();
            renderPlanner();
        }

        function editLesson(courseId, unitId, moduleId, lessonId) {
            const course = AppState.courses.find(c => c.id === courseId);
            const unit = course.units.find(u => u.id === unitId);
            const module = unit.modules.find(m => m.id === moduleId);
            const lesson = module.lessons.find(l => l.id === lessonId);
            const newName = prompt('Edit lesson name:', lesson.name);
            if (newName) {
                lesson.name = newName;
                saveState();
                renderPlanner();
            }
        }

        function deleteLesson(courseId, unitId, moduleId, lessonId) {
            if (confirm('Delete this lesson and all its grades?')) {
                const course = AppState.courses.find(c => c.id === courseId);
                const unit = course.units.find(u => u.id === unitId);
                const module = unit.modules.find(m => m.id === moduleId);
                module.lessons = module.lessons.filter(l => l.id !== lessonId);
                saveState();
                renderPlanner();
            }
        }

        // Grade Item
        function addGradeItem(courseId, unitId, moduleId, lessonId) {
            const name = prompt('Enter assignment name:');
            if (!name) return;
            const possible = prompt('Points possible:', '100');
            if (!possible) return;

            const course = AppState.courses.find(c => c.id === courseId);
            const unit = course.units.find(u => u.id === unitId);
            const module = unit.modules.find(m => m.id === moduleId);
            const lesson = module.lessons.find(l => l.id === lessonId);
            if (!lesson.items) lesson.items = [];
            
            lesson.items.push({
                id: generateId(),
                name: name,
                pointsEarned: 0,
                pointsPossible: parseFloat(possible),
                weight: 1
            });

            saveState();
            renderPlanner();
        }

        function editGradeItem(courseId, unitId, moduleId, lessonId, itemId) {
            const course = AppState.courses.find(c => c.id === courseId);
            const unit = course.units.find(u => u.id === unitId);
            const module = unit.modules.find(m => m.id === moduleId);
            const lesson = module.lessons.find(l => l.id === lessonId);
            const item = lesson.items.find(i => i.id === itemId);

            document.getElementById('modal-title').textContent = 'Edit Grade Item';
            document.getElementById('modal-body').innerHTML = `
                <form id="grade-item-form" onsubmit="saveGradeItemEdit(event, '${courseId}', '${unitId}', '${moduleId}', '${lessonId}', '${itemId}')">
                    <div class="form-group">
                        <label class="form-label">Assignment Name *</label>
                        <input type="text" class="form-input" name="name" value="${item.name}" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Points Earned *</label>
                            <input type="number" class="form-input" name="pointsEarned" value="${item.pointsEarned}" step="0.5" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Points Possible *</label>
                            <input type="number" class="form-input" name="pointsPossible" value="${item.pointsPossible}" step="0.5" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Weight *</label>
                        <input type="number" class="form-input" name="weight" value="${item.weight}" step="0.1" required>
                        <small style="color: var(--text-light);">Higher weight = more impact on grade (1.0 is standard)</small>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            `;

            document.getElementById('modal-overlay').classList.add('active');
        }

        function saveGradeItemEdit(event, courseId, unitId, moduleId, lessonId, itemId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const course = AppState.courses.find(c => c.id === courseId);
            const unit = course.units.find(u => u.id === unitId);
            const module = unit.modules.find(m => m.id === moduleId);
            const lesson = module.lessons.find(l => l.id === lessonId);
            const item = lesson.items.find(i => i.id === itemId);

            item.name = formData.get('name');
            item.pointsEarned = parseFloat(formData.get('pointsEarned'));
            item.pointsPossible = parseFloat(formData.get('pointsPossible'));
            item.weight = parseFloat(formData.get('weight'));

            saveState();
            closeModal();
            renderPlanner();
        }

        function deleteGradeItem(courseId, unitId, moduleId, lessonId, itemId) {
            if (confirm('Delete this grade item?')) {
                const course = AppState.courses.find(c => c.id === courseId);
                const unit = course.units.find(u => u.id === unitId);
                const module = unit.modules.find(m => m.id === moduleId);
                const lesson = module.lessons.find(l => l.id === lessonId);
                lesson.items = lesson.items.filter(i => i.id !== itemId);
                
                saveState();
                renderPlanner();
            }
        }

        // ===== Portfolio & Student Files =====
        function renderPortfolio() {
            const container = document.getElementById('portfolio-content');

            if (AppState.students.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÅ</div>
                        <h3>No students yet</h3>
                        <p>Add students first to manage their portfolios.</p>
                    </div>
                `;
                return;
            }

            const studentsOptions = AppState.students.map(s => 
                `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`
            ).join('');

            container.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Select Student</label>
                    <select class="form-select" id="portfolio-student" onchange="loadStudentPortfolio(this.value)">
                        <option value="">Choose a student</option>
                        ${studentsOptions}
                    </select>
                </div>
                <div id="student-portfolio-content"></div>
            `;
        }

        function loadStudentPortfolio(studentId) {
            if (!studentId) {
                document.getElementById('student-portfolio-content').innerHTML = '';
                return;
            }

            const student = AppState.students.find(s => s.id === studentId);
            const files = AppState.studentFiles[studentId] || [];
            const courses = AppState.courses.filter(c => c.studentId === studentId);

            let html = `
                <div class="card" style="margin-top: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3>${student.firstName} ${student.lastName}'s Portfolio</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="uploadStudentFile('${studentId}')">üì§ Upload File</button>
                            <button class="btn btn-secondary" onclick="importCurriculum('${studentId}')">üì• Import Curriculum</button>
                            <button class="btn btn-secondary" onclick="generatePortfolio('${studentId}')">üìã Generate Portfolio</button>
                        </div>
                    </div>

                    <div class="tabs">
                        <button class="tab active" onclick="switchPortfolioTab('files')">All Files</button>
                        <button class="tab" onclick="switchPortfolioTab('by-course')">By Course</button>
                        <button class="tab" onclick="switchPortfolioTab('curriculum')">Imported Curriculum</button>
                    </div>

                    <div id="portfolio-tab-files" class="tab-content active">
                        ${renderStudentFiles(studentId, files)}
                    </div>

                    <div id="portfolio-tab-by-course" class="tab-content">
                        ${renderFilesByCourse(studentId, files, courses)}
                    </div>

                    <div id="portfolio-tab-curriculum" class="tab-content">
                        ${renderImportedCurriculum(studentId)}
                    </div>
                </div>
            `;

            document.getElementById('student-portfolio-content').innerHTML = html;
        }

        function switchPortfolioTab(tab) {
            document.querySelectorAll('#student-portfolio-content .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#student-portfolio-content .tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`portfolio-tab-${tab}`).classList.add('active');
        }

        function renderStudentFiles(studentId, files) {
            if (files.length === 0) {
                return `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <h3>No files uploaded yet</h3>
                        <p>Upload work samples, completed assignments, or other documentation.</p>
                    </div>
                `;
            }

            return `
                <div style="margin-top: 1rem;">
                    ${files.map(file => `
                        <div class="list-item" style="display: block;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div>
                                    <h4 style="margin: 0;">üìé ${file.name}</h4>
                                    <p style="margin: 0.25rem 0 0 0; color: var(--text-light); font-size: 0.875rem;">
                                        Uploaded: ${file.date} ${file.courseId ? `| Course: ${getCourseNameById(file.courseId)}` : ''}
                                    </p>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm btn-outline" onclick="viewFile('${file.id}', '${studentId}')">View</button>
                                    <button class="btn btn-sm btn-outline" onclick="editFileInfo('${file.id}', '${studentId}')">Edit Info</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteFile('${file.id}', '${studentId}')">Delete</button>
                                </div>
                            </div>
                            ${file.notes ? `<p style="margin: 0.5rem 0 0 1rem; font-size: 0.875rem; color: var(--text-light);">Notes: ${file.notes}</p>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderFilesByCourse(studentId, files, courses) {
            const unassigned = files.filter(f => !f.courseId);
            const byCourse = {};
            
            files.filter(f => f.courseId).forEach(file => {
                if (!byCourse[file.courseId]) byCourse[file.courseId] = [];
                byCourse[file.courseId].push(file);
            });

            let html = '';

            courses.forEach(course => {
                const courseFiles = byCourse[course.id] || [];
                html += `
                    <div class="card" style="margin-top: 1rem; background: var(--bg);">
                        <h4>${course.name}</h4>
                        ${courseFiles.length > 0 ? `
                            <div style="margin-top: 0.5rem;">
                                ${courseFiles.map(file => `
                                    <div style="padding: 0.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                                        <span>üìé ${file.name}</span>
                                        <div style="display: flex; gap: 0.25rem;">
                                            <button class="btn btn-sm btn-outline" onclick="viewFile('${file.id}', '${studentId}')">View</button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteFile('${file.id}', '${studentId}')">Del</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="color: var(--text-light); margin-top: 0.5rem;">No files for this course</p>'}
                    </div>
                `;
            });

            if (unassigned.length > 0) {
                html += `
                    <div class="card" style="margin-top: 1rem; background: var(--bg);">
                        <h4>Unassigned Files</h4>
                        <div style="margin-top: 0.5rem;">
                            ${unassigned.map(file => `
                                <div style="padding: 0.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                                    <span>üìé ${file.name}</span>
                                    <div style="display: flex; gap: 0.25rem;">
                                        <button class="btn btn-sm btn-outline" onclick="viewFile('${file.id}', '${studentId}')">View</button>
                                        <button class="btn btn-sm btn-outline" onclick="editFileInfo('${file.id}', '${studentId}')">Assign</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteFile('${file.id}', '${studentId}')">Del</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            return html || '<p style="color: var(--text-light); margin-top: 1rem;">No files uploaded yet.</p>';
        }

        function renderImportedCurriculum(studentId) {
            // Check for imported curriculum courses
            const importedCourses = AppState.courses.filter(c => c.studentId === studentId && c.imported);
            
            if (importedCourses.length === 0) {
                return `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <h3>No curriculum imported</h3>
                        <p>Import a curriculum outline to track progress and auto-add to transcript.</p>
                        <button class="btn btn-primary" onclick="importCurriculum('${studentId}')" style="margin-top: 1rem;">üì• Import Curriculum</button>
                    </div>
                `;
            }

            return `
                <div style="margin-top: 1rem;">
                    ${importedCourses.map(course => {
                        const subject = AppState.subjects.find(s => s.id === course.subjectId);
                        let completedLessons = 0;
                        let totalLessons = 0;

                        course.units?.forEach(unit => {
                            unit.modules?.forEach(module => {
                                module.lessons?.forEach(lesson => {
                                    totalLessons++;
                                    if (lesson.completed) completedLessons++;
                                });
                            });
                        });

                        const progress = totalLessons > 0 ? (completedLessons / totalLessons * 100) : 0;

                        return `
                            <div class="card" style="margin-bottom: 1rem; background: var(--bg);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                    <div>
                                        <h4 style="margin: 0;">${course.name}</h4>
                                        <p style="margin: 0.25rem 0 0 0; color: var(--text-light); font-size: 0.875rem;">
                                            ${subject?.name} | ${course.units?.length || 0} units | ${completedLessons}/${totalLessons} lessons completed
                                        </p>
                                    </div>
                                    <span class="badge ${progress === 100 ? 'badge-success' : 'badge-warning'}">
                                        ${progress.toFixed(0)}%
                                    </span>
                                </div>
                                
                                <!-- Show curriculum structure -->
                                <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem; background: white; padding: 0.75rem; border-radius: var(--radius);">
                                    ${course.units?.map(unit => `
                                        <div style="margin-bottom: 1rem;">
                                            <strong>üìò ${unit.name}</strong>
                                            ${unit.modules?.map(module => `
                                                <div style="margin-left: 1rem; margin-top: 0.5rem;">
                                                    <strong style="font-size: 0.9em;">üìë ${module.name}</strong>
                                                    <div style="margin-left: 1rem; margin-top: 0.25rem;">
                                                        ${module.lessons?.map(lesson => `
                                                            <div style="font-size: 0.85em; color: var(--text-light); padding: 0.25rem 0;">
                                                                ${lesson.completed ? '‚úÖ' : '‚¨ú'} ${lesson.name}
                                                            </div>
                                                        `).join('') || '<em style="font-size: 0.85em; color: var(--text-light);">No lessons</em>'}
                                                    </div>
                                                </div>
                                            `).join('') || '<em style="font-size: 0.85em; color: var(--text-light); margin-left: 1rem;">No modules</em>'}
                                        </div>
                                    `).join('') || '<em style="color: var(--text-light);">No units found</em>'}
                                </div>
                                
                                <div style="margin-bottom: 1rem;">
                                    <div style="background: white; height: 10px; border-radius: 5px; overflow: hidden; border: 1px solid var(--border);">
                                        <div style="background: ${progress === 100 ? 'var(--secondary)' : 'var(--primary)'}; height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm btn-primary" onclick="viewCurriculumProgress('${course.id}')">Track Progress</button>
                                    <button class="btn btn-sm btn-outline" onclick="switchView('planner')">View in Planner</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function uploadStudentFile(studentId) {
            const student = AppState.students.find(s => s.id === studentId);
            const courses = AppState.courses.filter(c => c.studentId === studentId);
            const coursesOptions = courses.map(c => 
                `<option value="${c.id}">${c.name}</option>`
            ).join('');

            document.getElementById('modal-title').textContent = 'Upload Student Work';
            document.getElementById('modal-body').innerHTML = `
                <form id="upload-file-form" onsubmit="saveUploadedFile(event, '${studentId}')">
                    <div class="form-group">
                        <label class="form-label">Select PDF File *</label>
                        <input type="file" class="form-input" name="file" accept="application/pdf" required>
                        <small style="color: var(--text-light);">PDF files only. File will be stored in browser storage.</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">File Name/Description</label>
                        <input type="text" class="form-input" name="fileName" placeholder="e.g., Math Test Unit 3, Science Lab Report">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Associate with Course (optional)</label>
                        <select class="form-select" name="courseId">
                            <option value="">None / General</option>
                            ${coursesOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Additional notes about this work..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Upload File</button>
                    </div>
                </form>
            `;

            document.getElementById('modal-overlay').classList.add('active');
        }

        function saveUploadedFile(event, studentId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const fileInput = form.querySelector('input[type="file"]');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file');
                return;
            }

            if (file.type !== 'application/pdf') {
                alert('Only PDF files are supported');
                return;
            }

            // Check file size (limit to 5MB for localStorage)
            if (file.size > 5 * 1024 * 1024) {
                alert('File is too large. Maximum size is 5MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result;

                if (!AppState.studentFiles[studentId]) {
                    AppState.studentFiles[studentId] = [];
                }

                const fileData = {
                    id: generateId(),
                    name: formData.get('fileName') || file.name,
                    originalName: file.name,
                    type: file.type,
                    date: new Date().toISOString().split('T')[0],
                    base64Data: base64Data,
                    courseId: formData.get('courseId') || null,
                    notes: formData.get('notes') || ''
                };

                AppState.studentFiles[studentId].push(fileData);
                saveState();
                closeModal();
                loadStudentPortfolio(studentId);
                alert('File uploaded successfully!');
            };

            reader.onerror = function() {
                alert('Error reading file. Please try again.');
            };

            reader.readAsDataURL(file);
        }

        function viewFile(fileId, studentId) {
            const files = AppState.studentFiles[studentId] || [];
            const file = files.find(f => f.id === fileId);
            
            if (!file) {
                alert('File not found');
                return;
            }

            // Open PDF in new window
            const newWindow = window.open();
            newWindow.document.write(`
                <html>
                <head><title>${file.name}</title></head>
                <body style="margin:0">
                    <embed src="${file.base64Data}" type="application/pdf" width="100%" height="100%">
                </body>
                </html>
            `);
        }

        function editFileInfo(fileId, studentId) {
            const files = AppState.studentFiles[studentId] || [];
            const file = files.find(f => f.id === fileId);
            
            if (!file) return;

            const courses = AppState.courses.filter(c => c.studentId === studentId);
            const coursesOptions = courses.map(c => 
                `<option value="${c.id}" ${file.courseId === c.id ? 'selected' : ''}>${c.name}</option>`
            ).join('');

            document.getElementById('modal-title').textContent = 'Edit File Information';
            document.getElementById('modal-body').innerHTML = `
                <form id="edit-file-form" onsubmit="updateFileInfo(event, '${fileId}', '${studentId}')">
                    <div class="form-group">
                        <label class="form-label">File Name/Description</label>
                        <input type="text" class="form-input" name="fileName" value="${file.name}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Associate with Course</label>
                        <select class="form-select" name="courseId">
                            <option value="">None / General</option>
                            ${coursesOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes">${file.notes || ''}</textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update</button>
                    </div>
                </form>
            `;

            document.getElementById('modal-overlay').classList.add('active');
        }

        function updateFileInfo(event, fileId, studentId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const files = AppState.studentFiles[studentId] || [];
            const file = files.find(f => f.id === fileId);
            
            if (file) {
                file.name = formData.get('fileName');
                file.courseId = formData.get('courseId') || null;
                file.notes = formData.get('notes');
                
                saveState();
                closeModal();
                loadStudentPortfolio(studentId);
            }
        }

        function deleteFile(fileId, studentId) {
            if (confirm('Delete this file? This cannot be undone.')) {
                AppState.studentFiles[studentId] = (AppState.studentFiles[studentId] || []).filter(f => f.id !== fileId);
                saveState();
                loadStudentPortfolio(studentId);
            }
        }

        function getCourseNameById(courseId) {
            const course = AppState.courses.find(c => c.id === courseId);
            return course ? course.name : 'Unknown Course';
        }

        function importCurriculum(studentId) {
            document.getElementById('modal-title').textContent = 'Import Curriculum';
            document.getElementById('modal-body').innerHTML = `
                <p style="margin-bottom: 1rem;">Import a curriculum outline in JSON format to automatically create a course with tracking.</p>
                <form id="import-curriculum-form" onsubmit="processImportedCurriculum(event, '${studentId}')">
                    <div class="form-group">
                        <label class="form-label">Curriculum JSON File</label>
                        <input type="file" class="form-input" name="file" accept=".json" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">OR Paste JSON</label>
                        <textarea class="form-textarea" name="jsonText" rows="10" placeholder='{"name": "Course Name", "subject": "Math", "units": [...] }'></textarea>
                    </div>
                    <details style="margin: 1rem 0;">
                        <summary style="cursor: pointer; font-weight: 600;">View Expected Format</summary>
                        <pre style="background: var(--bg); padding: 1rem; border-radius: var(--radius); margin-top: 0.5rem; overflow-x: auto; font-size: 0.75rem;">{
  "name": "Algebra 1",
  "subject": "Mathematics",
  "credits": 1.0,
  "year": "2024-2025",
  "units": [
    {
      "name": "Linear Equations",
      "modules": [
        {
          "name": "One-Variable Equations",
          "lessons": [
            { "name": "Introduction", "description": "..." },
            { "name": "Practice Problems", "description": "..." }
          ]
        }
      ]
    }
  ]
}</pre>
                    </details>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Import Curriculum</button>
                    </div>
                </form>
            `;

            document.getElementById('modal-overlay').classList.add('active');
        }

        function processImportedCurriculum(event, studentId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const fileInput = form.querySelector('input[type="file"]');
            const jsonText = formData.get('jsonText');

            if (fileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const curriculumData = JSON.parse(e.target.result);
                        createCourseFromCurriculum(curriculumData, studentId);
                    } catch (error) {
                        alert('Invalid JSON file: ' + error.message);
                    }
                };
                reader.readAsText(fileInput.files[0]);
            } else if (jsonText.trim()) {
                try {
                    const curriculumData = JSON.parse(jsonText);
                    createCourseFromCurriculum(curriculumData, studentId);
                } catch (error) {
                    alert('Invalid JSON: ' + error.message);
                }
            } else {
                alert('Please provide a file or paste JSON');
            }
        }

        function createCourseFromCurriculum(data, studentId) {
            // Find or create subject
            let subject = AppState.subjects.find(s => s.name.toLowerCase() === data.subject.toLowerCase());
            if (!subject) {
                subject = {
                    id: generateId(),
                    name: data.subject,
                    description: 'Imported subject'
                };
                AppState.subjects.push(subject);
            }

            // Create course
            const course = {
                id: generateId(),
                studentId: studentId,
                subjectId: subject.id,
                name: data.name,
                year: data.year || '2024-2025',
                credits: data.credits || 1.0,
                imported: true,
                units: []
            };

            // Process units, modules, lessons
            data.units?.forEach(unitData => {
                const unit = {
                    id: generateId(),
                    name: unitData.name,
                    modules: []
                };

                unitData.modules?.forEach(moduleData => {
                    const module = {
                        id: generateId(),
                        name: moduleData.name,
                        lessons: []
                    };

                    moduleData.lessons?.forEach(lessonData => {
                        const lesson = {
                            id: generateId(),
                            name: lessonData.name,
                            description: lessonData.description || '',
                            date: '',
                            completed: false,
                            items: []
                        };
                        module.lessons.push(lesson);
                    });

                    unit.modules.push(module);
                });

                course.units.push(unit);
            });

            AppState.courses.push(course);
            saveState();
            closeModal();
            alert(`Curriculum "${data.name}" imported successfully!`);
            loadStudentPortfolio(studentId);
        }

        function viewCurriculumProgress(courseId) {
            const course = AppState.courses.find(c => c.id === courseId);
            if (!course) return;

            let html = '<div style="padding: 1rem;">';
            
            course.units?.forEach(unit => {
                html += `<div class="card" style="margin-bottom: 1rem; background: var(--bg);">
                    <h4>${unit.name}</h4>`;
                
                unit.modules?.forEach(module => {
                    html += `<div style="margin: 1rem 0;">
                        <h5 style="margin-bottom: 0.5rem;">${module.name}</h5>`;
                    
                    module.lessons?.forEach(lesson => {
                        html += `
                            <div style="padding: 0.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" ${lesson.completed ? 'checked' : ''} 
                                        onchange="toggleLessonCompletion('${courseId}', '${unit.id}', '${module.id}', '${lesson.id}', this.checked)">
                                    <span>${lesson.name}</span>
                                </label>
                                ${lesson.completed ? '<span class="badge badge-success">‚úì Complete</span>' : ''}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                });
                
                html += '</div>';
            });
            
            html += '</div>';

            document.getElementById('modal-title').textContent = `${course.name} - Progress Tracking`;
            document.getElementById('modal-body').innerHTML = html + `
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Close</button>
                </div>
            `;

            document.getElementById('modal-overlay').classList.add('active');
        }

        function toggleLessonCompletion(courseId, unitId, moduleId, lessonId, completed) {
            const course = AppState.courses.find(c => c.id === courseId);
            const unit = course.units.find(u => u.id === unitId);
            const module = unit.modules.find(m => m.id === moduleId);
            const lesson = module.lessons.find(l => l.id === lessonId);
            
            lesson.completed = completed;
            saveState();
        }

        function generatePortfolio(studentId) {
            const student = AppState.students.find(s => s.id === studentId);
            const courses = AppState.courses.filter(c => c.studentId === studentId);
            const files = AppState.studentFiles[studentId] || [];
            const gradeLevel = student.gradeOverride || calculateGradeLevel(student.dob);

            // Calculate GPA
            let totalPoints = 0;
            let totalCredits = 0;
            courses.forEach(course => {
                const avg = calculateCourseAverage(course);
                if (avg !== null) {
                    const letter = percentToLetterGrade(avg);
                    const gpa = getGPAForLetter(letter);
                    totalPoints += gpa * course.credits;
                    totalCredits += course.credits;
                }
            });
            const cumulativeGPA = totalCredits > 0 ? (totalPoints / totalCredits).toFixed(2) : 'N/A';

            let portfolioHTML = `
                <div class="print-page">
                    <div class="print-header">
                        <h1>${AppState.settings.schoolName}</h1>
                        <h2>Student Portfolio</h2>
                        ${AppState.settings.schoolAddress ? `<p>${AppState.settings.schoolAddress}</p>` : ''}
                        <p>Generated: ${new Date().toLocaleDateString()}</p>
                    </div>

                    <div class="print-section">
                        <h2>Student Information</h2>
                        <p><strong>Name:</strong> ${student.firstName} ${student.lastName}</p>
                        ${student.dob ? `<p><strong>Date of Birth:</strong> ${student.dob}</p>` : ''}
                        ${gradeLevel ? `<p><strong>Grade Level:</strong> ${gradeLevel}</p>` : ''}
                        <p><strong>GPA:</strong> ${cumulativeGPA} (4.0 scale)</p>
                        <p><strong>Total Credits:</strong> ${totalCredits.toFixed(2)}</p>
                    </div>

                    <div class="print-section">
                        <h2>Course Summary</h2>
                        ${courses.map(course => {
                            const subject = AppState.subjects.find(s => s.id === course.subjectId);
                            const avg = calculateCourseAverage(course);
                            const letter = avg !== null ? percentToLetterGrade(avg) : 'Not Graded';
                            
                            return `
                                <div style="margin: 1rem 0;">
                                    <strong>${course.name}</strong> (${subject?.name}) - ${course.year}<br>
                                    Credits: ${course.credits} | Grade: ${letter}
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div class="print-section">
                        <h2>Work Samples & Documentation</h2>
                        <p>This portfolio includes ${files.length} work sample(s):</p>
                        <ul>
                            ${files.map(file => `
                                <li>${file.name} (${file.date})${file.courseId ? ` - ${getCourseNameById(file.courseId)}` : ''}</li>
                            `).join('')}
                        </ul>
                        <p style="margin-top: 1rem; color: var(--text-light);">
                            <em>Note: Actual PDF files are stored separately and can be provided upon request.</em>
                        </p>
                    </div>
                </div>
            `;

            document.getElementById('modal-title').textContent = 'Student Portfolio';
            document.getElementById('modal-body').innerHTML = portfolioHTML + `
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Close</button>
                    <button type="button" class="btn btn-primary" onclick="window.print()">Print Portfolio</button>
                </div>
            `;

            document.getElementById('modal-overlay').classList.add('active');
        }

        // ===== Transcript Generator =====
        function renderTranscriptControls() {
            const container = document.getElementById('transcript-controls');

            const studentsOptions = AppState.students.map(s => 
                `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`
            ).join('');

            container.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Select Student</label>
                        <select class="form-select" id="transcript-student" onchange="generateTranscript()">
                            <option value="">Choose a student</option>
                            ${studentsOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Year Range</label>
                        <select class="form-select" id="transcript-year" onchange="generateTranscript()">
                            <option value="all">All Years</option>
                            <option value="2024-2025">2024-2025</option>
                            <option value="2025-2026">2025-2026</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Detail Level</label>
                        <select class="form-select" id="transcript-detail" onchange="generateTranscript()">
                            <option value="minimal">Minimal (Course + Grade)</option>
                            <option value="medium">Medium (+ Units/Modules)</option>
                            <option value="full">Full (+ Lessons)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="transcript-dob" onchange="generateTranscript()">
                            <label for="transcript-dob">Show Date of Birth</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="transcript-grade" checked onchange="generateTranscript()">
                            <label for="transcript-grade">Show Grade Level</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="transcript-gpa" checked onchange="generateTranscript()">
                            <label for="transcript-gpa">Show GPA</label>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print Transcript</button>
            `;
        }

        function generateTranscript() {
            const studentId = document.getElementById('transcript-student')?.value;
            if (!studentId) {
                document.getElementById('transcript-content').innerHTML = '';
                return;
            }

            const student = AppState.students.find(s => s.id === studentId);
            const yearFilter = document.getElementById('transcript-year')?.value;
            const detailLevel = document.getElementById('transcript-detail')?.value;
            const showDOB = document.getElementById('transcript-dob')?.checked;
            const showGrade = document.getElementById('transcript-grade')?.checked && !student.hideGradeLevel;
            const showGPA = document.getElementById('transcript-gpa')?.checked;

            let courses = AppState.courses.filter(c => c.studentId === studentId);
            if (yearFilter !== 'all') {
                courses = courses.filter(c => c.year === yearFilter);
            }

            const gradeLevel = student.gradeOverride || calculateGradeLevel(student.dob);

            // Group by year and subject
            const byYear = {};
            courses.forEach(course => {
                if (!byYear[course.year]) byYear[course.year] = {};
                const subject = AppState.subjects.find(s => s.id === course.subjectId);
                const subjectName = subject?.name || 'Other';
                if (!byYear[course.year][subjectName]) byYear[course.year][subjectName] = [];
                byYear[course.year][subjectName].push(course);
            });

            // Calculate GPA
            let totalPoints = 0;
            let totalCredits = 0;
            courses.forEach(course => {
                const avg = calculateCourseAverage(course);
                const letter = percentToLetterGrade(avg);
                const gpa = getGPAForLetter(letter);
                totalPoints += gpa * course.credits;
                totalCredits += course.credits;
            });
            const cumulativeGPA = totalCredits > 0 ? (totalPoints / totalCredits).toFixed(2) : '0.00';

            let transcriptHTML = `
                <div class="print-page">
                    <div class="print-header">
                        <h1>${AppState.settings.schoolName}</h1>
                        ${AppState.settings.schoolAddress ? `<p>${AppState.settings.schoolAddress}</p>` : ''}
                        ${AppState.settings.schoolContact ? `<p>${AppState.settings.schoolContact}</p>` : ''}
                    </div>

                    <div class="print-section">
                        <h2>Student Information</h2>
                        <p><strong>Name:</strong> ${student.firstName} ${student.lastName}</p>
                        ${showDOB && student.dob ? `<p><strong>Date of Birth:</strong> ${student.dob}</p>` : ''}
                        ${showGrade && gradeLevel ? `<p><strong>Grade Level:</strong> ${gradeLevel}</p>` : ''}
                    </div>

                    <div class="print-section">
                        <h2>Academic Record</h2>
            `;

            Object.entries(byYear).forEach(([year, subjects]) => {
                transcriptHTML += `<h3 style="margin-top: 1.5rem;">${year}</h3>`;
                
                Object.entries(subjects).forEach(([subjectName, subjectCourses]) => {
                    transcriptHTML += `<h4 style="margin-top: 1rem;">${subjectName}</h4>`;
                    
                    subjectCourses.forEach(course => {
                        const avg = calculateCourseAverage(course);
                        const letter = percentToLetterGrade(avg);
                        
                        transcriptHTML += `
                            <div style="margin: 0.75rem 0; padding: 0.5rem; border-left: 3px solid var(--primary);">
                                <div style="display: flex; justify-content: space-between; font-weight: bold;">
                                    <span>${course.name}</span>
                                    <span>Grade: ${letter} | Credits: ${course.credits}</span>
                                </div>
                        `;

                        if (detailLevel === 'medium' || detailLevel === 'full') {
                            course.units?.forEach(unit => {
                                transcriptHTML += `<div style="margin-left: 1rem; margin-top: 0.5rem; font-size: 0.9em;">‚Ä¢ ${unit.name}`;
                                
                                if (detailLevel === 'full') {
                                    unit.modules?.forEach(module => {
                                        transcriptHTML += `<div style="margin-left: 1rem;">- ${module.name}`;
                                        
                                        module.lessons?.forEach(lesson => {
                                            transcriptHTML += `<div style="margin-left: 1rem; color: var(--text-light); font-size: 0.95em;">¬∑ ${lesson.name}</div>`;
                                        });
                                        
                                        transcriptHTML += `</div>`;
                                    });
                                }
                                
                                transcriptHTML += `</div>`;
                            });
                        }

                        transcriptHTML += `</div>`;
                    });
                });
            });

            transcriptHTML += `</div>`;

            if (showGPA) {
                transcriptHTML += `
                    <div class="print-section">
                        <h2>Grade Point Average</h2>
                        <p><strong>Cumulative GPA:</strong> ${cumulativeGPA} (4.0 scale)</p>
                        <p><strong>Total Credits Earned:</strong> ${totalCredits.toFixed(2)}</p>
                    </div>
                `;
            }

            transcriptHTML += `
                    <div class="print-section" style="margin-top: 3rem;">
                        <div class="signature-line">
                            <p>Signature: _______________________________</p>
                            <p>Date: ${new Date().toLocaleDateString()}</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('transcript-content').innerHTML = transcriptHTML;
        }

        // ===== Alternative Credits =====
        function renderAltCredits() {
            renderAltCreditGenerator();
            renderAltCreditTracker();
        }

        function switchAltTab(tab) {
            document.querySelectorAll('#view-alt-credits .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#view-alt-credits .tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`alt-tab-${tab}`).classList.add('active');
        }

        function renderAltCreditGenerator() {
            const container = document.getElementById('alt-credit-generator');
            
            container.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem; border-radius: var(--radius); color: white; margin-bottom: 1.5rem;">
                    <h3 style="margin: 0 0 0.5rem 0; color: white;">Subject-Based Alternative Credit</h3>
                    <p style="margin: 0; opacity: 0.9;">Generate ways to earn credit for traditional subjects through real-life experiences and Bible study</p>
                </div>

                <form id="alt-credit-form" onsubmit="generateAltCredit(event)">
                    <div class="form-group">
                        <label class="form-label">Subject to Earn Credit For *</label>
                        <select class="form-select" name="subject" required>
                            <option value="">Select a subject</option>
                            <option value="mathematics">Mathematics</option>
                            <option value="english">English / Language Arts</option>
                            <option value="history">History / Social Studies</option>
                            <option value="science">Science</option>
                            <option value="foreign-language">Foreign Language</option>
                            <option value="fine-arts">Fine Arts</option>
                            <option value="physical-education">Physical Education</option>
                            <option value="life-skills">Life Skills / Electives</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Learning Approach</label>
                        <select class="form-select" name="approach" onchange="toggleBibleCredits(this.value)">
                            <option value="real-life">Real-Life Activities</option>
                            <option value="bible">Bible as Primary Textbook</option>
                            <option value="both">Both Real-Life & Bible Study</option>
                        </select>
                    </div>

                    <div class="form-group" id="messianic-option" style="display: none;">
                        <div class="checkbox-group">
                            <input type="checkbox" name="messianicPerspective" id="messianicPerspective2">
                            <label for="messianicPerspective2">Use Messianic/Torah-observant perspective (Yehovah, Y'eshua)</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Student Interest or Focus (optional)</label>
                        <input type="text" class="form-input" name="interest" placeholder="e.g., cooking, gardening, woodworking, animals">
                        <small style="color: var(--text-light);">We'll tailor activities to this interest when possible</small>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">‚ú® Generate Credit-Earning Plans</button>
                </form>

                <div id="generated-ideas" style="margin-top: 2rem;"></div>
            `;
        }

        function toggleBibleCredits(approach) {
            const messianicOption = document.getElementById('messianic-option');
            messianicOption.style.display = (approach === 'bible' || approach === 'both') ? 'block' : 'none';
        }

        function generateAltCredit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const subject = formData.get('subject');
            const approach = formData.get('approach');
            const interest = formData.get('interest');
            const messianicPerspective = formData.get('messianicPerspective') === 'on';

            const ideas = generateSubjectCreditIdeas(subject, approach, interest, messianicPerspective);
            
            const container = document.getElementById('generated-ideas');
            container.innerHTML = `
                <h3 style="margin-bottom: 1rem;">Ways to Earn ${getSubjectDisplayName(subject)} Credit</h3>
                ${ideas.map((idea, index) => `
                    <div class="card" style="margin-bottom: 1.5rem; border-left: 4px solid var(--primary);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <h4 style="margin: 0; color: var(--primary);">${index + 1}. ${idea.title}</h4>
                            <span class="badge badge-primary">${idea.creditType}</span>
                        </div>
                        <p style="margin-bottom: 1rem;">${idea.description}</p>
                        
                        <div class="card" style="background: var(--bg); margin-bottom: 1rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div>
                                    <strong>üìö Subject:</strong> ${getSubjectDisplayName(subject)}
                                </div>
                                <div>
                                    <strong>‚è±Ô∏è Hours:</strong> ${idea.hours}
                                </div>
                                <div>
                                    <strong>üéì Credits:</strong> ${idea.credits}
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <strong>üìñ How This Earns ${getSubjectDisplayName(subject)} Credit:</strong>
                            <p style="margin: 0.5rem 0 0 1rem; color: var(--text-light);">${idea.subjectJustification}</p>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <strong>üì∏ Evidence & Documentation:</strong>
                            <ul style="margin: 0.5rem 0 0 1.5rem;">
                                ${idea.evidence.map(e => `<li>${e}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <strong>üìä Assessment Criteria:</strong>
                            <ul style="margin: 0.5rem 0 0 1.5rem;">
                                ${idea.rubric.map(r => `<li>${r}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <strong>üéØ Standards Alignment:</strong>
                            <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">${idea.standards}</p>
                        </div>
                        
                        ${idea.messianicNotes ? `
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem;">
                                <strong style="color: white;">‚ú°Ô∏è Messianic/Torah-Observant Approach:</strong>
                                <p style="margin: 0.5rem 0 0 0;">${idea.messianicNotes}</p>
                            </div>
                        ` : ''}
                        
                        <button class="btn btn-secondary" onclick='addToAltCredits(${JSON.stringify(idea).replace(/'/g, "&#39;")})'>
                            + Assign to Student & Track
                        </button>
                    </div>
                `).join('')}
            `;
        }

        function getSubjectDisplayName(subject) {
            const names = {
                'mathematics': 'Mathematics',
                'english': 'English/Language Arts',
                'history': 'History/Social Studies',
                'science': 'Science',
                'foreign-language': 'Foreign Language',
                'fine-arts': 'Fine Arts',
                'physical-education': 'Physical Education',
                'life-skills': 'Life Skills/Electives'
            };
            return names[subject] || subject;
        }

        function generateSubjectCreditIdeas(subject, approach, interest, messianic) {
            const ideas = [];
            const useMessianicTerms = AppState.settings.useMessianicTerms || messianic;
            const godName = useMessianicTerms ? 'Yehovah' : 'God';
            const messiahName = useMessianicTerms ? "Y'eshua" : 'Jesus';

            // Generate real-life activities
            if (approach === 'real-life' || approach === 'both') {
                ideas.push(...generateRealLifeActivities(subject, interest));
            }

            // Generate Bible-based learning
            if (approach === 'bible' || approach === 'both') {
                ideas.push(...generateBibleSubjectCredit(subject, useMessianicTerms, godName, messiahName));
            }

            return ideas;
        }

        function generateRealLifeActivities(subject, interest) {
            const activities = [];

            switch(subject) {
                case 'mathematics':
                    activities.push({
                        title: 'Home Budgeting & Financial Planning',
                        creditType: 'Real-Life Math',
                        description: 'Create and manage a household budget for 2-3 months. Track all income and expenses, analyze spending patterns, create graphs, calculate percentages, and make data-driven financial decisions.',
                        hours: 45,
                        credits: 0.5,
                        subjectJustification: 'Demonstrates mastery of percentages, ratios, graphing, data analysis, algebra (solving for unknowns in budget equations), and real-world problem solving‚Äîall key mathematics standards.',
                        evidence: ['Monthly budget spreadsheets', 'Expense tracking logs', 'Graphs and charts of spending', 'Financial analysis report', 'Reflection on math concepts used'],
                        rubric: ['Budget accuracy and completeness (30%)', 'Mathematical analysis and calculations (30%)', 'Data visualization (20%)', 'Written reflection (20%)'],
                        standards: 'Aligns with mathematical modeling, data analysis, percentages, ratios, graphing, algebra, and quantitative reasoning standards.'
                    });

                    if (interest && interest.toLowerCase().includes('cook')) {
                        activities.push({
                            title: 'Culinary Mathematics: Scaling Recipes & Food Costing',
                            creditType: 'Real-Life Math',
                            description: 'Master ratio, proportion, and measurement by scaling recipes for different serving sizes, calculating food costs, analyzing nutrition data, and converting between measurement systems.',
                            hours: 40,
                            credits: 0.5,
                            subjectJustification: 'Uses ratios, proportions, fractions, decimals, measurement conversions, unit pricing, percentages, and algebraic thinking to solve real culinary problems.',
                            evidence: ['Scaled recipe collection with calculations', 'Food cost analysis spreadsheet', 'Nutrition data analysis', 'Measurement conversion charts', 'Completed dishes with photos'],
                            rubric: ['Mathematical accuracy (35%)', 'Recipe scaling (25%)', 'Cost analysis (20%)', 'Practical application (20%)'],
                            standards: 'Aligns with ratios, proportions, measurement, fractions, decimals, percentages, and applied mathematics standards.'
                        });
                    }

                    activities.push({
                        title: 'Construction & Carpentry Mathematics',
                        creditType: 'Real-Life Math',
                        description: 'Plan and build a structure (furniture, garden bed, shed) using geometry, measurement, area/volume calculations, angles, and material estimation.',
                        hours: 50,
                        credits: 0.5,
                        subjectJustification: 'Applies geometry (angles, area, volume), measurement, spatial reasoning, trigonometry basics, and mathematical planning to real construction projects.',
                        evidence: ['Detailed plans with measurements', 'Material cost calculations', 'Angle and cut diagrams', 'Progress photos', 'Completed project'],
                        rubric: ['Mathematical planning (30%)', 'Measurement accuracy (30%)', 'Problem-solving (20%)', 'Project completion (20%)'],
                        standards: 'Aligns with geometry, measurement, spatial reasoning, applied mathematics, and problem-solving standards.'
                    });
                    break;

                case 'english':
                    activities.push({
                        title: 'Community Journalism Project',
                        creditType: 'Real-Life English',
                        description: 'Research, write, and publish 10+ articles about your community. Conduct interviews, develop writing voice, edit work, and compile into a portfolio or blog.',
                        hours: 50,
                        credits: 0.5,
                        subjectJustification: 'Demonstrates research skills, expository and narrative writing, grammar and mechanics, editing, interviewing, and communication‚Äîcore English/Language Arts competencies.',
                        evidence: ['Published articles (10+)', 'Interview transcripts', 'Research notes', 'Editing drafts', 'Reflection on writing process'],
                        rubric: ['Writing quality (35%)', 'Research depth (25%)', 'Grammar & mechanics (20%)', 'Revision process (20%)'],
                        standards: 'Aligns with writing, research, communication, grammar, editing, and information literacy standards.'
                    });

                    activities.push({
                        title: 'Memoir or Novel Writing Project',
                        creditType: 'Real-Life English',
                        description: 'Write a complete memoir (30+ pages) or novel chapter draft. Develop characters, plot, setting, voice, and narrative structure through multiple drafts.',
                        hours: 60,
                        credits: 1.0,
                        subjectJustification: 'Covers creative writing, narrative structure, character development, grammar, editing, revision process, and sustained composition‚Äîfulfilling comprehensive English standards.',
                        evidence: ['Complete manuscript', 'Outline and planning documents', 'Multiple drafts showing revision', 'Peer or adult feedback', 'Reflection essay'],
                        rubric: ['Narrative quality (30%)', 'Character & plot development (25%)', 'Grammar & mechanics (20%)', 'Revision & growth (25%)'],
                        standards: 'Aligns with creative writing, composition, grammar, editing, narrative structure, and extended writing standards.'
                    });

                    activities.push({
                        title: 'Oral History & Storytelling Project',
                        creditType: 'Real-Life English',
                        description: 'Interview family members or community elders, transcribe stories, write narrative summaries, and create an oral history collection with analysis of themes and storytelling techniques.',
                        hours: 45,
                        credits: 0.5,
                        subjectJustification: 'Develops listening, interviewing, transcription, narrative writing, analysis, and communication skills essential to Language Arts standards.',
                        evidence: ['Interview recordings', 'Transcriptions', 'Narrative essays', 'Thematic analysis', 'Compiled collection'],
                        rubric: ['Interview quality (25%)', 'Writing & transcription (30%)', 'Analysis (25%)', 'Presentation (20%)'],
                        standards: 'Aligns with oral communication, narrative writing, analysis, listening comprehension, and cultural literacy standards.'
                    });
                    break;

                case 'history':
                    activities.push({
                        title: 'Family or Local History Research Project',
                        creditType: 'Real-Life History',
                        description: 'Research your family history or local community history spanning 50+ years. Interview sources, analyze primary documents, create timeline, and write historical narrative.',
                        hours: 50,
                        credits: 0.5,
                        subjectJustification: 'Uses historical research methods, primary source analysis, chronological thinking, cause-and-effect reasoning, and historical writing‚Äîcore history standards.',
                        evidence: ['Research notes and bibliography', 'Primary source documents', 'Interview transcripts', 'Timeline', 'Historical essay or presentation'],
                        rubric: ['Research quality (30%)', 'Primary source use (25%)', 'Historical analysis (25%)', 'Presentation (20%)'],
                        standards: 'Aligns with historical inquiry, research methods, chronological reasoning, primary source analysis, and historical writing standards.'
                    });

                    activities.push({
                        title: 'Historical Site Investigation & Documentation',
                        creditType: 'Real-Life History',
                        description: 'Choose a local historical site. Research its history, take field notes, photograph, interview historians or tour guides, and create comprehensive historical report.',
                        hours: 40,
                        credits: 0.5,
                        subjectJustification: 'Practices historical research, field investigation, primary and secondary source analysis, spatial history, and historical documentation methods.',
                        evidence: ['Field notes and photos', 'Research documentation', 'Interview notes', 'Historical timeline', 'Site report with analysis'],
                        rubric: ['Field research (25%)', 'Historical analysis (30%)', 'Documentation (25%)', 'Written report (20%)'],
                        standards: 'Aligns with historical inquiry, research, spatial history, and historical documentation standards.'
                    });
                    break;

                case 'science':
                    activities.push({
                        title: 'Long-Term Nature Observation & Scientific Documentation',
                        creditType: 'Real-Life Science',
                        description: 'Conduct a 12-week scientific observation of a local ecosystem. Record data, identify species, track patterns, form hypotheses, and write scientific report.',
                        hours: 50,
                        credits: 0.5,
                        subjectJustification: 'Demonstrates scientific method, observation, data collection, hypothesis formation, pattern analysis, and scientific writing‚Äîfundamental science standards.',
                        evidence: ['Field journal with observations', 'Species identification log', 'Data tables and graphs', 'Hypothesis and conclusions', 'Scientific report'],
                        rubric: ['Data collection (30%)', 'Scientific method (25%)', 'Analysis (25%)', 'Report quality (20%)'],
                        standards: 'Aligns with scientific inquiry, observation, data analysis, hypothesis testing, and scientific communication standards.'
                    });

                    if (interest && (interest.toLowerCase().includes('garden') || interest.toLowerCase().includes('plant'))) {
                        activities.push({
                            title: 'Garden Science: Plant Growth Experiments',
                            creditType: 'Real-Life Science',
                            description: 'Design and conduct controlled experiments on plant growth variables (light, water, soil, nutrients). Collect data, graph results, and write scientific conclusions.',
                            hours: 60,
                            credits: 0.5,
                            subjectJustification: 'Uses experimental design, controlled variables, data collection, quantitative analysis, graphing, and scientific reporting‚Äîcore scientific method standards.',
                            evidence: ['Experiment design document', 'Daily observation log', 'Data tables and graphs', 'Photos of plants', 'Scientific report with conclusions'],
                            rubric: ['Experimental design (30%)', 'Data collection (25%)', 'Analysis & graphing (25%)', 'Scientific writing (20%)'],
                            standards: 'Aligns with experimental design, botany, ecology, data analysis, and scientific inquiry standards.'
                        });
                    }

                    activities.push({
                        title: 'Home Chemistry: Kitchen Science Investigations',
                        creditType: 'Real-Life Science',
                        description: 'Investigate chemical reactions in cooking and cleaning. Test pH levels, study fermentation, explore acid-base reactions, and document scientific principles.',
                        hours: 45,
                        credits: 0.5,
                        subjectJustification: 'Explores chemistry concepts including reactions, pH, acids/bases, fermentation, and molecular interactions through hands-on experiments.',
                        evidence: ['Experiment documentation', 'pH testing results', 'Reaction observations', 'Safety protocols', 'Chemistry report'],
                        rubric: ['Experimentation (30%)', 'Safety awareness (20%)', 'Chemical understanding (30%)', 'Documentation (20%)'],
                        standards: 'Aligns with chemistry, scientific method, safety practices, and practical science application standards.'
                    });
                    break;

                case 'fine-arts':
                    activities.push({
                        title: 'Fine Arts Portfolio: Multi-Medium Creation',
                        creditType: 'Real-Life Arts',
                        description: 'Create 15+ original artworks using various media (drawing, painting, sculpture, digital). Document creative process, study art history, and present portfolio.',
                        hours: 60,
                        credits: 0.5,
                        subjectJustification: 'Demonstrates artistic technique, creativity, use of elements and principles of design, art history knowledge, and artistic development.',
                        evidence: ['Portfolio of 15+ works', 'Process photos and sketches', 'Artist statements', 'Art history research', 'Portfolio presentation'],
                        rubric: ['Technical skill (30%)', 'Creativity (25%)', 'Process documentation (20%)', 'Art history connection (25%)'],
                        standards: 'Aligns with visual arts standards including creation, analysis, art history, and artistic expression.'
                    });
                    break;

                case 'physical-education':
                    activities.push({
                        title: 'Personal Fitness Program & Training Log',
                        creditType: 'Real-Life PE',
                        description: 'Design and follow personal fitness program for 12 weeks. Track workouts, measure progress, study anatomy and nutrition, achieve fitness goals.',
                        hours: 50,
                        credits: 0.5,
                        subjectJustification: 'Develops physical fitness, health literacy, goal-setting, anatomy knowledge, and personal wellness‚Äîcore PE standards.',
                        evidence: ['Fitness plan document', '12-week training log', 'Progress measurements', 'Anatomy/nutrition research', 'Reflection essay'],
                        rubric: ['Program design (25%)', 'Consistent participation (30%)', 'Health knowledge (25%)', 'Goal achievement (20%)'],
                        standards: 'Aligns with physical fitness, health literacy, anatomy, nutrition, and personal wellness standards.'
                    });
                    break;

                case 'life-skills':
                    activities.push({
                        title: 'Home Management & Life Skills Practicum',
                        creditType: 'Real-Life Skills',
                        description: 'Take responsibility for running household operations for 8 weeks: meal planning, cooking, cleaning, budgeting, scheduling, and home maintenance.',
                        hours: 60,
                        credits: 0.5,
                        subjectJustification: 'Develops essential life skills including planning, budgeting, time management, nutrition, and household management.',
                        evidence: ['Meal plans and recipes', 'Budget tracking', 'Schedule/calendar', 'Home maintenance log', 'Reflection journal'],
                        rubric: ['Planning & organization (30%)', 'Execution (30%)', 'Budgeting (20%)', 'Reflection (20%)'],
                        standards: 'Aligns with life skills, personal finance, nutrition, time management, and independent living standards.'
                    });

                    activities.push({
                        title: 'Small Business or Entrepreneurship Project',
                        creditType: 'Real-Life Skills',
                        description: 'Start and operate a small business for 3 months. Create business plan, manage finances, market product/service, track sales, and evaluate success.',
                        hours: 70,
                        credits: 1.0,
                        subjectJustification: 'Integrates business planning, financial literacy, marketing, customer service, time management, and entrepreneurial thinking.',
                        evidence: ['Business plan', 'Financial records', 'Marketing materials', 'Sales logs', 'Final business report'],
                        rubric: ['Business planning (25%)', 'Financial management (25%)', 'Marketing & sales (25%)', 'Overall success (25%)'],
                        standards: 'Aligns with financial literacy, entrepreneurship, communication, problem-solving, and business standards.'
                    });
                    break;
            }

            return activities;
        }

        function generateBibleSubjectCredit(subject, useMessianic, godName, messiahName) {
            const activities = [];

            switch(subject) {
                case 'mathematics':
                    activities.push({
                        title: `Mathematics in Scripture: ${godName}'s Precision`,
                        creditType: 'Bible-Based Math',
                        description: `Study mathematical concepts throughout Scripture including temple measurements, prophetic numbers, patterns in creation, parables with mathematical elements, and numerical symbolism. Calculate, measure, and analyze ${godName}'s mathematical precision.`,
                        hours: 45,
                        credits: 0.5,
                        subjectJustification: 'Demonstrates geometry (Tabernacle/Temple), measurement systems, ratios and proportions, number theory, pattern analysis, and mathematical problem-solving using biblical texts.',
                        evidence: ['Mathematical analysis of biblical passages', 'Scale diagrams of Tabernacle/Temple', 'Number symbolism research', 'Problem sets based on parables', 'Reflection essay'],
                        rubric: ['Mathematical accuracy (35%)', 'Biblical integration (25%)', 'Analysis depth (20%)', 'Documentation (20%)'],
                        standards: 'Aligns with geometry, measurement, ratios, number theory, and applied mathematics standards.',
                        messianicNotes: useMessianic ? `Study from a Messianic perspective includes understanding Hebrew measures (cubit, omer, ephah), the mathematical precision in ${godName}'s instructions for the Tabernacle, patterns in appointed times (mo'edim), and prophetic numbers. Recognize ${messiahName} as the fulfillment of mathematical prophecies.` : `Explore how mathematical concepts reveal God's precision and order in creation and His instructions.`
                    });
                    break;

                case 'english':
                    activities.push({
                        title: `Literary Analysis & Writing Through Scripture`,
                        creditType: 'Bible-Based English',
                        description: `Comprehensive study of literary devices, narrative structure, poetry, and rhetoric in Scripture. Write analysis essays, create modern parallels of biblical narratives, study translation nuances, and develop written communication through biblical texts.`,
                        hours: 60,
                        credits: 1.0,
                        subjectJustification: 'Covers literary analysis (narrative, poetry, prophecy), writing (essays, creative responses), grammar through translation study, vocabulary development, and communication skills‚Äîcomplete English curriculum.',
                        evidence: ['Literary analysis essays (5+)', 'Creative writing based on biblical themes', 'Translation comparison study', 'Vocabulary journal', 'Comprehensive portfolio'],
                        rubric: ['Literary analysis (30%)', 'Writing quality (30%)', 'Grammar & mechanics (20%)', 'Depth of study (20%)'],
                        standards: 'Aligns with literary analysis, composition, grammar, vocabulary, creative writing, and communication standards.',
                        messianicNotes: useMessianic ? `Study includes analyzing Hebrew literary devices, understanding Torah narrative structure, examining prophetic poetry, and writing reflections on ${messiahName}'s parables from a Jewish context. ${godName}'s Word is studied as perfect literature while maintaining theological depth.` : `Study the Bible as literature while growing in faith and understanding.`
                    });

                    activities.push({
                        title: `Biblical Rhetoric & Persuasive Communication`,
                        creditType: 'Bible-Based English',
                        description: `Study persuasive techniques in prophetic speeches, apostolic letters, and ${messiahName}'s teaching. Analyze rhetoric, write persuasive essays on biblical themes, and present speeches using biblical communication models.`,
                        hours: 45,
                        credits: 0.5,
                        subjectJustification: 'Develops persuasive writing, rhetorical analysis, public speaking, argumentation, and communication skills through study of masterful biblical communicators.',
                        evidence: ['Rhetorical analysis essays', 'Persuasive speeches', 'Comparative rhetoric study', 'Original persuasive essays', 'Presentation recordings'],
                        rubric: ['Rhetorical analysis (30%)', 'Writing quality (30%)', 'Speaking skills (20%)', 'Critical thinking (20%)'],
                        standards: 'Aligns with persuasive writing, rhetoric, public speaking, and communication standards.',
                        messianicNotes: useMessianic ? `Analyze how prophets communicated ${godName}'s message, study ${messiahName}'s rabbinical teaching methods, and examine Paul's persuasive letters to congregations. Learn Torah-based communication and persuasion.` : null
                    });
                    break;

                case 'history':
                    activities.push({
                        title: `Ancient Near East & Biblical History`,
                        creditType: 'Bible-Based History',
                        description: `Comprehensive study of ancient history through biblical narrative. Research archaeology, study ancient civilizations (Egypt, Assyria, Babylon, Persia, Rome), analyze historical documents, and create historical timeline from creation to early church.`,
                        hours: 60,
                        credits: 1.0,
                        subjectJustification: 'Covers ancient history, historical research, chronology, cause-and-effect, primary source analysis, geography, and cultural studies‚Äîcomplete history curriculum through biblical lens.',
                        evidence: ['Comprehensive timeline', 'Civilization research papers', 'Archaeological study documentation', 'Historical maps', 'Final comprehensive essay'],
                        rubric: ['Historical accuracy (30%)', 'Research depth (25%)', 'Analysis quality (25%)', 'Documentation (20%)'],
                        standards: 'Aligns with ancient history, historical research, chronological thinking, geography, and cultural literacy standards.',
                        messianicNotes: useMessianic ? `Study includes Israel's history in context of ancient world, understanding ${godName}'s covenant through history, examining Jewish perspective on historical events, and seeing ${messiahName} in historical fulfillment of prophecy. Emphasize accuracy of Scripture as historical document.` : `Study world history through the biblical narrative and understand God's work throughout human history.`
                    });
                    break;

                case 'science':
                    activities.push({
                        title: `Creation Science & Natural World Study`,
                        creditType: 'Bible-Based Science',
                        description: `Study the natural world through the lens of creation. Research botany (plants), zoology (animals), astronomy, earth science, and human anatomy as described in Scripture. Conduct observations, document findings scientifically.`,
                        hours: 60,
                        credits: 1.0,
                        subjectJustification: 'Covers multiple science disciplines including biology, astronomy, earth science, and anatomy through observation, classification, data collection, and scientific method.',
                        evidence: ['Creation study journal', 'Species observation logs', 'Scientific drawings', 'Research papers on biblical creation accounts', 'Comparative analysis'],
                        rubric: ['Scientific observation (30%)', 'Biblical integration (25%)', 'Research quality (25%)', 'Documentation (20%)'],
                        standards: 'Aligns with life science, earth science, astronomy, scientific observation, and classification standards.',
                        messianicNotes: useMessianic ? `Study ${godName}'s creation as revealed in Genesis, understanding Hebrew creation terminology, observing Sabbath patterns in nature, and recognizing ${messiahName} as active in creation (John 1). Integrate Torah principles with natural observation.` : `Study God's creation scientifically while maintaining wonder at His design.`
                    });
                    break;

                case 'foreign-language':
                    if (useMessianic) {
                        activities.push({
                            title: `Biblical Hebrew Language Study`,
                            creditType: 'Bible-Based Language',
                            description: `Learn Biblical Hebrew alphabet, basic grammar, common vocabulary, and read simple passages. Study Hebrew names, understand word meanings, and gain insight into original Scripture text.`,
                            hours: 90,
                            credits: 1.0,
                            subjectJustification: 'Develops foreign language skills including alphabet, vocabulary, grammar, reading, translation, and cultural understanding‚Äîcomplete foreign language credit.',
                            evidence: ['Hebrew alphabet mastery', 'Vocabulary lists and flashcards', 'Translation exercises', 'Reading recordings', 'Personal study journal'],
                            rubric: ['Language proficiency (40%)', 'Scripture application (25%)', 'Written work (20%)', 'Oral reading (15%)'],
                            standards: 'Aligns with foreign language standards including reading, writing, speaking, listening, and cultural understanding.',
                            messianicNotes: `Learn the language of Scripture to understand ${godName}'s Word in original text. Study includes Hebrew alphabet, names of ${godName} and ${messiahName}, Torah vocabulary, and basic reading of biblical passages. Gain deeper understanding of Jewish context of faith.`
                        });
                    } else {
                        activities.push({
                            title: `Biblical Greek Language Study`,
                            creditType: 'Bible-Based Language',
                            description: `Learn New Testament Greek alphabet, basic grammar, common vocabulary, and read simple passages. Study word meanings and gain insight into New Testament text.`,
                            hours: 90,
                            credits: 1.0,
                            subjectJustification: 'Develops foreign language skills including alphabet, vocabulary, grammar, reading, and translation‚Äîcomplete foreign language credit.',
                            evidence: ['Greek alphabet mastery', 'Vocabulary lists', 'Translation exercises', 'Reading practice', 'Study journal'],
                            rubric: ['Language proficiency (40%)', 'Scripture application (25%)', 'Written work (20%)', 'Oral reading (15%)'],
                            standards: 'Aligns with foreign language standards including reading, writing, and cultural understanding.'
                        });
                    }
                    break;
            }

            return activities;
        }
        function addToAltCredits(idea) {
            if (AppState.students.length === 0) {
                alert('Please add a student first before creating alternative credits.');
                return;
            }

            const studentsOptions = AppState.students.map(s => 
                `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`
            ).join('');

            document.getElementById('modal-title').textContent = 'Add to Alternative Credits';
            document.getElementById('modal-body').innerHTML = `
                <form id="add-alt-credit-form" onsubmit="saveNewAltCredit(event, ${JSON.stringify(idea).replace(/"/g, '&quot;')})">
                    <div class="form-group">
                        <label class="form-label">Assign to Student *</label>
                        <select class="form-select" name="studentId" required>
                            <option value="">Select Student</option>
                            ${studentsOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-input" name="title" value="${idea.title}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Additional Notes (optional)</label>
                        <textarea class="form-textarea" name="notes" placeholder="Add any specific notes or modifications..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add to Tracker</button>
                    </div>
                </form>
            `;

            document.getElementById('modal-overlay').classList.add('active');
        }

        function saveNewAltCredit(event, idea) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const altCredit = {
                id: generateId(),
                studentId: formData.get('studentId'),
                title: idea.title,
                description: idea.description,
                hours: idea.hours,
                credits: idea.credits,
                evidence: idea.evidence,
                rubric: idea.rubric,
                standards: idea.standards,
                messianicNotes: idea.messianicNotes || null,
                status: 'planned',
                hoursCompleted: 0,
                notes: formData.get('notes') || '',
                dateAdded: new Date().toISOString().split('T')[0]
            };

            AppState.altCredits.push(altCredit);
            saveState();
            closeModal();
            alert('Added to Alternative Credits Tracker!');
            switchAltTab('tracker');
            renderAltCreditTracker();
        }

        function renderAltCreditTracker() {
            const container = document.getElementById('alt-credit-tracker');

            if (AppState.altCredits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No alternative credits tracked</h3>
                        <p>Use the generator to create credit ideas and add them here.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = AppState.altCredits.map(credit => {
                const student = AppState.students.find(s => s.id === credit.studentId);
                const progress = credit.hours > 0 ? (credit.hoursCompleted / credit.hours * 100) : 0;

                return `
                    <div class="card" style="margin-bottom: 1rem;">
                        <div class="flex-between mb-1">
                            <div>
                                <h4>${credit.title}</h4>
                                <p style="color: var(--text-light);">${student ? `${student.firstName} ${student.lastName}` : 'Unknown Student'}</p>
                            </div>
                            <div class="flex gap-1">
                                <span class="badge ${credit.status === 'completed' ? 'badge-success' : 'badge-warning'}">${credit.status}</span>
                                <button class="btn btn-sm btn-outline" onclick="editAltCredit('${credit.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteAltCredit('${credit.id}')">Delete</button>
                            </div>
                        </div>
                        <p>${credit.description}</p>
                        <div class="form-row" style="margin: 1rem 0;">
                            <div><strong>Hours:</strong> ${credit.hoursCompleted} / ${credit.hours}</div>
                            <div><strong>Credits:</strong> ${credit.credits}</div>
                            <div><strong>Progress:</strong> ${progress.toFixed(0)}%</div>
                        </div>
                        <div style="background: var(--bg); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: var(--secondary); height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editAltCredit(creditId) {
            const credit = AppState.altCredits.find(c => c.id === creditId);
            if (!credit) return;

            const studentsOptions = AppState.students.map(s => 
                `<option value="${s.id}" ${credit.studentId === s.id ? 'selected' : ''}>${s.firstName} ${s.lastName}</option>`
            ).join('');

            document.getElementById('modal-title').textContent = 'Edit Alternative Credit';
            document.getElementById('modal-body').innerHTML = `
                <form id="alt-credit-edit-form" onsubmit="saveAltCreditEdit(event, '${creditId}')">
                    <div class="form-group">
                        <label class="form-label">Student</label>
                        <select class="form-select" name="studentId">${studentsOptions}</select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status">
                            <option value="planned" ${credit.status === 'planned' ? 'selected' : ''}>Planned</option>
                            <option value="in-progress" ${credit.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                            <option value="completed" ${credit.status === 'completed' ? 'selected' : ''}>Completed</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Hours Completed</label>
                            <input type="number" class="form-input" name="hoursCompleted" value="${credit.hoursCompleted}" step="0.5">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Total Hours</label>
                            <input type="number" class="form-input" name="hours" value="${credit.hours}" step="0.5">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes">${credit.notes || ''}</textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update</button>
                    </div>
                </form>
            `;

            document.getElementById('modal-overlay').classList.add('active');
        }

        function saveAltCreditEdit(event, creditId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const credit = AppState.altCredits.find(c => c.id === creditId);
            credit.studentId = formData.get('studentId');
            credit.status = formData.get('status');
            credit.hoursCompleted = parseFloat(formData.get('hoursCompleted'));
            credit.hours = parseFloat(formData.get('hours'));
            credit.notes = formData.get('notes');

            saveState();
            closeModal();
            renderAltCreditTracker();
        }

        function deleteAltCredit(creditId) {
            if (confirm('Delete this alternative credit?')) {
                AppState.altCredits = AppState.altCredits.filter(c => c.id !== creditId);
                saveState();
                renderAltCreditTracker();
            }
        }

        // ===== Reports =====
        function renderReports() {
            const container = document.getElementById('reports-content');

            container.innerHTML = `
                <div class="card" style="margin-bottom: 1rem;">
                    <h3>Attendance Report</h3>
                    <p>Generate attendance records for any school year.</p>
                    <div class="form-row mt-2">
                        <div class="form-group">
                            <label class="form-label">Select Student</label>
                            <select class="form-select" id="attendance-report-student">
                                <option value="">All Students</option>
                                ${AppState.students.map(s => `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">School Year</label>
                            <select class="form-select" id="attendance-report-year">
                                <option value="2024-2025">2024-2025</option>
                                <option value="2025-2026">2025-2026</option>
                                <option value="2023-2024">2023-2024</option>
                                <option value="all">All Years</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="generateAttendanceReport()">Generate Report</button>
                        <button class="btn btn-secondary" onclick="manageAttendance()">Track Attendance</button>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 1rem;">
                    <h3>Alternative Credit Report</h3>
                    <p>Generate a comprehensive report of alternative credits with standards alignment.</p>
                    <div class="form-group mt-2">
                        <label class="form-label">Select Student</label>
                        <select class="form-select" id="alt-report-student">
                            <option value="">All Students</option>
                            ${AppState.students.map(s => `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`).join('')}
                        </select>
                    </div>
                    <button class="btn btn-primary mt-2" onclick="generateAltCreditReport()">Generate Report</button>
                </div>

                <div class="card">
                    <h3>Lesson Plan Report</h3>
                    <p>Generate a detailed lesson plan report for a student and course.</p>
                    <div class="form-row mt-2">
                        <div class="form-group">
                            <label class="form-label">Select Student</label>
                            <select class="form-select" id="lesson-report-student" onchange="updateLessonReportCourses()">
                                <option value="">Choose Student</option>
                                ${AppState.students.map(s => `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Select Course</label>
                            <select class="form-select" id="lesson-report-course">
                                <option value="">Choose Course</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary mt-2" onclick="generateLessonPlanReport()">Generate Report</button>
                </div>

                <div id="report-output" style="margin-top: 2rem;"></div>
            `;
        }

        function manageAttendance() {
            if (AppState.students.length === 0) {
                alert('Please add students first.');
                return;
            }

            const studentsOptions = AppState.students.map(s => 
                `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`
            ).join('');

            document.getElementById('modal-title').textContent = 'Track Attendance';
            document.getElementById('modal-body').innerHTML = `
                <div class="form-group">
                    <label class="form-label">Select Student</label>
                    <select class="form-select" id="attendance-student" onchange="loadAttendanceForStudent()">
                        <option value="">Choose a student</option>
                        ${studentsOptions}
                    </select>
                </div>
                <div id="attendance-calendar"></div>
            `;

            document.getElementById('modal-overlay').classList.add('active');
        }

        function loadAttendanceForStudent() {
            const studentId = document.getElementById('attendance-student').value;
            if (!studentId) {
                document.getElementById('attendance-calendar').innerHTML = '';
                return;
            }

            const student = AppState.students.find(s => s.id === studentId);
            if (!AppState.attendance[studentId]) {
                AppState.attendance[studentId] = {};
            }

            // Get current month
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();

            document.getElementById('attendance-calendar').innerHTML = `
                <div style="margin-top: 1.5rem;">
                    <h4>${student.firstName} ${student.lastName} - Attendance Entry</h4>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="attendance-date" value="${today.toISOString().split('T')[0]}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="attendance-status">
                            <option value="present">‚úÖ Present</option>
                            <option value="absent">‚ùå Absent</option>
                            <option value="excused">üìù Excused</option>
                            <option value="holiday">üéâ Holiday/Break</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes (optional)</label>
                        <textarea class="form-textarea" id="attendance-notes" placeholder="Reason for absence, etc."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="saveAttendanceEntry('${studentId}')">Save Entry</button>
                    
                    <div style="margin-top: 2rem;">
                        <h4>Recent Entries</h4>
                        ${renderRecentAttendance(studentId)}
                    </div>
                </div>
            `;
        }

        function renderRecentAttendance(studentId) {
            const entries = AppState.attendance[studentId] || {};
            const dates = Object.keys(entries).sort().reverse().slice(0, 10);

            if (dates.length === 0) {
                return '<p style="color: var(--text-light); margin-top: 0.5rem;">No attendance entries yet.</p>';
            }

            const statusIcons = {
                'present': '‚úÖ',
                'absent': '‚ùå',
                'excused': 'üìù',
                'holiday': 'üéâ'
            };

            return `
                <div style="max-height: 200px; overflow-y: auto;">
                    ${dates.map(date => {
                        const entry = entries[date];
                        return `
                            <div style="padding: 0.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${date}</strong>: ${statusIcons[entry.status]} ${entry.status}
                                    ${entry.notes ? `<br><small style="color: var(--text-light);">${entry.notes}</small>` : ''}
                                </div>
                                <button class="btn btn-sm btn-danger" onclick="deleteAttendanceEntry('${studentId}', '${date}')">Del</button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function saveAttendanceEntry(studentId) {
            const date = document.getElementById('attendance-date').value;
            const status = document.getElementById('attendance-status').value;
            const notes = document.getElementById('attendance-notes').value;

            if (!date) {
                alert('Please select a date.');
                return;
            }

            if (!AppState.attendance[studentId]) {
                AppState.attendance[studentId] = {};
            }

            AppState.attendance[studentId][date] = {
                status: status,
                notes: notes
            };

            saveState();
            loadAttendanceForStudent();
            alert('Attendance saved!');
        }

        function deleteAttendanceEntry(studentId, date) {
            if (confirm('Delete this attendance entry?')) {
                delete AppState.attendance[studentId][date];
                saveState();
                loadAttendanceForStudent();
            }
        }

        function generateAttendanceReport() {
            const studentId = document.getElementById('attendance-report-student').value;
            const year = document.getElementById('attendance-report-year').value;

            let students = studentId ? [AppState.students.find(s => s.id === studentId)] : AppState.students;

            if (students.length === 0 || (students.length === 1 && !students[0])) {
                alert('No students found.');
                return;
            }

            let reportHTML = `
                <div class="print-page">
                    <div class="print-header">
                        <h1>${AppState.settings.schoolName}</h1>
                        <h2>Attendance Report</h2>
                        ${AppState.settings.schoolAddress ? `<p>${AppState.settings.schoolAddress}</p>` : ''}
                        <p>School Year: ${year}</p>
                        <p>Report Date: ${new Date().toLocaleDateString()}</p>
                    </div>
            `;

            students.forEach(student => {
                const attendance = AppState.attendance[student.id] || {};
                const dates = Object.keys(attendance).sort();

                // Filter by year if needed
                let filteredDates = dates;
                if (year !== 'all') {
                    const [startYear, endYear] = year.split('-').map(y => parseInt(y));
                    filteredDates = dates.filter(date => {
                        const d = new Date(date);
                        const y = d.getFullYear();
                        const m = d.getMonth() + 1;
                        // School year: Sept of startYear to Aug of endYear
                        return (y === startYear && m >= 9) || (y === endYear && m <= 8);
                    });
                }

                // Calculate statistics
                const stats = {
                    present: 0,
                    absent: 0,
                    excused: 0,
                    holiday: 0,
                    total: filteredDates.length
                };

                filteredDates.forEach(date => {
                    stats[attendance[date].status]++;
                });

                reportHTML += `
                    <div class="print-section">
                        <h2>${student.firstName} ${student.lastName}</h2>
                        
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin: 1rem 0; padding: 1rem; background: var(--bg); border-radius: var(--radius);">
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: var(--secondary);">${stats.present}</div>
                                <div style="color: var(--text-light); font-size: 0.875rem;">Present</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: var(--danger);">${stats.absent}</div>
                                <div style="color: var(--text-light); font-size: 0.875rem;">Absent</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: var(--warning);">${stats.excused}</div>
                                <div style="color: var(--text-light); font-size: 0.875rem;">Excused</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${stats.holiday}</div>
                                <div style="color: var(--text-light); font-size: 0.875rem;">Holidays</div>
                            </div>
                        </div>

                        <p><strong>Total Days Recorded:</strong> ${stats.total}</p>
                        <p><strong>Attendance Rate:</strong> ${stats.total > 0 ? ((stats.present / (stats.present + stats.absent)) * 100).toFixed(1) : 0}%</p>

                        ${filteredDates.length > 0 ? `
                            <h3 style="margin-top: 1.5rem;">Detailed Records</h3>
                            <table style="width: 100%; margin-top: 1rem;">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredDates.map(date => {
                                        const entry = attendance[date];
                                        const statusIcons = {
                                            'present': '‚úÖ Present',
                                            'absent': '‚ùå Absent',
                                            'excused': 'üìù Excused',
                                            'holiday': 'üéâ Holiday'
                                        };
                                        return `
                                            <tr>
                                                <td>${date}</td>
                                                <td>${statusIcons[entry.status]}</td>
                                                <td>${entry.notes || '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        ` : '<p style="color: var(--text-light); margin-top: 1rem;">No attendance records for this period.</p>'}
                    </div>
                `;
            });

            reportHTML += `</div>`;

            document.getElementById('report-output').innerHTML = reportHTML;
            window.scrollTo(0, document.getElementById('report-output').offsetTop - 100);
        }

        function updateLessonReportCourses() {
            const studentId = document.getElementById('lesson-report-student').value;
            const courseSelect = document.getElementById('lesson-report-course');

            if (!studentId) {
                courseSelect.innerHTML = '<option value="">Choose Course</option>';
                return;
            }

            const courses = AppState.courses.filter(c => c.studentId === studentId);
            courseSelect.innerHTML = `
                <option value="">Choose Course</option>
                ${courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
            `;
        }

        function generateAltCreditReport() {
            const studentId = document.getElementById('alt-report-student').value;
            let credits = AppState.altCredits;

            if (studentId) {
                credits = credits.filter(c => c.studentId === studentId);
            }

            if (credits.length === 0) {
                alert('No alternative credits found for the selected criteria.');
                return;
            }

            let reportHTML = `
                <div class="print-page">
                    <div class="print-header">
                        <h1>${AppState.settings.schoolName}</h1>
                        <h2>Alternative Credit Report</h2>
                        ${AppState.settings.schoolAddress ? `<p>${AppState.settings.schoolAddress}</p>` : ''}
                        <p>Report Date: ${new Date().toLocaleDateString()}</p>
                    </div>
            `;

            credits.forEach(credit => {
                const student = AppState.students.find(s => s.id === credit.studentId);
                reportHTML += `
                    <div class="print-section">
                        <h2>${credit.title}</h2>
                        <p><strong>Student:</strong> ${student ? `${student.firstName} ${student.lastName}` : 'Unknown'}</p>
                        <p><strong>Status:</strong> ${credit.status} | <strong>Hours:</strong> ${credit.hoursCompleted}/${credit.hours} | <strong>Credits:</strong> ${credit.credits}</p>
                        
                        <h3>Activity Overview</h3>
                        <p>${credit.description}</p>

                        <h3>Evidence & Artifacts</h3>
                        <ul>
                            ${credit.evidence.map(e => `<li>${e}</li>`).join('')}
                        </ul>

                        <h3>Assessment Rubric</h3>
                        <ul>
                            ${credit.rubric.map(r => `<li>${r}</li>`).join('')}
                        </ul>

                        <h3>Standards Alignment</h3>
                        <p>${credit.standards}</p>

                        ${credit.messianicNotes ? `
                            <h3>Messianic/Torah-Observant Perspective</h3>
                            <p>${credit.messianicNotes}</p>
                        ` : ''}

                        ${credit.notes ? `
                            <h3>Notes</h3>
                            <p>${credit.notes}</p>
                        ` : ''}
                    </div>
                `;
            });

            reportHTML += `</div>`;

            document.getElementById('report-output').innerHTML = reportHTML;
            window.scrollTo(0, document.getElementById('report-output').offsetTop - 100);
        }

        function generateLessonPlanReport() {
            const courseId = document.getElementById('lesson-report-course').value;
            if (!courseId) {
                alert('Please select a course.');
                return;
            }

            const course = AppState.courses.find(c => c.id === courseId);
            const student = AppState.students.find(s => s.id === course.studentId);
            const subject = AppState.subjects.find(s => s.id === course.subjectId);

            let reportHTML = `
                <div class="print-page">
                    <div class="print-header">
                        <h1>${AppState.settings.schoolName}</h1>
                        <h2>Lesson Plan Report</h2>
                        ${AppState.settings.schoolAddress ? `<p>${AppState.settings.schoolAddress}</p>` : ''}
                    </div>

                    <div class="print-section">
                        <h2>Course Information</h2>
                        <p><strong>Course:</strong> ${course.name}</p>
                        <p><strong>Student:</strong> ${student ? `${student.firstName} ${student.lastName}` : 'Unknown'}</p>
                        <p><strong>Subject:</strong> ${subject?.name || 'Unknown'}</p>
                        <p><strong>Year:</strong> ${course.year}</p>
                        <p><strong>Credits:</strong> ${course.credits}</p>
                    </div>

                    <div class="print-section">
                        <h2>Course Outline</h2>
            `;

            course.units?.forEach(unit => {
                reportHTML += `
                    <h3>${unit.name}</h3>
                `;
                
                unit.modules?.forEach(module => {
                    reportHTML += `<h4 style="margin-left: 1rem;">${module.name}</h4>`;
                    
                    if (module.lessons && module.lessons.length > 0) {
                        reportHTML += '<ul style="margin-left: 2rem;">';
                        module.lessons.forEach(lesson => {
                            reportHTML += `<li>${lesson.name} ${lesson.date ? `(${lesson.date})` : ''}</li>`;
                        });
                        reportHTML += '</ul>';
                    }
                });
            });

            reportHTML += `
                    </div>
                </div>
            `;

            document.getElementById('report-output').innerHTML = reportHTML;
            window.scrollTo(0, document.getElementById('report-output').offsetTop - 100);
        }

        // ===== Settings =====
        function renderSettings() {
            const container = document.getElementById('settings-content');

            container.innerHTML = `
                <form id="settings-form" onsubmit="saveSettings(event)">
                    <h3>School Information</h3>
                    <div class="form-group">
                        <label class="form-label">School Name</label>
                        <input type="text" class="form-input" name="schoolName" value="${AppState.settings.schoolName}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">School Address</label>
                        <input type="text" class="form-input" name="schoolAddress" value="${AppState.settings.schoolAddress}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Information</label>
                        <input type="text" class="form-input" name="schoolContact" value="${AppState.settings.schoolContact}">
                    </div>

                    <h3 style="margin-top: 2rem;">Grade Level Settings</h3>
                    <div class="form-group">
                        <label class="form-label">Grade Level Cutoff Date (MM-DD)</label>
                        <input type="text" class="form-input" name="gradeLevelCutoff" value="${AppState.settings.gradeLevelCutoff}" placeholder="09-01">
                        <small style="color: var(--text-light);">Students reaching age 5 by this date are considered Kindergarten</small>
                    </div>

                    <h3 style="margin-top: 2rem;">Credit Defaults</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Full Year Credits</label>
                            <input type="number" class="form-input" name="defaultFullYearCredits" value="${AppState.settings.defaultFullYearCredits}" step="0.25">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Half Year Credits</label>
                            <input type="number" class="form-input" name="defaultHalfYearCredits" value="${AppState.settings.defaultHalfYearCredits}" step="0.25">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quarter Credits</label>
                            <input type="number" class="form-input" name="defaultQuarterCredits" value="${AppState.settings.defaultQuarterCredits}" step="0.25">
                        </div>
                    </div>

                    <h3 style="margin-top: 2rem;">Scripture Study Settings</h3>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" name="useMessianicTerms" id="useMessianicTerms" ${AppState.settings.useMessianicTerms ? 'checked' : ''}>
                            <label for="useMessianicTerms">Use Messianic terms (Yehovah, Y'eshua) in generated content</label>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                    </div>
                </form>
            `;
        }

        function saveSettings(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            AppState.settings.schoolName = formData.get('schoolName');
            AppState.settings.schoolAddress = formData.get('schoolAddress');
            AppState.settings.schoolContact = formData.get('schoolContact');
            AppState.settings.gradeLevelCutoff = formData.get('gradeLevelCutoff');
            AppState.settings.defaultFullYearCredits = parseFloat(formData.get('defaultFullYearCredits'));
            AppState.settings.defaultHalfYearCredits = parseFloat(formData.get('defaultHalfYearCredits'));
            AppState.settings.defaultQuarterCredits = parseFloat(formData.get('defaultQuarterCredits'));
            AppState.settings.useMessianicTerms = formData.get('useMessianicTerms') === 'on';

            saveState();
            alert('Settings saved successfully!');
        }

        // ===== Backup & Export =====
        function renderBackup() {
            const container = document.getElementById('backup-content');

            container.innerHTML = `
                <div class="card" style="margin-bottom: 1rem;">
                    <h3>Export Data</h3>
                    <p>Download all your data as JSON for backup or transfer.</p>
                    <button class="btn btn-primary" onclick="exportJSON()">üì• Export to JSON</button>
                </div>

                <div class="card" style="margin-bottom: 1rem;">
                    <h3>Import Data</h3>
                    <p>Import data from a JSON backup file.</p>
                    <input type="file" id="import-file" accept=".json" class="form-input" style="margin-bottom: 1rem;">
                    <div class="flex gap-1">
                        <button class="btn btn-primary" onclick="importJSON('replace')">Import (Replace All)</button>
                        <button class="btn btn-secondary" onclick="importJSON('merge')">Import (Merge)</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Export Gradebook CSV</h3>
                    <p>Export gradebook data as CSV for use in spreadsheet applications.</p>
                    <div class="form-group">
                        <label class="form-label">Select Student</label>
                        <select class="form-select" id="csv-student">
                            <option value="all">All Students</option>
                            ${AppState.students.map(s => `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`).join('')}
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="exportCSV()">üìä Export to CSV</button>
                </div>
            `;
        }

        function exportJSON() {
            const dataStr = JSON.stringify(AppState, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `homeschool-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importJSON(mode) {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to import.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    if (mode === 'replace') {
                        if (confirm('This will replace ALL existing data. Are you sure?')) {
                            Object.assign(AppState, imported);
                            saveState();
                            alert('Data imported successfully! Refreshing...');
                            location.reload();
                        }
                    } else {
                        // Merge mode
                        AppState.students.push(...imported.students.filter(s => !AppState.students.find(existing => existing.id === s.id)));
                        AppState.subjects.push(...imported.subjects.filter(s => !AppState.subjects.find(existing => existing.id === s.id)));
                        AppState.courses.push(...imported.courses.filter(c => !AppState.courses.find(existing => existing.id === c.id)));
                        AppState.altCredits.push(...imported.altCredits.filter(a => !AppState.altCredits.find(existing => existing.id === a.id)));
                        
                        saveState();
                        alert('Data merged successfully! Refreshing...');
                        location.reload();
                    }
                } catch (error) {
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function exportCSV() {
            const studentId = document.getElementById('csv-student').value;
            let courses = AppState.courses;

            if (studentId !== 'all') {
                courses = courses.filter(c => c.studentId === studentId);
            }

            let csv = 'Student,Course,Subject,Unit,Module,Lesson,Assignment,Points Earned,Points Possible,Weight,Percentage\n';

            courses.forEach(course => {
                const student = AppState.students.find(s => s.id === course.studentId);
                const subject = AppState.subjects.find(s => s.id === course.subjectId);
                
                course.units?.forEach(unit => {
                    unit.modules?.forEach(module => {
                        module.lessons?.forEach(lesson => {
                            lesson.items?.forEach(item => {
                                const pct = item.pointsPossible ? ((item.pointsEarned / item.pointsPossible) * 100).toFixed(2) : '0';
                                csv += `"${student?.firstName} ${student?.lastName}","${course.name}","${subject?.name}","${unit.name}","${module.name}","${lesson.name}","${item.name}",${item.pointsEarned},${item.pointsPossible},${item.weight},${pct}\n`;
                            });
                        });
                    });
                });
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `gradebook-export-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // ===== Modal Management =====
        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }

        // Close modal on overlay click
        document.getElementById('modal-overlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // ===== Search Functionality =====
        function performSearch(searchTerm) {
            if (!searchTerm) {
                // Clear search - show all items
                document.querySelectorAll('.list-item, .accordion-item').forEach(item => {
                    item.style.display = '';
                });
                return;
            }

            // Search based on current view
            const currentView = AppState.currentView;
            
            if (currentView === 'students') {
                document.querySelectorAll('.list-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            } else if (currentView === 'subjects') {
                document.querySelectorAll('.list-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            } else if (currentView === 'courses') {
                document.querySelectorAll('.list-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            } else if (currentView === 'gradebook') {
                document.querySelectorAll('.accordion-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            } else if (currentView === 'planner') {
                document.querySelectorAll('.accordion-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            } else if (currentView === 'alt-credits') {
                document.querySelectorAll('.card').forEach(card => {
                    // Skip the main tabs card
                    if (card.querySelector('.tabs')) return;
                    const text = card.textContent.toLowerCase();
                    card.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }
        }

        // ===== Initialization =====
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved data
            loadState();

            // Setup navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    switchView(this.dataset.view);
                });
            });

            // Initial render
            switchView('dashboard');

            // Setup search
            document.getElementById('global-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                performSearch(searchTerm);
            });
        });
    </script>

    <div style="position: fixed; bottom: 0; left: 0; right: 0; background-color: rgba(125, 85, 114, 0.95); color: white; padding: 0.75rem; text-align: center; font-size: 0.85rem; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.2);">
        By using this tool, you agree to our <a href="../website-terms.html" style="color: #ffd4e5; text-decoration: underline; font-weight: 600;">Website Terms of Use</a>. Provided "as-is" for educational purposes.
    </div>
</body>
</html>