<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Math Manipulatives</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1f2937;
        }

        /* Show only first two tools for portfolio sample */
        .tool-category:nth-of-type(n+2) {
            display: none;
        }

        /* Hide 3rd and 4th tools in first category */
        .tool-category:first-of-type .manipulative-btn:nth-of-type(n+3) {
            display: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 0;
            min-height: 600px;
            transition: grid-template-columns 0.3s ease;
        }

        .main-content.topics-collapsed {
            grid-template-columns: minmax(0, auto) 1fr;
        }

        .sidebar {
            background: #f9fafb;
            border-right: 2px solid #e5e7eb;
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
            transition: padding 0.3s ease;
        }

        .sidebar-toolbar {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .sidebar.topics-collapsed {
            padding: 20px 16px;
        }

        .sidebar.topics-collapsed .sidebar-toolbar {
            justify-content: center;
        }

        #topic-list {
            display: block;
        }

        .sidebar.topics-collapsed #topic-list {
            display: none;
        }

        .tool-category {
            margin-bottom: 20px;
        }

        .tool-category h3 {
            font-size: 14px;
            text-transform: uppercase;
            color: #6b7280;
            margin-bottom: 10px;
            padding-left: 5px;
        }

        .manipulative-btn {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 8px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .manipulative-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateX(5px);
        }

        .manipulative-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .manipulative-btn .icon {
            font-size: 22px;
            min-width: 24px;
        }

        .workspace {
            padding: 30px;
            position: relative;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .workspace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
            flex-wrap: wrap;
            gap: 15px;
        }

        .workspace-title {
            font-size: 1.8em;
            color: #1f2937;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .controls-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .controls-toggle {
            white-space: nowrap;
        }

        .controls-toggle.active,
        .topics-toggle.active {
            background: #667eea;
            color: #ffffff;
        }

        .controls-toggle.active:hover,
        .topics-toggle.active:hover {
            background: #5568d3;
            color: #ffffff;
        }

        .workspace.controls-minimized .controls {
            display: none;
        }

        .workspace.controls-minimized .workspace-header {
            padding-bottom: 8px;
            border-bottom: none;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #10b981;
            color: white;
        }

        .btn-secondary:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-info {
            background: #3b82f6;
            color: white;
        }

        .btn-info:hover {
            background: #2563eb;
        }

        .btn-warning {
            background: #f59e0b;
            color: #1f2937;
        }

        .btn-warning:hover {
            background: #d97706;
            color: white;
        }

        .btn-muted {
            background: #e5e7eb;
            color: #1f2937;
        }

        .btn-muted:hover {
            background: #d1d5db;
        }

        .canvas-container {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            padding: 20px;
            min-height: 500px;
            position: relative;
            overflow: auto;
        }

        canvas {
            display: block;
            margin: 0 auto;
            cursor: grab;
            background: white;
            border-radius: 10px;
        }

        canvas:active {
            cursor: grabbing;
        }

        canvas.selecting {
            cursor: crosshair;
        }

        /* Place Value Blocks Styles */
        .block-one { background: #3b82f6; }
        .block-ten { background: #10b981; }
        .block-hundred { background: #f59e0b; }
        .block-thousand { background: #ef4444; }

        /* Fraction Bar Styles */
        .fraction-container {
            padding: 20px;
        }

        .fraction-bar-wrapper {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
        }

        .fraction-operation-selector {
            margin: 20px 0;
            padding: 15px;
            background: #f3f4f6;
            border-radius: 10px;
            text-align: center;
        }

        .fraction-operation-selector label {
            font-weight: 600;
            margin-right: 10px;
        }

        .fraction-operation-selector select {
            padding: 8px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .fraction-bar {
            display: grid;
            gap: 4px;
            margin: 10px 0;
            height: 50px;
        }

        .fraction-segment {
            border: 3px solid #1f2937;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #e5e7eb;
        }

        .fraction-segment.filled {
            background: #8b5cf6;
        }

        .fraction-segment:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .fraction-label {
            font-size: 20px;
            font-weight: 700;
            margin: 10px 0;
            text-align: center;
        }

        .fraction-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .fraction-input {
            width: 80px;
            padding: 8px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
        }

        /* Array/Grid Styles */
        .array-grid {
            display: inline-grid;
            gap: 3px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            user-select: none;
            --array-cell-size: 35px;
        }

        .array-cell {
            width: var(--array-cell-size);
            height: var(--array-cell-size);
            border: 2px solid #1f2937;
            border-radius: 6px;
            background: #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .array-cell.active {
            background: #3b82f6;
            transform: scale(0.95);
        }

        .array-cell:hover {
            background: #cbd5e1;
            transform: scale(1.05);
        }

        .array-info {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
            font-weight: 700;
        }

        /* Division Groups Styles */
        .division-container {
            padding: 20px;
        }

        .items-pool {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 20px;
            background: white;
            border: 3px dashed #9ca3af;
            border-radius: 15px;
            margin-bottom: 20px;
            min-height: 100px;
        }

        .division-item {
            width: 40px;
            height: 40px;
            background: #8b5cf6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: move;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .division-item:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .group-box {
            min-height: 150px;
            background: #f9fafb;
            border: 3px dashed #9ca3af;
            border-radius: 15px;
            padding: 15px;
        }

        .group-title {
            font-weight: 700;
            color: #374151;
            margin-bottom: 10px;
            text-align: center;
        }

        .group-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        /* Number Line Styles */
        .number-line-container {
            padding: 40px 20px;
            text-align: center;
        }

        .number-line-svg {
            width: 100%;
            max-width: 800px;
            height: 200px;
            margin: 20px auto;
        }

        .zoom-controls {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            align-items: center;
        }

        .zoom-info {
            font-weight: 600;
            color: #374151;
            min-width: 100px;
        }

        /* Decimal Grid Styles */
        .decimal-grid-container {
            text-align: center;
            padding: 20px;
        }

        .grid-100 {
            display: inline-grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            padding: 10px;
            background: white;
            border: 3px solid #1f2937;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .grid-cell {
            width: 35px;
            height: 35px;
            border: 1px solid #9ca3af;
            background: #e5e7eb;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .grid-cell.filled {
            background: #3b82f6;
        }

        .grid-cell:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .grid-info {
            margin-top: 20px;
            font-size: 20px;
            font-weight: 700;
        }

        /* Feedback Messages */
        .feedback {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .feedback.show {
            display: block;
        }

        .feedback.success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }

        .feedback.error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }

        .feedback.info {
            background: #dbeafe;
            color: #1e40af;
            border: 2px solid #3b82f6;
        }

        /* Instructions Panel */
        .instructions {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .instructions h3 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .instructions p {
            color: #78350f;
            line-height: 1.6;
        }

        /* Step-by-Step Guide Panel */
        .step-guide {
            background: #e0f2fe;
            border: 2px solid #0284c7;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .step-guide.show {
            display: block;
        }

        .step-guide h3 {
            color: #075985;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .step-item {
            background: white;
            border-left: 4px solid #0284c7;
            padding: 12px 15px;
            margin: 10px 0;
            border-radius: 6px;
        }

        .step-number {
            display: inline-block;
            background: #0284c7;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: bold;
            margin-right: 10px;
        }

        .step-content {
            display: inline-block;
            vertical-align: top;
            width: calc(100% - 45px);
            color: #075985;
            line-height: 1.6;
        }

        .step-visual {
            background: #f0f9ff;
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            color: #0c4a6e;
        }

        .step-highlight {
            background: #fef08a;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }

        .step-input {
            width: 90px;
            max-width: 100%;
            padding: 6px 8px;
            margin: 0 6px;
            border: 2px solid #0284c7;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            color: #075985;
        }

        .toggle-guide {
            background: none;
            border: none;
            padding: 0;
            font: inherit;
            margin-top: 10px;
            cursor: pointer;
            color: #0284c7;
            font-weight: 600;
            text-decoration: underline;
        }

        .toggle-guide:hover {
            color: #075985;
        }


        /* === HUD THEME OVERRIDES === */
        :root {
            --hud-bg: #020b16;
            --hud-panel: rgba(4, 18, 32, 0.92);
            --hud-panel-alt: rgba(5, 26, 38, 0.9);
            --hud-border: rgba(0, 255, 213, 0.32);
            --hud-border-soft: rgba(0, 255, 213, 0.18);
            --hud-text-primary: #bffcff;
            --hud-text-secondary: rgba(168, 255, 255, 0.75);
            --hud-accent: #71ffe7;
            --hud-accent-strong: #00f0ff;
        }

        body {
            background: radial-gradient(circle at 20% 20%, rgba(0, 255, 204, 0.08), transparent 55%),
                        radial-gradient(circle at 80% 0%, rgba(0, 155, 255, 0.08), transparent 60%),
                        var(--hud-bg);
            color: var(--hud-text-primary);
            font-family: "JetBrains Mono", "Orbitron", "VT323", "Lucida Console", monospace;
            letter-spacing: 0.03em;
        }

        .container {
            background: rgba(3, 14, 26, 0.96);
            border: 1px solid var(--hud-border);
            box-shadow: 0 30px 70px rgba(0, 255, 255, 0.12);
        }

        header {
            background: linear-gradient(135deg, rgba(0, 52, 82, 0.75), rgba(0, 140, 160, 0.45));
            border-bottom: 1px solid var(--hud-border);
            box-shadow: inset 0 0 22px rgba(0, 255, 213, 0.12);
        }

        h1 {
            letter-spacing: 0.12em;
        }

        .subtitle {
            color: var(--hud-text-secondary);
        }

        .main-content {
            background: transparent;
        }

        .sidebar {
            background: var(--hud-panel);
            border-right: 1px solid var(--hud-border);
            color: var(--hud-text-secondary);
        }

        .tool-category h3 {
            color: var(--hud-accent);
            letter-spacing: 0.18em;
        }

        .manipulative-btn {
            background: rgba(3, 20, 32, 0.92);
            border: 1px solid var(--hud-border-soft);
            color: var(--hud-text-primary);
            box-shadow: 0 10px 24px rgba(0, 255, 255, 0.08);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .manipulative-btn .icon {
            color: var(--hud-accent);
        }

        .manipulative-btn:hover,
        .manipulative-btn.active {
            background: linear-gradient(135deg, rgba(0, 255, 213, 0.25), rgba(0, 140, 255, 0.25));
            border-color: rgba(0, 255, 255, 0.6);
            color: #02131f;
            box-shadow: 0 18px 36px rgba(0, 255, 255, 0.28);
        }

        .workspace {
            background: var(--hud-panel);
            border-left: 1px solid var(--hud-border);
        }

        .workspace-header {
            border-bottom: 1px solid var(--hud-border);
        }

        .workspace-title {
            color: var(--hud-accent);
            letter-spacing: 0.1em;
        }

        .controls .btn {
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .btn {
            background: rgba(3, 26, 40, 0.92);
            border: 1px solid var(--hud-border);
            color: var(--hud-text-primary);
            box-shadow: 0 10px 24px rgba(0, 255, 255, 0.12);
        }

        .btn:hover {
            transform: translateY(-2px);
            border-color: rgba(0, 255, 255, 0.65);
            box-shadow: 0 14px 32px rgba(0, 255, 255, 0.2);
        }

        .btn-primary,
        .btn-secondary,
        .btn-info,
        .btn-warning,
        .btn-danger,
        .btn-muted {
            background: linear-gradient(135deg, rgba(0, 255, 213, 0.3), rgba(0, 128, 255, 0.35));
            color: #02131f;
            border-color: rgba(0, 255, 255, 0.55);
        }

        .btn-warning,
        .btn-muted {
            background: linear-gradient(135deg, rgba(0, 200, 255, 0.28), rgba(0, 128, 255, 0.32));
        }

        .btn-danger {
            background: linear-gradient(135deg, rgba(255, 80, 120, 0.3), rgba(255, 120, 160, 0.35));
        }

        .canvas-container {
            background: rgba(3, 16, 28, 0.9);
            border: 1px solid var(--hud-border);
            box-shadow: inset 0 0 18px rgba(0, 255, 213, 0.12);
        }

        canvas {
            background: rgba(1, 10, 22, 0.95);
            border: 1px solid rgba(0, 255, 213, 0.2);
        }

        .instructions,
        .step-guide,
        .feedback,
        .fraction-operation-selector,
        .algebra-palette,
        .polygon-info,
        .slider-controls,
        .form-selector,
        .equation-inputs {
            background: var(--hud-panel-alt);
            border: 1px solid var(--hud-border-soft);
            color: var(--hud-text-primary);
            box-shadow: inset 0 0 18px rgba(0, 255, 255, 0.08);
        }

        .feedback.success {
            background: rgba(0, 255, 213, 0.12);
            color: var(--hud-accent);
            border-color: rgba(0, 255, 213, 0.35);
        }

        .feedback.error {
            background: rgba(255, 80, 120, 0.12);
            color: #ff8aa9;
            border-color: rgba(255, 80, 120, 0.35);
        }

        .feedback.info {
            background: rgba(0, 160, 255, 0.12);
            color: #7fd4ff;
            border-color: rgba(0, 160, 255, 0.35);
        }

        .fraction-bar-wrapper,
        .array-grid,
        .items-pool,
        .group-box,
        .algebra-workspace,
        .algebra-zone,
        .polygon-canvas,
        .coordinate-canvas,
        .transform-canvas,
        .grapher-canvas,
        .form-btn,
        .quadratic-container,
        .system-container,
        .division-container,
        .number-line-container,
        .protractor-container,
        .polygon-container,
        .coordinate-container,
        .transform-container,
        .balance-container,
        .grapher-container {
            background: var(--hud-panel);
            border: 1px solid var(--hud-border-soft);
            color: var(--hud-text-primary);
        }

        .form-btn.active {
            background: linear-gradient(135deg, rgba(0, 255, 213, 0.4), rgba(0, 128, 255, 0.4));
            color: #02131f;
        }

        .fraction-segment {
            border-color: rgba(0, 255, 213, 0.35);
            background: rgba(3, 26, 40, 0.85);
        }

        .fraction-segment.filled {
            background: rgba(0, 255, 213, 0.35);
        }

        .array-cell {
            border-color: rgba(0, 255, 213, 0.28);
            background: rgba(3, 26, 40, 0.85);
        }

        .array-cell.active {
            background: rgba(0, 255, 213, 0.4);
        }

        .division-item {
            background: rgba(0, 255, 213, 0.4);
            color: #02131f;
        }

        .point-item {
            background: rgba(0, 32, 48, 0.85);
            border: 1px solid rgba(0, 255, 213, 0.2);
            color: var(--hud-text-primary);
        }

        .expand-btn {
            background: rgba(0, 24, 38, 0.8);
            border: 1px solid var(--hud-border);
            color: var(--hud-text-primary);
            box-shadow: 0 10px 20px rgba(0, 255, 255, 0.15);
        }

        .expand-btn:hover {
            border-color: rgba(0, 255, 255, 0.65);
            color: var(--hud-accent);
        }

        .selection-rect {
            border-color: rgba(0, 255, 213, 0.55);
            background: rgba(0, 255, 213, 0.18);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 213, 0.3);
            border-radius: 999px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(3, 20, 32, 0.6);
        }

        .instructions h3 {
            color: var(--hud-accent);
        }

        .instructions p,
        .tool-category span,
        .workspace-header span,
        .fraction-label,
        .fraction-controls,
        .array-info,
        .group-title,
        .point-item .coords,
        .zoom-info,
        .angle-display {
            color: var(--hud-text-primary);
        }

        .workspace-title,
        .tool-category h3,
        .instructions h3,
        .angle-display {
            text-shadow: 0 0 12px rgba(0, 255, 255, 0.25);
        }


        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .main-content.topics-collapsed {
                grid-template-columns: 1fr;
            }

            .sidebar {
                border-right: none;
                border-bottom: 2px solid #e5e7eb;
                max-height: 300px;
            }

            .sidebar.topics-collapsed {
                max-height: none;
            }

            .manipulative-btn {
                padding: 10px 12px;
                font-size: 14px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 1.8em;
            }

            .workspace {
                padding: 15px;
            }

            .array-cell, .grid-cell {
                width: 25px;
                height: 25px;
            }
        }

        /* Selection rectangle for array */
        .selection-rect {
            position: absolute;
            border: 2px dashed #667eea;
            background: rgba(102, 126, 234, 0.2);
            pointer-events: none;
        }

        /* Protractor styles */
        .protractor-container {
            text-align: center;
            padding: 30px;
        }

        .angle-display {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin: 20px 0;
        }

        .angle-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .angle-slider {
            width: 300px;
        }

        /* Polygon Builder styles */
        .polygon-container {
            text-align: center;
            padding: 20px;
        }

        .polygon-canvas {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: crosshair;
            margin: 20px auto;
            display: block;
        }

        .polygon-info {
            background: #f3f4f6;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: inline-block;
        }

        .polygon-info div {
            margin: 8px 0;
            font-weight: 600;
        }

        /* Coordinate Plane styles */
        .coordinate-container {
            text-align: center;
            padding: 20px;
        }

        .coordinate-canvas {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            margin: 20px auto;
            display: block;
        }

        .point-list {
            margin-top: 20px;
            text-align: left;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .point-item {
            background: #f3f4f6;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .point-item .coords {
            font-weight: 600;
            color: #374151;
        }

        /* Transform styles */
        .transform-container {
            padding: 20px;
        }

        .transform-canvas {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            margin: 20px auto;
            display: block;
        }

        .transform-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .transform-mode {
            padding: 10px 20px;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .transform-mode.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .transform-mode:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Fullscreen styles */
        .expand-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            z-index: 100;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .expand-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .fullscreen-workspace {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            max-height: 100vh !important;
            z-index: 9999 !important;
            background: white !important;
            overflow: auto !important;
            padding: 60px 20px 20px 20px !important;
        }

        .fullscreen-workspace .canvas-container {
            max-width: 1400px;
            margin: 0 auto;
            min-height: calc(100vh - 100px);
        }

        /* Algebra Tiles styles */
        .algebra-container {
            padding: 20px;
            text-align: center;
        }

        .algebra-workspace {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-width: 800px;
        }

        .tile {
            display: inline-block;
            margin: 5px;
            cursor: move;
            border: 2px solid #1f2937;
            border-radius: 6px;
            font-weight: 700;
            text-align: center;
            line-height: 1;
            user-select: none;
            transition: all 0.2s ease;
        }

        .tile:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .tile-x2 {
            width: 80px;
            height: 80px;
            background: #3b82f6;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tile-x {
            width: 80px;
            height: 30px;
            background: #10b981;
            color: white;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tile-1 {
            width: 30px;
            height: 30px;
            background: #f59e0b;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tile-negative {
            opacity: 0.6;
            border-style: dashed;
        }

        .algebra-palette {
            background: #f3f4f6;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .algebra-zone {
            min-height: 200px;
            background: #f9fafb;
            border: 2px dashed #9ca3af;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            position: relative;
        }

        /* Balance Scale styles */
        .balance-container {
            padding: 20px;
            text-align: center;
        }

        .scale-svg {
            width: 100%;
            max-width: 800px;
            height: 400px;
            margin: 20px auto;
        }

        .side-panel {
            display: inline-block;
            width: 45%;
            vertical-align: top;
            margin: 10px;
            background: #f3f4f6;
            border-radius: 10px;
            padding: 15px;
        }

        .expression-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin: 10px 0;
        }

        /* Function Grapher styles */
        .grapher-container {
            padding: 20px;
        }

        .grapher-canvas {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            display: block;
            margin: 20px auto;
        }

        .slider-controls {
            background: #f3f4f6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .slider-group {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider-group label {
            min-width: 80px;
            font-weight: 600;
        }

        .slider-group input[type="range"] {
            flex: 1;
        }

        .slider-group .value-display {
            min-width: 60px;
            font-weight: 700;
            color: #667eea;
        }

        /* Quadratic visualizer styles */
        .quadratic-container {
            padding: 20px;
        }

        .form-selector {
            background: #f3f4f6;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .form-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .form-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .form-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* System of equations styles */
        .system-container {
            padding: 20px;
        }

        .equation-inputs {
            background: #f3f4f6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
        }

        .equation-row {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

        .equation-row input {
            width: 80px;
            padding: 8px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            font-weight: 600;
        }

        .equation-row span {
            font-weight: 600;
            font-size: 18px;
        }

        .solution-display {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            border-radius: 10px;
            padding: 15px;
            margin: 20px auto;
            max-width: 400px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üßÆ Interactive Math Manipulatives</h1>
            <p class="subtitle">Explore, visualize, and master mathematical concepts</p>
        </header>

        <div class="main-content">
            <aside class="sidebar" id="topic-sidebar">
                <div class="sidebar-toolbar">
                    <button type="button" class="btn btn-muted topics-toggle" id="topics-toggle" aria-expanded="true">Hide Topics</button>
                    <button type="button" class="btn btn-muted controls-toggle" id="controls-toggle" aria-expanded="true">Hide Controls</button>
                </div>
                <div id="topic-list">
                    <div class="tool-category">
                    <h3>Whole Numbers</h3>
                    <button class="manipulative-btn active" data-type="place-value">
                        <span class="icon">üß±</span>
                        <span>Place Value Blocks</span>
                    </button>
                    <button class="manipulative-btn" data-type="array">
                        <span class="icon">‚äû</span>
                        <span>Multiplication Array</span>
                    </button>
                    <button class="manipulative-btn" data-type="division">
                        <span class="icon">‚ûó</span>
                        <span>Division Groups</span>
                    </button>
                    <button class="manipulative-btn" data-type="numberline">
                        <span class="icon">üìè</span>
                        <span>Number Line</span>
                    </button>
                </div>

                <div class="tool-category">
                    <h3>Fractions</h3>
                    <button class="manipulative-btn" data-type="fractions">
                        <span class="icon">üçï</span>
                        <span>Fraction Bars</span>
                    </button>
                </div>

                <div class="tool-category">
                    <h3>Decimals</h3>
                    <button class="manipulative-btn" data-type="decimal-blocks">
                        <span class="icon">üî¢</span>
                        <span>Decimal Blocks</span>
                    </button>
                    <button class="manipulative-btn" data-type="decimal-line">
                        <span class="icon">üìê</span>
                        <span>Decimal Number Line</span>
                    </button>
                    <button class="manipulative-btn" data-type="percent-grid">
                        <span class="icon">üíØ</span>
                        <span>Percentage Grid</span>
                    </button>
                </div>

                <div class="tool-category">
                    <h3>Geometry</h3>
                    <button class="manipulative-btn" data-type="protractor">
                        <span class="icon">üìê</span>
                        <span>Protractor</span>
                    </button>
                    <button class="manipulative-btn" data-type="polygon">
                        <span class="icon">‚¨°</span>
                        <span>Polygon Builder</span>
                    </button>
                    <button class="manipulative-btn" data-type="coordinate">
                        <span class="icon">üìä</span>
                        <span>Coordinate Plane</span>
                    </button>
                    <button class="manipulative-btn" data-type="transform">
                        <span class="icon">üîÑ</span>
                        <span>Transformations</span>
                    </button>
                </div>

                <div class="tool-category">
                    <h3>Algebra</h3>
                    <button class="manipulative-btn" data-type="algebra-tiles">
                        <span class="icon">üü¶</span>
                        <span>Algebra Tiles</span>
                    </button>
                    <button class="manipulative-btn" data-type="balance">
                        <span class="icon">‚öñÔ∏è</span>
                        <span>Balance Scale</span>
                    </button>
                    <button class="manipulative-btn" data-type="function-graph">
                        <span class="icon">üìà</span>
                        <span>Function Grapher</span>
                    </button>
                    <button class="manipulative-btn" data-type="quadratic">
                        <span class="icon">üî¢</span>
                        <span>Quadratic Visualizer</span>
                    </button>
                    <button class="manipulative-btn" data-type="system">
                        <span class="icon">üìâ</span>
                        <span>System of Equations</span>
                    </button>
                </div>
                </div>
            </aside>

            <main class="workspace" id="workspace">
                <button class="expand-btn" id="expand-btn" onclick="toggleFullscreen()">‚õ∂ Expand</button>
                <div class="workspace-header">
                    <h2 class="workspace-title" id="workspace-title">Place Value Blocks</h2>
                    <div class="controls-wrapper">
                        <div class="controls" id="main-controls"></div>
                    </div>
                </div>

                <div class="instructions" id="instructions"></div>
                <div class="feedback" id="feedback"></div>
                <div class="step-guide" id="step-guide" aria-live="polite">
                    <h3 id="guide-title">Step-by-Step Guide</h3>
                    <div id="guide-content"></div>
                    <button type="button" class="toggle-guide" onclick="hideStepGuide()">Hide Guide</button>
                </div>

                <div class="canvas-container" id="canvas-container">
                    <canvas id="main-canvas" width="800" height="600"></canvas>
                </div>
            </main>
        </div>
    </div>

    <script>
        // ==================== STATE MANAGEMENT ====================
        const COLORS = {
            ones: '#3b82f6',
            tens: '#10b981',
            hundreds: '#f59e0b',
            thousands: '#ef4444',
            tenThousands: '#8b5cf6',
            fraction: '#8b5cf6',
            // Decimal colors
            tenths: '#06b6d4',
            hundredths: '#ec4899',
            thousandths: '#f97316'
        };

        let currentTool = null;
        let blocks = [];
        let dragging = null;
        let selectedIds = new Set();
        let selectionRect = null;

        // ==================== UTILITY FUNCTIONS ====================
        function showFeedback(message, type = 'info') {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.className = 'feedback show ' + type;
            setTimeout(() => {
                feedback.classList.remove('show');
            }, 3000);
        }

        function showStepGuide(title, steps) {
            const guide = document.getElementById('step-guide');
            const guideTitle = document.getElementById('guide-title');
            const guideContent = document.getElementById('guide-content');
            if (!guide || !guideTitle || !guideContent) {
                console.warn('Step guide container missing');
                return;
            }
            guideTitle.textContent = title;
            guideContent.innerHTML = '';

            steps.forEach((step, index) => {
                const stepItem = document.createElement('div');
                stepItem.className = 'step-item';
                
                const stepNumber = document.createElement('span');
                stepNumber.className = 'step-number';
                stepNumber.textContent = index + 1;
                
                const stepContent = document.createElement('div');
                stepContent.className = 'step-content';
                stepContent.innerHTML = step;
                
                stepItem.appendChild(stepNumber);
                stepItem.appendChild(stepContent);
                guideContent.appendChild(stepItem);
            });

            guide.classList.add('show');
            guide.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function hideStepGuide() {
            const guide = document.getElementById('step-guide');
            if (!guide) return;
            guide.classList.remove('show');
            const guideContent = document.getElementById('guide-content');
            if (guideContent) {
                guideContent.innerHTML = '';
            }
        }

        function clearWorkspace() {
            blocks = [];
            selectedIds.clear();
            dragging = null;
            selectionRect = null;
            const canvas = document.getElementById('main-canvas');
            if (canvas) {
                canvas.classList.remove('selecting');
            }
            hideStepGuide();
            renderCurrentTool();
        }

        // ==================== PLACE VALUE BLOCKS (ENHANCED) ====================
        const placeValueTool = {
            name: 'Place Value Blocks',
            instructions: 'Click blocks to select them (Shift+click to add more). Drag a selection to move it, or drag across open canvas (or Shift+drag from a block) to box-select multiple blocks at once. Double-click a block to break it into 10 smaller blocks. Use the minus or "Remove Selected" buttons to subtract blocks, and "Regroup Selected" to trade 10 smaller blocks for 1 larger block.',
            dragThreshold: 6,
            
            init() {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '<canvas id="main-canvas" width="800" height="600"></canvas>';
                
                const controls = document.getElementById('main-controls');
                controls.innerHTML = `
                    <button class="btn btn-primary" onclick="placeValueTool.addBlock(0)">+ Ones</button>
                    <button class="btn btn-warning" onclick="placeValueTool.removeBlock(0)">- Ones</button>
                    <button class="btn btn-primary" onclick="placeValueTool.addBlock(1)">+ Tens</button>
                    <button class="btn btn-warning" onclick="placeValueTool.removeBlock(1)">- Tens</button>
                    <button class="btn btn-primary" onclick="placeValueTool.addBlock(2)">+ Hundreds</button>
                    <button class="btn btn-warning" onclick="placeValueTool.removeBlock(2)">- Hundreds</button>
                    <button class="btn btn-primary" onclick="placeValueTool.addBlock(3)">+ Thousands</button>
                    <button class="btn btn-warning" onclick="placeValueTool.removeBlock(3)">- Thousands</button>
                    <button class="btn btn-secondary" onclick="placeValueTool.regroup()">Regroup Selected</button>
                    <button class="btn btn-info" onclick="placeValueTool.autoRegroup()">Auto Regroup</button>
                    <button class="btn btn-warning" onclick="placeValueTool.removeSelected()">Remove Selected</button>
                    <button class="btn btn-muted" onclick="placeValueTool.clearSelection()">Clear Selection</button>
                    <button class="btn btn-danger" onclick="clearWorkspace()">Clear All</button>
                `;
                
                this.setupCanvas();
                this.render();
            },

            setupCanvas() {
                const canvas = document.getElementById('main-canvas');
                if (this.boundHandleMouseUp) {
                    window.removeEventListener('mouseup', this.boundHandleMouseUp);
                }
                this.boundHandleMouseUp = this.handleMouseUp.bind(this);
                canvas.addEventListener('mousedown', this.handleMouseDown.bind(this));
                canvas.addEventListener('mousemove', this.handleMouseMove.bind(this));
                canvas.addEventListener('mouseup', this.boundHandleMouseUp);
                canvas.addEventListener('mouseleave', this.boundHandleMouseUp);
                canvas.addEventListener('dblclick', this.handleDoubleClick.bind(this));
                window.addEventListener('mouseup', this.boundHandleMouseUp);
            },

            addBlock(place, opts) {
                const options = opts || {};
                const baseX = 100 + place * 150;
                const stackCount = blocks.filter(b => b.place === place).length;
                const block = {
                    id: Date.now() + Math.random(),
                    place: place,
                    value: Math.pow(10, place),
                    x: baseX,
                    y: 50 + stackCount * 30,
                    color: this.getColorForPlace(place)
                };
                blocks.push(block);
                if (options.render !== false) {
                    this.render();
                }
                if (!options.silent) {
                    showFeedback(`Added ${block.value.toLocaleString()} block`, 'success');
                }
                return block;
            },

            removeBlock(place) {
                for (let i = blocks.length - 1; i >= 0; i--) {
                    if (blocks[i].place === place) {
                        const removed = blocks.splice(i, 1)[0];
                        if (removed) {
                            selectedIds.delete(removed.id);
                            this.render();
                            showFeedback(`Removed ${removed.value.toLocaleString()} block`, 'info');
                            return;
                        }
                    }
                }
                showFeedback('No blocks of that place value to remove', 'error');
            },

            removeSelected() {
                if (selectedIds.size === 0) {
                    showFeedback('Select blocks to remove first', 'error');
                    return;
                }
                const before = blocks.length;
                blocks = blocks.filter(block => !selectedIds.has(block.id));
                const removedCount = before - blocks.length;
                selectedIds.clear();
                this.render();
                showFeedback(`Removed ${removedCount} block${removedCount === 1 ? '' : 's'}`, 'success');
            },

            clearSelection() {
                if (selectedIds.size === 0) return;
                selectedIds.clear();
                this.render();
                showFeedback('Selection cleared', 'info');
            },

            getColorForPlace(place) {
                const colors = [COLORS.ones, COLORS.tens, COLORS.hundreds, COLORS.thousands, COLORS.tenThousands];
                return colors[place] || '#6b7280';
            },

            getBlockDimensions(place) {
                const sizes = [
                    { w: 20, h: 20 },    // ones
                    { w: 80, h: 20 },    // tens
                    { w: 80, h: 80 },    // hundreds
                    { w: 100, h: 100 },  // thousands
                    { w: 120, h: 120 }   // ten thousands
                ];
                return sizes[place] || { w: 20, h: 20 };
            },

            render() {
                const canvas = document.getElementById('main-canvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                blocks.forEach(block => {
                    const dim = this.getBlockDimensions(block.place);
                    
                    ctx.fillStyle = block.color;
                    ctx.fillRect(block.x, block.y, dim.w, dim.h);
                    
                    ctx.strokeStyle = selectedIds.has(block.id) ? '#ef4444' : '#1f2937';
                    ctx.lineWidth = selectedIds.has(block.id) ? 3 : 2;
                    ctx.strokeRect(block.x, block.y, dim.w, dim.h);

                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 14px system-ui';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(block.value.toLocaleString(), block.x + dim.w/2, block.y + dim.h/2);
                });

                // Show selection count
                if (selectedIds.size > 0) {
                    ctx.fillStyle = 'rgba(102, 126, 234, 0.9)';
                    ctx.fillRect(10, 10, 180, 40);
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 16px system-ui';
                    ctx.textAlign = 'left';
                    ctx.fillText(`Selected: ${selectedIds.size}`, 20, 30);
                }

                if (selectionRect && selectionRect.active) {
                    const { x, y, w, h } = this.getSelectionRectBounds(selectionRect);
                    ctx.save();
                    ctx.strokeStyle = '#2563eb';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([6, 3]);
                    ctx.strokeRect(x, y, w, h);
                    ctx.fillStyle = 'rgba(37, 99, 235, 0.15)';
                    ctx.fillRect(x, y, w, h);
                    ctx.restore();
                }
            },

            handleMouseDown(e) {
                const canvas = document.getElementById('main-canvas');
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const clicked = this.getBlockAt(x, y);
                if (!clicked) {
                    const baseSelection = new Set(selectedIds);
                    selectionRect = {
                        startX: x,
                        startY: y,
                        currentX: x,
                        currentY: y,
                        active: true,
                        additive: e.shiftKey,
                        baseSelection
                    };
                    if (!selectionRect.additive) {
                        selectedIds.clear();
                    }
                    canvas.classList.add('selecting');
                    dragging = { mode: 'marquee' };
                    this.render();
                    return;
                }

                const wasSelected = selectedIds.has(clicked.id);

                if (e.shiftKey) {
                    dragging = {
                        mode: 'pending-toggle',
                        block: clicked,
                        startX: x,
                        startY: y,
                        baseSelection: new Set(selectedIds),
                        wasSelected
                    };
                    return;
                }

                if (!wasSelected) {
                    selectedIds.clear();
                    selectedIds.add(clicked.id);
                    this.render();
                }

                if (selectedIds.size > 1) {
                    const group = Array.from(selectedIds).map(id => {
                        const blockRef = blocks.find(b => b.id === id);
                        return {
                            id,
                            block: blockRef,
                            startX: blockRef ? blockRef.x : 0,
                            startY: blockRef ? blockRef.y : 0
                        };
                    }).filter(item => item.block);
                    dragging = {
                        mode: 'group',
                        startX: x,
                        startY: y,
                        group
                    };
                } else if (selectedIds.has(clicked.id)) {
                    dragging = {
                        mode: 'single',
                        block: clicked,
                        offsetX: x - clicked.x,
                        offsetY: y - clicked.y,
                        startX: x,
                        startY: y,
                        allowMarquee: e.altKey || e.ctrlKey || e.metaKey,
                        baseSelection: new Set(selectedIds)
                    };
                } else {
                    dragging = null;
                }
            },

            handleMouseMove(e) {
                if (!dragging) return;
                const canvas = document.getElementById('main-canvas');
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const dx = dragging.startX !== undefined ? x - dragging.startX : 0;
                const dy = dragging.startY !== undefined ? y - dragging.startY : 0;

                if (dragging.mode === 'pending-toggle') {
                    if (Math.abs(dx) > this.dragThreshold || Math.abs(dy) > this.dragThreshold) {
                        selectionRect = {
                            startX: dragging.startX,
                            startY: dragging.startY,
                            currentX: x,
                            currentY: y,
                            active: true,
                            additive: true,
                            baseSelection: dragging.baseSelection
                        };
                        selectedIds = new Set(dragging.baseSelection);
                        canvas.classList.add('selecting');
                        dragging = { mode: 'marquee' };
                        this.updateSelectionFromRect(selectionRect);
                        this.render();
                    }
                    return;
                }

                if (dragging.mode === 'marquee' && selectionRect && selectionRect.active) {
                    selectionRect.currentX = x;
                    selectionRect.currentY = y;
                    this.updateSelectionFromRect(selectionRect);
                    this.render();
                    return;
                }

                if (dragging.mode === 'group') {
                    dragging.group.forEach(item => {
                        item.block.x = item.startX + dx;
                        item.block.y = item.startY + dy;
                    });
                } else if (dragging.mode === 'single') {
                    if (dragging.allowMarquee && (Math.abs(dx) > this.dragThreshold || Math.abs(dy) > this.dragThreshold)) {
                        const baseSelection = new Set(dragging.baseSelection || selectedIds);
                        const additive = e.shiftKey || e.ctrlKey || e.metaKey || e.altKey;
                        selectionRect = {
                            startX: dragging.startX,
                            startY: dragging.startY,
                            currentX: x,
                            currentY: y,
                            active: true,
                            additive,
                            baseSelection
                        };
                        if (additive) {
                            selectedIds = baseSelection;
                        } else {
                            selectedIds.clear();
                        }
                        canvas.classList.add('selecting');
                        dragging = { mode: 'marquee' };
                        this.updateSelectionFromRect(selectionRect);
                        this.render();
                        return;
                    }
                    dragging.block.x = x - dragging.offsetX;
                    dragging.block.y = y - dragging.offsetY;
                }
                this.render();
            },

            handleMouseUp(e) {
                const canvas = document.getElementById('main-canvas');
                if (dragging && dragging.mode === 'pending-toggle' && dragging.block) {
                    if (dragging.wasSelected) {
                        selectedIds.delete(dragging.block.id);
                    } else {
                        selectedIds.add(dragging.block.id);
                    }
                    this.render();
                }
                if (selectionRect && selectionRect.active) {
                    this.updateSelectionFromRect(selectionRect, true);
                    selectionRect = null;
                    if (canvas) {
                        canvas.classList.remove('selecting');
                    }
                    this.render();
                }
                dragging = null;
            },

            handleDoubleClick(e) {
                const canvas = document.getElementById('main-canvas');
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const clicked = this.getBlockAt(x, y);
                if (clicked && clicked.place > 0) {
                    const newPlace = clicked.place - 1;
                    const idx = blocks.indexOf(clicked);
                    blocks.splice(idx, 1);
                    
                    for (let i = 0; i < 10; i++) {
                        blocks.push({
                            id: Date.now() + Math.random() + i,
                            place: newPlace,
                            value: Math.pow(10, newPlace),
                            x: clicked.x + (i % 5) * 25,
                            y: clicked.y + Math.floor(i / 5) * 25,
                            color: this.getColorForPlace(newPlace)
                        });
                    }
                    this.render();
                    showFeedback(`Broke ${clicked.value.toLocaleString()} into 10 √ó ${Math.pow(10, newPlace).toLocaleString()}`, 'info');
                }
            },

            getBlockAt(x, y) {
                for (let i = blocks.length - 1; i >= 0; i--) {
                    const block = blocks[i];
                    const dim = this.getBlockDimensions(block.place);
                    if (x >= block.x && x <= block.x + dim.w &&
                        y >= block.y && y <= block.y + dim.h) {
                        return block;
                    }
                }
                return null;
            },

            getSelectionRectBounds(rectState) {
                const startX = rectState.startX;
                const startY = rectState.startY;
                const endX = rectState.currentX;
                const endY = rectState.currentY;
                const x = Math.min(startX, endX);
                const y = Math.min(startY, endY);
                const w = Math.abs(startX - endX);
                const h = Math.abs(startY - endY);
                return { x, y, w, h };
            },

            updateSelectionFromRect(rectState, finalize = false) {
                const { x, y, w, h } = this.getSelectionRectBounds(rectState);
                const hits = new Set();

                if (w === 0 && h === 0 && finalize) {
                    if (!rectState.additive) {
                        selectedIds.clear();
                    } else {
                        selectedIds = new Set(rectState.baseSelection);
                    }
                    return;
                }

                blocks.forEach(block => {
                    const dim = this.getBlockDimensions(block.place);
                    const bx1 = block.x;
                    const by1 = block.y;
                    const bx2 = block.x + dim.w;
                    const by2 = block.y + dim.h;
                    const intersects = !(bx2 < x || bx1 > x + w || by2 < y || by1 > y + h);
                    if (intersects) {
                        hits.add(block.id);
                    }
                });

                if (rectState.additive) {
                    selectedIds = new Set([...rectState.baseSelection, ...hits]);
                } else {
                    selectedIds = hits;
                }
            },

            regroup() {
                const selected = Array.from(selectedIds).map(id => blocks.find(b => b.id === id)).filter(Boolean);
                if (selected.length < 10) {
                    showFeedback('Select at least 10 blocks of the same place value', 'error');
                    return;
                }

                const placeBuckets = {};
                selected.forEach(block => {
                    if (!placeBuckets[block.place]) placeBuckets[block.place] = [];
                    placeBuckets[block.place].push(block);
                });

                const placeNames = ['ones', 'tens', 'hundreds', 'thousands', 'ten-thousands', 'hundred-thousands'];
                let regrouped = false;

                for (const placeKey in placeBuckets) {
                    const place = parseInt(placeKey, 10);
                    const blocksAtPlace = placeBuckets[place];
                    const bundleCount = Math.floor(blocksAtPlace.length / 10);
                    if (bundleCount <= 0) continue;

                    const fromValue = Math.pow(10, place);
                    const toValue = Math.pow(10, place + 1);
                    const placeName = placeNames[place] || 'blocks';
                    const nextPlaceName = placeNames[place + 1] || 'next place';
                    const singularNext = nextPlaceName.endsWith('s') ? nextPlaceName.slice(0, -1) : nextPlaceName;

                    showStepGuide('How to Regroup', [
                        `<strong>Step 1: Identify what you have</strong><br>You selected <span class="step-highlight">${bundleCount * 10} ${placeName}</span>.`,
                        `<strong>Step 2: Understand regrouping</strong><br>Every <span class="step-highlight">10 ${placeName}</span> becomes 1 ${singularNext}.`,
                        `<strong>Step 3: Trade the blocks</strong><br>Trade each bundle of 10 ${placeName} for a single ${singularNext}.`,
                        `<strong>Step 4: Verify</strong><br>${(10 * fromValue).toLocaleString()} stays equal to ${toValue.toLocaleString()} for every trade.`
                    ]);

                    const removable = blocksAtPlace.slice();
                    for (let bundleIndex = 0; bundleIndex < bundleCount; bundleIndex++) {
                        const toConvert = removable.splice(0, 10);
                        toConvert.forEach(block => {
                            const idx = blocks.indexOf(block);
                            if (idx >= 0) {
                                blocks.splice(idx, 1);
                                selectedIds.delete(block.id);
                            }
                        });
                        this.addBlock(place + 1, { silent: true, render: false });
                    }

                    this.render();
                    showFeedback(`Regrouped ${bundleCount * 10} ${placeName} into ${bundleCount} ${singularNext}${bundleCount > 1 ? 's' : ''}.`, 'success');
                    regrouped = true;
                    break;
                }

                if (!regrouped) {
                    showFeedback('Need 10 blocks of the same place value', 'error');
                }
            },

            autoRegroup() {
                const placeNames = ['ones', 'tens', 'hundreds', 'thousands', 'ten-thousands', 'hundred-thousands'];
                const actions = [];

                while (true) {
                    const counts = {};
                    blocks.forEach(b => {
                        counts[b.place] = (counts[b.place] || 0) + 1;
                    });

                    let converted = false;
                    const orderedPlaces = Object.keys(counts).map(p => parseInt(p, 10)).sort((a, b) => a - b);
                    for (const place of orderedPlaces) {
                        if (counts[place] >= 10) {
                            const candidates = [];
                            for (let i = 0; i < blocks.length && candidates.length < 10; i++) {
                                if (blocks[i].place === place) {
                                    candidates.push(blocks[i]);
                                }
                            }
                            candidates.forEach(block => {
                                const idx = blocks.indexOf(block);
                                if (idx >= 0) {
                                    blocks.splice(idx, 1);
                                    selectedIds.delete(block.id);
                                }
                            });
                            this.addBlock(place + 1, { silent: true, render: false });
                            actions.push({ from: place, to: place + 1 });
                            converted = true;
                            break;
                        }
                    }
                    if (!converted) {
                        break;
                    }
                }

                if (actions.length) {
                    this.render();
                    const summary = actions.map(action => {
                        const fromName = placeNames[action.from] || `10^${action.from}`;
                        const toName = placeNames[action.to] || `10^${action.to}`;
                        return `${fromName} ‚Üí ${toName}`;
                    }).join(', ');
                    showFeedback(`Auto-regroup complete: ${summary}.`, 'success');
                } else {
                    showFeedback('No place value has 10+ blocks to regroup', 'info');
                }
            }
        };

        // ==================== FRACTIONS (ENHANCED WITH OPERATIONS) ====================
        const fractionsTool = {
            name: 'Fraction Bars',
            instructions: 'Click segments to fill them. Select an operation, then click "Calculate" to see the result. Works with addition, subtraction, multiplication, and division.',
            currentDenominator: 8,
            bars: [],
            operation: 'add',

            init() {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '<div class="fraction-container" id="fraction-workspace"></div>';
                
                const controls = document.getElementById('main-controls');
                controls.innerHTML = `
                    <label>Denominator: 
                        <input type="number" id="denom-input" class="fraction-input" value="8" min="2" max="20" onchange="fractionsTool.updateDenominator()">
                    </label>
                    <button class="btn btn-primary" onclick="fractionsTool.addBar()">+ Add Bar</button>
                    <button class="btn btn-secondary" onclick="fractionsTool.calculate()">Calculate</button>
                    <button class="btn btn-danger" onclick="fractionsTool.clear()">Clear</button>
                `;

                this.clear();
                this.addBar();
                this.addBar();
            },

            updateDenominator() {
                const input = document.getElementById('denom-input');
                this.currentDenominator = Math.max(2, Math.min(20, parseInt(input.value) || 8));
                input.value = this.currentDenominator;
                this.render();
            },

            addBar() {
                this.bars.push({
                    id: Date.now() + Math.random(),
                    denominator: this.currentDenominator,
                    filled: []
                });
                this.render();
            },

            clear() {
                this.bars = [];
                this.render();
            },

            render() {
                const workspace = document.getElementById('fraction-workspace');
                workspace.innerHTML = '';

                // Operation selector
                const opSelector = document.createElement('div');
                opSelector.className = 'fraction-operation-selector';
                opSelector.innerHTML = `
                    <label for="op-select">Operation:</label>
                    <select id="op-select" onchange="fractionsTool.operation = this.value">
                        <option value="add" ${this.operation === 'add' ? 'selected' : ''}>Addition (+)</option>
                        <option value="subtract" ${this.operation === 'subtract' ? 'selected' : ''}>Subtraction (‚àí)</option>
                        <option value="multiply" ${this.operation === 'multiply' ? 'selected' : ''}>Multiplication (√ó)</option>
                        <option value="divide" ${this.operation === 'divide' ? 'selected' : ''}>Division (√∑)</option>
                    </select>
                `;
                workspace.appendChild(opSelector);

                this.bars.forEach((bar, barIdx) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'fraction-bar-wrapper';

                    const label = document.createElement('div');
                    label.className = 'fraction-label';
                    label.textContent = `Fraction ${barIdx + 1}: ${bar.filled.length}/${bar.denominator}`;
                    wrapper.appendChild(label);

                    const grid = document.createElement('div');
                    grid.className = 'fraction-bar';
                    grid.style.gridTemplateColumns = `repeat(${bar.denominator}, 1fr)`;

                    for (let i = 0; i < bar.denominator; i++) {
                        const segment = document.createElement('div');
                        segment.className = 'fraction-segment';
                        if (bar.filled.includes(i)) {
                            segment.classList.add('filled');
                        }
                        segment.addEventListener('click', () => {
                            if (bar.filled.includes(i)) {
                                bar.filled = bar.filled.filter(x => x !== i);
                            } else {
                                bar.filled.push(i);
                                bar.filled.sort((a, b) => a - b);
                            }
                            this.render();
                        });
                        grid.appendChild(segment);
                    }

                    wrapper.appendChild(grid);

                    const controls = document.createElement('div');
                    controls.className = 'fraction-controls';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'btn btn-danger';
                    removeBtn.textContent = 'Remove';
                    removeBtn.addEventListener('click', () => {
                        this.bars.splice(barIdx, 1);
                        this.render();
                    });
                    controls.appendChild(removeBtn);

                    wrapper.appendChild(controls);
                    workspace.appendChild(wrapper);
                });
            },

            gcd(a, b) {
                a = Math.abs(a);
                b = Math.abs(b);
                while (b) {
                    const t = b;
                    b = a % b;
                    a = t;
                }
                return a || 1;
            },

            simplifyFraction(num, den) {
                if (den === 0) return { num: 0, den: 1 };
                const g = this.gcd(num, den);
                return { num: num / g, den: den / g };
            },

            calculate() {
                if (this.bars.length < 2) {
                    showFeedback('Add at least 2 fraction bars!', 'error');
                    return;
                }

                const fractions = this.bars.map(bar => ({
                    num: bar.filled.length,
                    den: bar.denominator
                }));

                let result;
                const f1 = fractions[0];
                const f2 = fractions[1];

                if (this.operation === 'divide' && f2.num === 0) {
                    showFeedback('Cannot divide by zero!', 'error');
                    return;
                }

                switch (this.operation) {
                    case 'add':
                        result = this.addFractions(f1, f2);
                        this.showAdditionSteps(f1, f2, result);
                        break;
                    case 'subtract':
                        result = this.subtractFractions(f1, f2);
                        this.showSubtractionSteps(f1, f2, result);
                        break;
                    case 'multiply':
                        result = this.multiplyFractions(f1, f2);
                        this.showMultiplicationSteps(f1, f2, result);
                        break;
                    case 'divide':
                        result = this.divideFractions(f1, f2);
                        this.showDivisionSteps(f1, f2, result);
                        break;
                }
                
                showFeedback('Steps ready! Use the guide to finish the fraction yourself.', 'info');
            },

            showAdditionSteps(f1, f2, result) {
                const steps = [];
                
                steps.push(`<strong>Problem:</strong> ${f1.num}/${f1.den} + ${f2.num}/${f2.den}`);
                
                if (f1.den === f2.den) {
                    steps.push(
                        `<strong>Step 1: Check denominators</strong><br>Both fractions have the same denominator (${f1.den}), so you can add the numerators right away.`
                    );
                    steps.push(
                        `<strong>Step 2: Add the numerators</strong><br><div class="step-visual">${f1.num} + ${f2.num} = <input type="text" class="step-input" placeholder="?" aria-label="Sum the numerators"></div>Keep the denominator ${f1.den} the same.`
                    );
                } else {
                    steps.push(
                        `<strong>Step 1: Find a common denominator</strong><br><div class="step-visual">${f1.den} √ó ${f2.den} = <input type="text" class="step-input" placeholder="?" aria-label="Common denominator"></div>`
                    );
                    steps.push(
                        `<strong>Step 2: Build equivalent fractions</strong><br>` +
                        `<div class="step-visual">${f1.num} √ó ${f2.den} = <input type="text" class="step-input" placeholder="?" aria-label="New numerator for the first fraction"></div>` +
                        `<div class="step-visual">${f2.num} √ó ${f1.den} = <input type="text" class="step-input" placeholder="?" aria-label="New numerator for the second fraction"></div>` +
                        `Use the denominator from Step 1 under both new numerators.`
                    );
                    steps.push(
                        `<strong>Step 3: Add the new numerators</strong><br><div class="step-visual">(${f1.num} √ó ${f2.den}) + (${f2.num} √ó ${f1.den}) = <input type="text" class="step-input" placeholder="?" aria-label="Sum of the new numerators"></div>Place that total over your common denominator.`
                    );
                }
                
                steps.push(
                    `<strong>Step 4: Simplify</strong><br>Look for a common factor greater than 1 and divide the numerator and denominator by it to reduce the fraction.`
                );
                
                showStepGuide('Adding Fractions', steps);
            },

            showSubtractionSteps(f1, f2, result) {
                const steps = [];
                
                steps.push(`<strong>Problem:</strong> ${f1.num}/${f1.den} - ${f2.num}/${f2.den}`);
                
                if (f1.den === f2.den) {
                    steps.push(
                        `<strong>Step 1: Check denominators</strong><br>Both fractions have the same denominator (${f1.den}), so you can subtract the numerators directly.`
                    );
                    steps.push(
                        `<strong>Step 2: Subtract the numerators</strong><br><div class="step-visual">${f1.num} - ${f2.num} = <input type="text" class="step-input" placeholder="?" aria-label="Subtract the numerators"></div>Keep the denominator ${f1.den} the same.`
                    );
                } else {
                    steps.push(
                        `<strong>Step 1: Find a common denominator</strong><br><div class="step-visual">${f1.den} √ó ${f2.den} = <input type="text" class="step-input" placeholder="?" aria-label="Common denominator"></div>`
                    );
                    steps.push(
                        `<strong>Step 2: Build equivalent fractions</strong><br>` +
                        `<div class="step-visual">${f1.num} √ó ${f2.den} = <input type="text" class="step-input" placeholder="?" aria-label="New numerator for the first fraction"></div>` +
                        `<div class="step-visual">${f2.num} √ó ${f1.den} = <input type="text" class="step-input" placeholder="?" aria-label="New numerator for the second fraction"></div>` +
                        `Keep the denominator from Step 1 under each numerator.`
                    );
                    steps.push(
                        `<strong>Step 3: Subtract the new numerators</strong><br><div class="step-visual">(${f1.num} √ó ${f2.den}) - (${f2.num} √ó ${f1.den}) = <input type="text" class="step-input" placeholder="?" aria-label="Difference of the new numerators"></div>Place that difference over your common denominator.`
                    );
                }
                
                steps.push(
                    `<strong>Step 4: Simplify</strong><br>Look for a common factor greater than 1. Divide the numerator and denominator by that factor to reduce the fraction if possible.`
                );
                
                showStepGuide('Subtracting Fractions', steps);
            },

            showMultiplicationSteps(f1, f2, result) {
                const steps = [
                    `<strong>Problem:</strong> ${f1.num}/${f1.den} √ó ${f2.num}/${f2.den}`,
                    `<strong>Step 1: Multiply numerators together</strong><br><div class="step-visual">${f1.num} √ó ${f2.num} = <input type="text" class="step-input" placeholder="?" aria-label="Product of the numerators"></div>`,
                    `<strong>Step 2: Multiply denominators together</strong><br><div class="step-visual">${f1.den} √ó ${f2.den} = <input type="text" class="step-input" placeholder="?" aria-label="Product of the denominators"></div>`,
                    `<strong>Step 3: Write the result</strong><br>Use the answer from Step 1 as your new numerator and the answer from Step 2 as your new denominator.`
                ];
                
                steps.push(
                    `<strong>Step 4: Simplify</strong><br>Look for any common factor (2, 3, 5, etc.) shared by the numerator and denominator and divide both by that value.`
                );
                
                showStepGuide('Multiplying Fractions', steps);
            },

            showDivisionSteps(f1, f2, result) {
                if (f2.num === 0) {
                    showFeedback('Cannot divide by zero!', 'error');
                    return;
                }
                
                const steps = [
                    `<strong>Problem:</strong> ${f1.num}/${f1.den} √∑ ${f2.num}/${f2.den}`,
                    `<strong>Step 1: Keep, Change, Flip</strong><br>` +
                    `Keep the first fraction: ${f1.num}/${f1.den}<br>` +
                    `Change √∑ to √ó<br>` +
                    `Flip the second fraction:<div class="step-visual">${f2.num}/${f2.den} ‚Üí <input type="text" class="step-input" placeholder="?" aria-label="New numerator after flipping"> / <input type="text" class="step-input" placeholder="?" aria-label="New denominator after flipping"></div>`,
                    `<strong>Step 2: Rewrite as multiplication</strong><br>Write ${f1.num}/${f1.den} √ó (your flipped fraction from Step 1).`,
                    `<strong>Step 3: Multiply numerators and denominators</strong><br>` +
                    `<div class="step-visual">${f1.num} √ó ${f2.den} = <input type="text" class="step-input" placeholder="?" aria-label="Product of numerators after flipping"></div>` +
                    `<div class="step-visual">${f1.den} √ó ${f2.num} = <input type="text" class="step-input" placeholder="?" aria-label="Product of denominators after flipping"></div>`
                ];
                
                steps.push(
                    `<strong>Step 4: Simplify</strong><br>Look for a common factor shared by the numerator and denominator and divide both numbers by it to reduce the fraction.`
                );
                
                showStepGuide('Dividing Fractions', steps);
            },

            addFractions(f1, f2) {
                const den = f1.den * f2.den;
                const num = f1.num * f2.den + f2.num * f1.den;
                return this.simplifyFraction(num, den);
            },

            subtractFractions(f1, f2) {
                const den = f1.den * f2.den;
                const num = f1.num * f2.den - f2.num * f1.den;
                return this.simplifyFraction(num, den);
            },

            multiplyFractions(f1, f2) {
                const num = f1.num * f2.num;
                const den = f1.den * f2.den;
                return this.simplifyFraction(num, den);
            },

            divideFractions(f1, f2) {
                const num = f1.num * f2.den;
                const den = f1.den * f2.num;
                return this.simplifyFraction(num, den);
            }
        };

        // ==================== MULTIPLICATION ARRAY (WITH DRAG SELECT) ====================
        const arrayTool = {
            name: 'Multiplication Array',
            instructions: 'Click and drag to select multiple cells. Build arrays to visualize multiplication. Use "Check Product" to verify or enter larger problems to see the place-value breakdown.',
            rows: 5,
            cols: 6,
            activeCells: new Set(),
            isSelecting: false,
            selectionStart: null,

            init() {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '<div style="text-align:center; padding:20px; position: relative;" id="array-workspace"></div>';
                
                const controls = document.getElementById('main-controls');
                controls.innerHTML = `
                    <label>Rows: 
                        <input type="number" id="rows-input" class="fraction-input" value="5" min="1" max="30" onchange="arrayTool.updateDimensions()">
                    </label>
                    <label>Cols: 
                        <input type="number" id="cols-input" class="fraction-input" value="6" min="1" max="30" onchange="arrayTool.updateDimensions()">
                    </label>
                    <label>Manual Problem:
                        <input type="text" id="array-product-input" class="fraction-input" placeholder="e.g. 507x8" aria-label="Enter a multiplication problem to break apart" style="width: 130px;">
                    </label>
                    <button class="btn btn-secondary" onclick="arrayTool.checkProduct()">Check Product</button>
                    <button class="btn btn-danger" onclick="arrayTool.clear()">Clear</button>
                `;

                this.render();
            },

            updateDimensions() {
                const limit = 30;
                this.rows = Math.max(1, Math.min(limit, parseInt(document.getElementById('rows-input').value) || 5));
                this.cols = Math.max(1, Math.min(limit, parseInt(document.getElementById('cols-input').value) || 6));
                document.getElementById('rows-input').value = this.rows;
                document.getElementById('cols-input').value = this.cols;
                this.activeCells.clear();
                this.render();
            },

            clear() {
                this.activeCells.clear();
                this.render();
            },

            render() {
                const workspace = document.getElementById('array-workspace');
                
                const grid = document.createElement('div');
                grid.className = 'array-grid';
                grid.id = 'array-grid';
                const maxDimension = Math.max(this.rows, this.cols);
                const viewportWidth = typeof window !== 'undefined' ? window.innerWidth : 1200;
                const maxGridWidth = Math.min(560, Math.max(260, viewportWidth - 140));
                const gap = maxDimension > 20 ? 2 : 3;
                const rawSize = Math.floor((maxGridWidth - gap * (maxDimension - 1)) / maxDimension);
                const cellSize = Math.max(12, Math.min(48, rawSize || 16));
                grid.style.gridTemplateColumns = `repeat(${this.cols}, ${cellSize}px)`;
                grid.style.setProperty('--array-cell-size', `${cellSize}px`);
                grid.style.gap = `${gap}px`;

                for (let r = 0; r < this.rows; r++) {
                    for (let c = 0; c < this.cols; c++) {
                        const cell = document.createElement('div');
                        cell.className = 'array-cell';
                        cell.dataset.row = r;
                        cell.dataset.col = c;
                        const key = `${r}-${c}`;
                        
                        if (this.activeCells.has(key)) {
                            cell.classList.add('active');
                        }

                        grid.appendChild(cell);
                    }
                }

                // Add event listeners for drag selection
                grid.addEventListener('mousedown', (e) => this.startSelection(e));
                grid.addEventListener('mousemove', (e) => this.updateSelection(e));
                grid.addEventListener('mouseup', (e) => this.endSelection(e));
                grid.addEventListener('mouseleave', (e) => this.endSelection(e));

                const info = document.createElement('div');
                info.className = 'array-info';
                const totalCells = this.rows * this.cols;
                info.textContent = `${this.rows} x ${this.cols} array (${totalCells} cells) | Active: ${this.activeCells.size}`;

                workspace.innerHTML = '';
                workspace.appendChild(grid);
                workspace.appendChild(info);
            },

            startSelection(e) {
                if (e.target.classList.contains('array-cell')) {
                    this.isSelecting = true;
                    const row = parseInt(e.target.dataset.row);
                    const col = parseInt(e.target.dataset.col);
                    this.selectionStart = { row, col };
                    
                    // Toggle the starting cell
                    const key = `${row}-${col}`;
                    if (this.activeCells.has(key)) {
                        this.activeCells.delete(key);
                        this.selectingMode = 'remove';
                    } else {
                        this.activeCells.add(key);
                        this.selectingMode = 'add';
                    }
                    this.render();
                }
            },

            updateSelection(e) {
                if (!this.isSelecting || !this.selectionStart) return;
                
                if (e.target.classList.contains('array-cell')) {
                    const endRow = parseInt(e.target.dataset.row);
                    const endCol = parseInt(e.target.dataset.col);
                    
                    const minRow = Math.min(this.selectionStart.row, endRow);
                    const maxRow = Math.max(this.selectionStart.row, endRow);
                    const minCol = Math.min(this.selectionStart.col, endCol);
                    const maxCol = Math.max(this.selectionStart.col, endCol);

                    // Apply selection mode to all cells in rectangle
                    for (let r = minRow; r <= maxRow; r++) {
                        for (let c = minCol; c <= maxCol; c++) {
                            const key = `${r}-${c}`;
                            if (this.selectingMode === 'add') {
                                this.activeCells.add(key);
                            } else {
                                this.activeCells.delete(key);
                            }
                        }
                    }
                    this.render();
                }
            },

            endSelection(e) {
                this.isSelecting = false;
                this.selectionStart = null;
            },

            parseManualProblem(value) {
                if (!value) return null;
                const normalized = value
                    .toLowerCase()
                    .replace(/√ó|‚ãÖ|¬∑|\*/g, 'x')
                    .replace(/\s+/g, '');
                const match = normalized.match(/^(\d{1,6})x(\d{1,6})$/);
                if (!match) return null;
                const first = parseInt(match[1], 10);
                const second = parseInt(match[2], 10);
                if (!Number.isFinite(first) || !Number.isFinite(second) || first <= 0 || second <= 0) {
                    return null;
                }
                return { first, second };
            },

            expandPlaceValues(value) {
                const digits = value.toString();
                const parts = [];
                for (let i = 0; i < digits.length; i++) {
                    const digit = parseInt(digits[i], 10);
                    if (!digit) continue;
                    const zeros = digits.length - i - 1;
                    parts.push({
                        base: digit,
                        zeros,
                        value: digit * Math.pow(10, zeros)
                    });
                }
                return parts.length ? parts : [{ base: value, zeros: 0, value }];
            },

            showManualMultiplicationSteps(first, second) {
                const leftParts = this.expandPlaceValues(first);
                const rightParts = this.expandPlaceValues(second);
                const leftBreak = leftParts.map(p => p.value).join(' + ');
                const rightBreak = rightParts.map(p => p.value).join(' + ');
                const combos = [];
                leftParts.forEach(lp => {
                    rightParts.forEach(rp => {
                        const baseProduct = lp.base * rp.base;
                        const zeros = lp.zeros + rp.zeros;
                        const finalValue = lp.value * rp.value;
                        combos.push({
                            leftValue: lp.value,
                            rightValue: rp.value,
                            leftDigit: lp.base,
                            rightDigit: rp.base,
                            zeros,
                            baseProduct,
                            finalValue
                        });
                    });
                });
                const total = combos.reduce((sum, combo) => sum + combo.finalValue, 0);
                const partialList = combos.map(combo => combo.finalValue.toLocaleString()).join(' + ');
                const runningBreakdown = [];
                let runningSum = 0;
                combos.forEach((combo, idx) => {
                    runningSum += combo.finalValue;
                    const expression = combos
                        .slice(0, idx + 1)
                        .map(part => part.finalValue.toLocaleString())
                        .join(' + ');
                    runningBreakdown.push({ expression, total: runningSum });
                });

                const multiplyBlocks = combos.map(combo => {
                    const zeroText = combo.zeros === 0
                        ? 'No zeros to add'
                        : `Add ${combo.zeros} zero${combo.zeros === 1 ? '' : 's'}`;
                    return `<div class="step-visual">‚Ä¢ ${combo.leftValue.toLocaleString()} √ó ${combo.rightValue.toLocaleString()}<br>${combo.leftDigit} √ó ${combo.rightDigit} = ${combo.baseProduct}<br>${zeroText} ‚Üí ${combo.finalValue.toLocaleString()}</div>`;
                }).join('');

                const runningText = runningBreakdown.map((entry, idx) => {
                    return `<div class="step-visual">Partial sum ${idx + 1}: ${entry.expression} = ${entry.total.toLocaleString()}</div>`;
                }).join('');

                const steps = [
                    `<strong>Problem:</strong> ${first} √ó ${second}`,
                    `<strong>Step 1 ‚Äî Break the factors into friendly parts</strong><br>${first} = ${leftBreak}<br>${second} = ${rightBreak}<br>So <span class="step-highlight">(${leftBreak})(${rightBreak})</span>`,
                    `<strong>Step 2 ‚Äî Multiply each part (area model / box method)</strong>${multiplyBlocks}`,
                    `<strong>Step 3 ‚Äî Add all partial products</strong><br><div class="step-visual">${partialList}</div>${runningText}`,
                    `<strong>Final Answer</strong><br>${first} √ó ${second} = ${total.toLocaleString()}`,
                    `<em>Distributive check:</em> (${leftBreak})(${rightBreak}) = ${combos.map(combo => `${combo.leftValue.toLocaleString()} √ó ${combo.rightValue.toLocaleString()}`).join(' + ')}`
                ];

                showStepGuide('Multiplication by Place Value', steps);
            },

            checkProduct() {
                const manualField = document.getElementById('array-product-input');
                const manualValue = manualField ? manualField.value.trim() : '';
                if (manualValue) {
                    const parsed = this.parseManualProblem(manualValue);
                    if (!parsed) {
                        showFeedback('Enter a multiplication problem like 507x8 using only numbers.', 'error');
                        return;
                    }
                    this.showManualMultiplicationSteps(parsed.first, parsed.second);
                    showFeedback('Follow the guide to fill each step before writing the final product.', 'info');
                    return;
                }

                const expected = this.rows * this.cols;
                const actual = this.activeCells.size;

                if (actual === expected) {
                    showStepGuide('How Multiplication Arrays Work', [
                        `<strong>Step 1: Understand the array</strong><br>An array is an organized arrangement in rows and columns`,
                        `<strong>Step 2: Count the rows</strong><br>This array has <span class="step-highlight">${this.rows} rows</span> (going across)`,
                        `<strong>Step 3: Count the columns</strong><br>This array has <span class="step-highlight">${this.cols} columns</span> (going down)`,
                        `<strong>Step 4: Multiply</strong><br><div class="step-visual">${this.rows} rows √ó ${this.cols} columns = <input type="text" class="step-input" placeholder="?" aria-label="Array product"> squares</div>This is what ${this.rows} √ó ${this.cols} means!`,
                        `<strong>Step 5: Verify by counting</strong><br>You filled <span class="step-highlight">${actual} squares</span>‚Äîif every row is complete, your product is correct! ‚úì`
                    ]);
                    showFeedback('‚úÖ Great array! Use the guide to explain how you found the product.', 'success');
                } else {
                    showStepGuide('How to Complete the Array', [
                        `<strong>The Problem:</strong><br>You filled ${actual} squares, but ${this.rows} √ó ${this.cols} needs complete rows and columns to model the product.`,
                        `<strong>What to do:</strong><br>‚Ä¢ Each row should have ${this.cols} filled squares<br>‚Ä¢ You need ${this.rows} complete rows<br>‚Ä¢ Try clicking and dragging to fill entire rows at once!`,
                        `<strong>Tip:</strong><br>Start from the top-left corner and fill each row completely before moving to the next row`
                    ]);
                    showFeedback('Keep filling until every row matches the column count. Check the guide for pointers!', 'info');
                }
            }
        };

        // ==================== DIVISION GROUPS (UNCHANGED) ====================
        const divisionTool = {
            name: 'Division Groups',
            instructions: 'Drag items from the pool into groups to divide them equally.',
            totalItems: 15,
            numGroups: 3,
            groups: [],

            init() {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '<div class="division-container" id="division-workspace"></div>';
                
                const controls = document.getElementById('main-controls');
                controls.innerHTML = `
                    <label>Items: 
                        <input type="number" id="items-input" class="fraction-input" value="15" min="1" max="50" onchange="divisionTool.updateSettings()">
                    </label>
                    <label>Groups: 
                        <input type="number" id="groups-input" class="fraction-input" value="3" min="1" max="10" onchange="divisionTool.updateSettings()">
                    </label>
                    <button class="btn btn-secondary" onclick="divisionTool.checkDivision()">Check Division</button>
                    <button class="btn btn-danger" onclick="divisionTool.reset()">Reset</button>
                `;

                this.reset();
            },

            updateSettings() {
                this.totalItems = Math.max(1, Math.min(50, parseInt(document.getElementById('items-input').value) || 15));
                this.numGroups = Math.max(1, Math.min(10, parseInt(document.getElementById('groups-input').value) || 3));
                document.getElementById('items-input').value = this.totalItems;
                document.getElementById('groups-input').value = this.numGroups;
                this.reset();
            },

            reset() {
                this.groups = Array.from({length: this.numGroups}, () => []);
                this.render();
            },

            render() {
                const workspace = document.getElementById('division-workspace');
                workspace.innerHTML = '';

                const pool = document.createElement('div');
                pool.className = 'items-pool';
                pool.id = 'items-pool';

                const itemsInPool = this.totalItems - this.groups.reduce((sum, g) => sum + g.length, 0);
                for (let i = 0; i < itemsInPool; i++) {
                    const item = this.createItem(`pool-${i}`);
                    pool.appendChild(item);
                }

                workspace.appendChild(pool);

                const groupsContainer = document.createElement('div');
                groupsContainer.className = 'groups-container';

                this.groups.forEach((group, idx) => {
                    const groupBox = document.createElement('div');
                    groupBox.className = 'group-box';
                    groupBox.id = `group-${idx}`;

                    const title = document.createElement('div');
                    title.className = 'group-title';
                    title.textContent = `Group ${idx + 1} (${group.length})`;
                    groupBox.appendChild(title);

                    const itemsContainer = document.createElement('div');
                    itemsContainer.className = 'group-items';
                    
                    group.forEach((itemId, itemIdx) => {
                        const item = this.createItem(`${idx}-${itemIdx}`);
                        itemsContainer.appendChild(item);
                    });

                    groupBox.appendChild(itemsContainer);
                    groupsContainer.appendChild(groupBox);

                    groupBox.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        groupBox.style.borderColor = '#667eea';
                    });

                    groupBox.addEventListener('dragleave', () => {
                        groupBox.style.borderColor = '#9ca3af';
                    });

                    groupBox.addEventListener('drop', (e) => {
                        e.preventDefault();
                        groupBox.style.borderColor = '#9ca3af';
                        const fromGroup = parseInt(e.dataTransfer.getData('group'));
                        
                        if (fromGroup === -1) {
                            this.groups[idx].push(Date.now());
                        } else if (fromGroup !== idx) {
                            const item = this.groups[fromGroup].pop();
                            this.groups[idx].push(item);
                        }
                        this.render();
                    });
                });

                pool.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    pool.style.borderColor = '#667eea';
                });

                pool.addEventListener('dragleave', () => {
                    pool.style.borderColor = '#9ca3af';
                });

                pool.addEventListener('drop', (e) => {
                    e.preventDefault();
                    pool.style.borderColor = '#9ca3af';
                    const fromGroup = parseInt(e.dataTransfer.getData('group'));
                    
                    if (fromGroup >= 0) {
                        this.groups[fromGroup].pop();
                        this.render();
                    }
                });

                workspace.appendChild(groupsContainer);
            },

            createItem(id) {
                const item = document.createElement('div');
                item.className = 'division-item';
                item.textContent = '‚óè';
                item.draggable = true;
                item.id = id;

                let groupIdx = -1;
                if (id.includes('-') && !id.startsWith('pool')) {
                    groupIdx = parseInt(id.split('-')[0]);
                }

                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('group', groupIdx.toString());
                    item.style.opacity = '0.5';
                });

                item.addEventListener('dragend', () => {
                    item.style.opacity = '1';
                });

                return item;
            },

            checkDivision() {
                const counts = this.groups.map(g => g.length);
                const allEqual = counts.length > 0 && counts.every(c => c === counts[0]);
                const allDistributed = this.groups.reduce((sum, g) => sum + g.length, 0) === this.totalItems;

                if (allDistributed && allEqual) {
                    showFeedback(`‚úÖ Perfect! ${this.totalItems} √∑ ${this.numGroups} = ${counts[0]} per group`, 'success');
                } else if (!allDistributed) {
                    showFeedback('Distribute all items into groups first', 'error');
                } else {
                    showFeedback(`Groups are not equal. Try to distribute evenly!`, 'error');
                }
            }
        };

        // ==================== NUMBER LINE (UNCHANGED) ====================
        const numberLineTool = {
            name: 'Number Line',
            instructions: 'Set the range and mark points on the number line.',
            min: 0,
            max: 20,
            marks: [],

            init() {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '<div class="number-line-container" id="numberline-workspace"></div>';
                
                const controls = document.getElementById('main-controls');
                controls.innerHTML = `
                    <label>Min: 
                        <input type="number" id="min-input" class="fraction-input" value="0" onchange="numberLineTool.updateRange()">
                    </label>
                    <label>Max: 
                        <input type="number" id="max-input" class="fraction-input" value="20" onchange="numberLineTool.updateRange()">
                    </label>
                    <button class="btn btn-primary" onclick="numberLineTool.addMark()">Add Mark</button>
                    <button class="btn btn-danger" onclick="numberLineTool.clearMarks()">Clear Marks</button>
                `;

                this.render();
            },

            updateRange() {
                this.min = parseInt(document.getElementById('min-input').value) || 0;
                this.max = parseInt(document.getElementById('max-input').value) || 20;
                if (this.max <= this.min) this.max = this.min + 10;
                document.getElementById('min-input').value = this.min;
                document.getElementById('max-input').value = this.max;
                this.render();
            },

            addMark() {
                const value = prompt(`Enter a value between ${this.min} and ${this.max}:`);
                if (value === null) return;
                const num = parseFloat(value);
                if (isNaN(num)) {
                    showFeedback('Please enter a valid number', 'error');
                    return;
                }
                if (num < this.min || num > this.max) {
                    showFeedback(`Value must be between ${this.min} and ${this.max}`, 'error');
                    return;
                }
                this.marks.push(num);
                this.render();
                showFeedback(`Added mark at ${num}`, 'success');
            },

            clearMarks() {
                this.marks = [];
                this.render();
            },

            render() {
                const workspace = document.getElementById('numberline-workspace');
                workspace.innerHTML = '';

                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('class', 'number-line-svg');
                svg.setAttribute('viewBox', '0 0 800 200');

                const padding = 50;
                const lineY = 100;
                const lineStart = padding;
                const lineEnd = 800 - padding;

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', lineStart);
                line.setAttribute('y1', lineY);
                line.setAttribute('x2', lineEnd);
                line.setAttribute('y2', lineY);
                line.setAttribute('stroke', '#1f2937');
                line.setAttribute('stroke-width', '3');
                svg.appendChild(line);

                const range = this.max - this.min;
                const steps = Math.min(20, range + 1);
                for (let i = 0; i <= steps; i++) {
                    const value = this.min + (range * i / steps);
                    const x = lineStart + (lineEnd - lineStart) * i / steps;

                    const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    tick.setAttribute('x1', x);
                    tick.setAttribute('y1', lineY - 10);
                    tick.setAttribute('x2', x);
                    tick.setAttribute('y2', lineY + 10);
                    tick.setAttribute('stroke', '#1f2937');
                    tick.setAttribute('stroke-width', '2');
                    svg.appendChild(tick);

                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', x);
                    text.setAttribute('y', lineY + 30);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('fill', '#374151');
                    text.setAttribute('font-size', '14');
                    text.textContent = value.toFixed(1);
                    svg.appendChild(text);
                }

                this.marks.forEach((mark, idx) => {
                    const x = lineStart + (lineEnd - lineStart) * (mark - this.min) / range;
                    
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', x);
                    circle.setAttribute('cy', lineY);
                    circle.setAttribute('r', '8');
                    circle.setAttribute('fill', '#ef4444');
                    circle.setAttribute('stroke', '#1f2937');
                    circle.setAttribute('stroke-width', '2');
                    svg.appendChild(circle);

                    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    label.setAttribute('x', x);
                    label.setAttribute('y', lineY - 20);
                    label.setAttribute('text-anchor', 'middle');
                    label.setAttribute('fill', '#ef4444');
                    label.setAttribute('font-weight', 'bold');
                    label.setAttribute('font-size', '16');
                    label.textContent = mark;
                    svg.appendChild(label);
                });

                workspace.appendChild(svg);
            }
        };

        // ==================== DECIMAL BLOCKS ====================
        const decimalBlocksTool = {
            name: 'Decimal Place Value Blocks',
            instructions: 'Visualize decimals with blocks. Ones are cubes, tenths are flats, hundredths are rods, thousandths are tiny units. Drag to arrange, double-click to break into 10 smaller pieces.',
            
            init() {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '<canvas id="main-canvas" width="800" height="600"></canvas>';
                
                const controls = document.getElementById('main-controls');
                controls.innerHTML = `
                    <button class="btn btn-primary" onclick="decimalBlocksTool.addBlock(0)">+ Ones</button>
                    <button class="btn btn-primary" onclick="decimalBlocksTool.addBlock(-1)">+ Tenths (0.1)</button>
                    <button class="btn btn-primary" onclick="decimalBlocksTool.addBlock(-2)">+ Hundredths (0.01)</button>
                    <button class="btn btn-primary" onclick="decimalBlocksTool.addBlock(-3)">+ Thousandths (0.001)</button>
                    <button class="btn btn-info" onclick="decimalBlocksTool.showTotal()">Show Total</button>
                    <button class="btn btn-danger" onclick="clearWorkspace()">Clear</button>
                `;
                
                this.setupCanvas();
                this.render();
            },

            setupCanvas() {
                const canvas = document.getElementById('main-canvas');
                canvas.addEventListener('mousedown', this.handleMouseDown.bind(this));
                canvas.addEventListener('mousemove', this.handleMouseMove.bind(this));
                canvas.addEventListener('mouseup', this.handleMouseUp.bind(this));
                canvas.addEventListener('dblclick', this.handleDoubleClick.bind(this));
            },

            addBlock(place) {
                // place: 0=ones, -1=tenths, -2=hundredths, -3=thousandths
                const baseX = 100 + (place + 3) * 120;
                const stackCount = blocks.filter(b => b.place === place).length;
                const block = {
                    id: Date.now() + Math.random(),
                    place: place,
                    value: Math.pow(10, place),
                    x: baseX,
                    y: 50 + stackCount * 30,
                    color: this.getColorForPlace(place)
                };
                blocks.push(block);
                this.render();
                showFeedback(`Added ${block.value} block`, 'success');
            },

            getColorForPlace(place) {
                if (place === 0) return COLORS.ones;
                if (place === -1) return COLORS.tenths;
                if (place === -2) return COLORS.hundredths;
                if (place === -3) return COLORS.thousandths;
                return '#6b7280';
            },

            getBlockDimensions(place) {
                if (place === 0) return { w: 60, h: 60 };      // ones: square
                if (place === -1) return { w: 60, h: 20 };     // tenths: flat
                if (place === -2) return { w: 20, h: 20 };     // hundredths: small square
                if (place === -3) return { w: 10, h: 10 };     // thousandths: tiny square
                return { w: 20, h: 20 };
            },

            render() {
                const canvas = document.getElementById('main-canvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                blocks.forEach(block => {
                    const dim = this.getBlockDimensions(block.place);
                    
                    ctx.fillStyle = block.color;
                    ctx.fillRect(block.x, block.y, dim.w, dim.h);
                    
                    ctx.strokeStyle = selectedIds.has(block.id) ? '#ef4444' : '#1f2937';
                    ctx.lineWidth = selectedIds.has(block.id) ? 3 : 2;
                    ctx.strokeRect(block.x, block.y, dim.w, dim.h);

                    if (dim.w >= 20) {
                        ctx.fillStyle = '#fff';
                        ctx.font = 'bold 12px system-ui';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(block.value.toString(), block.x + dim.w/2, block.y + dim.h/2);
                    }
                });
            },

            handleMouseDown(e) {
                const canvas = document.getElementById('main-canvas');
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const clicked = this.getBlockAt(x, y);
                if (clicked) {
                    dragging = {
                        block: clicked,
                        offsetX: x - clicked.x,
                        offsetY: y - clicked.y
                    };
                }
            },

            handleMouseMove(e) {
                if (!dragging) return;
                const canvas = document.getElementById('main-canvas');
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                dragging.block.x = x - dragging.offsetX;
                dragging.block.y = y - dragging.offsetY;
                this.render();
            },

            handleMouseUp(e) {
                dragging = null;
            },

            handleDoubleClick(e) {
                const canvas = document.getElementById('main-canvas');
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const clicked = this.getBlockAt(x, y);
                if (clicked && clicked.place > -3) {
                    const newPlace = clicked.place - 1;
                    const idx = blocks.indexOf(clicked);
                    blocks.splice(idx, 1);
                    
                    for (let i = 0; i < 10; i++) {
                        blocks.push({
                            id: Date.now() + Math.random() + i,
                            place: newPlace,
                            value: Math.pow(10, newPlace),
                            x: clicked.x + (i % 5) * 15,
                            y: clicked.y + Math.floor(i / 5) * 15,
                            color: this.getColorForPlace(newPlace)
                        });
                    }
                    this.render();
                    showFeedback(`Broke ${clicked.value} into 10 √ó ${Math.pow(10, newPlace)}`, 'info');
                }
            },

            getBlockAt(x, y) {
                for (let i = blocks.length - 1; i >= 0; i--) {
                    const block = blocks[i];
                    const dim = this.getBlockDimensions(block.place);
                    if (x >= block.x && x <= block.x + dim.w &&
                        y >= block.y && y <= block.y + dim.h) {
                        return block;
                    }
                }
                return null;
            },

            showTotal() {
                let total = 0;
                blocks.forEach(b => {
                    total += b.value;
                });
                showFeedback(`Total value: ${total.toFixed(3)}`, 'success');
            }
        };

        // ==================== DECIMAL NUMBER LINE ====================
        const decimalLineTool = {
            name: 'Decimal Number Line with Zoom',
            instructions: 'Zoom in/out to see different levels of precision. Add marks to visualize decimal values.',
            min: 0,
            max: 1,
            marks: [],
            zoomLevel: 1, // 1, 10, 100

            init() {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '<div class="number-line-container" id="numberline-workspace"></div>';
                
                const controls = document.getElementById('main-controls');
                controls.innerHTML = `
                    <label>Min: 
                        <input type="number" id="min-input" class="fraction-input" value="0" step="0.01" onchange="decimalLineTool.updateRange()">
                    </label>
                    <label>Max: 
                        <input type="number" id="max-input" class="fraction-input" value="1" step="0.01" onchange="decimalLineTool.updateRange()">
                    </label>
                    <button class="btn btn-primary" onclick="decimalLineTool.addMark()">Add Mark</button>
                    <button class="btn btn-info" onclick="decimalLineTool.zoom(10)">Zoom In 10√ó</button>
                    <button class="btn btn-info" onclick="decimalLineTool.zoom(0.1)">Zoom Out 10√ó</button>
                    <button class="btn btn-danger" onclick="decimalLineTool.clearMarks()">Clear Marks</button>
                `;

                this.render();
            },

            updateRange() {
                this.min = parseFloat(document.getElementById('min-input').value) || 0;
                this.max = parseFloat(document.getElementById('max-input').value) || 1;
                if (this.max <= this.min) this.max = this.min + 1;
                document.getElementById('min-input').value = this.min;
                document.getElementById('max-input').value = this.max;
                this.render();
            },

            zoom(factor) {
                const center = (this.min + this.max) / 2;
                const range = (this.max - this.min) * factor;
                this.min = center - range / 2;
                this.max = center + range / 2;
                
                document.getElementById('min-input').value = this.min.toFixed(3);
                document.getElementById('max-input').value = this.max.toFixed(3);
                
                this.render();
                showFeedback(`Zoomed ${factor > 1 ? 'in' : 'out'} ${factor}√ó`, 'info');
            },

            addMark() {
                const value = prompt(`Enter a decimal value between ${this.min.toFixed(3)} and ${this.max.toFixed(3)}:`);
                if (value === null) return;
                const num = parseFloat(value);
                if (isNaN(num)) {
                    showFeedback('Please enter a valid number', 'error');
                    return;
                }
                if (num < this.min || num > this.max) {
                    showFeedback(`Value must be between ${this.min.toFixed(3)} and ${this.max.toFixed(3)}`, 'error');
                    return;
                }
                this.marks.push(num);
                this.render();
                showFeedback(`Added mark at ${num}`, 'success');
            },

            clearMarks() {
                this.marks = [];
                this.render();
            },

            render() {
                const workspace = document.getElementById('numberline-workspace');
                workspace.innerHTML = '';

                // Add zoom info
                const zoomInfo = document.createElement('div');
                zoomInfo.className = 'zoom-info';
                const currentRange = this.max - this.min;
                let precision = 0;
                if (currentRange < 0.1) precision = 3;
                else if (currentRange < 1) precision = 2;
                else if (currentRange < 10) precision = 1;
                zoomInfo.textContent = `Range: ${currentRange.toFixed(precision)} | Precision: ${precision} decimal places`;
                workspace.appendChild(zoomInfo);

                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('class', 'number-line-svg');
                svg.setAttribute('viewBox', '0 0 800 200');

                const padding = 50;
                const lineY = 100;
                const lineStart = padding;
                const lineEnd = 800 - padding;

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', lineStart);
                line.setAttribute('y1', lineY);
                line.setAttribute('x2', lineEnd);
                line.setAttribute('y2', lineY);
                line.setAttribute('stroke', '#1f2937');
                line.setAttribute('stroke-width', '3');
                svg.appendChild(line);

                const range = currentRange;
                const steps = 20;
                for (let i = 0; i <= steps; i++) {
                    const value = this.min + (range * i / steps);
                    const x = lineStart + (lineEnd - lineStart) * i / steps;

                    const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    tick.setAttribute('x1', x);
                    tick.setAttribute('y1', lineY - 10);
                    tick.setAttribute('x2', x);
                    tick.setAttribute('y2', lineY + 10);
                    tick.setAttribute('stroke', '#1f2937');
                    tick.setAttribute('stroke-width', '2');
                    svg.appendChild(tick);

                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', x);
                    text.setAttribute('y', lineY + 30);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('fill', '#374151');
                    text.setAttribute('font-size', '12');
                    text.textContent = value.toFixed(Math.max(1, 3));
                    svg.appendChild(text);
                }

                this.marks.forEach((mark) => {
                    if (mark >= this.min && mark <= this.max) {
                        const x = lineStart + (lineEnd - lineStart) * (mark - this.min) / range;
                        
                        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        circle.setAttribute('cx', x);
                        circle.setAttribute('cy', lineY);
                        circle.setAttribute('r', '8');
                        circle.setAttribute('fill', '#ef4444');
                        circle.setAttribute('stroke', '#1f2937');
                        circle.setAttribute('stroke-width', '2');
                        svg.appendChild(circle);

                        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        label.setAttribute('x', x);
                        label.setAttribute('y', lineY - 20);
                        label.setAttribute('text-anchor', 'middle');
                        label.setAttribute('fill', '#ef4444');
                        label.setAttribute('font-weight', 'bold');
                        label.setAttribute('font-size', '14');
                        label.textContent = mark.toFixed(3);
                        svg.appendChild(label);
                    }
                });

                workspace.appendChild(svg);
            }
        };

        // ==================== PROTRACTOR ====================
        const protractorTool = {
            name: 'Interactive Protractor',
            instructions: 'Use the slider to set an angle. The protractor shows the angle visually. Perfect for learning angle measurement!',
            angle: 45,

            init() {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '<div class="protractor-container" id="protractor-workspace"></div>';
                
                const controls = document.getElementById('main-controls');
                controls.innerHTML = `
                    <button class="btn btn-primary" onclick="protractorTool.setAngle(0)">0¬∞</button>
                    <button class="btn btn-primary" onclick="protractorTool.setAngle(45)">45¬∞</button>
                    <button class="btn btn-primary" onclick="protractorTool.setAngle(90)">90¬∞</button>
                    <button class="btn btn-primary" onclick="protractorTool.setAngle(180)">180¬∞</button>
                    <button class="btn btn-secondary" onclick="protractorTool.randomAngle()">Random</button>
                `;

                this.render();
            },

            setAngle(deg) {
                this.angle = Math.max(0, Math.min(360, deg));
                document.getElementById('angle-input').value = this.angle;
                this.render();
            },

            randomAngle() {
                this.setAngle(Math.floor(Math.random() * 361));
                showFeedback(`Random angle: ${this.angle}¬∞`, 'info');
            },

            render() {
                const workspace = document.getElementById('protractor-workspace');
                
                const angleDisplay = document.createElement('div');
                angleDisplay.className = 'angle-display';
                angleDisplay.textContent = `${this.angle}¬∞`;

                const angleControls = document.createElement('div');
                angleControls.className = 'angle-controls';
                angleControls.innerHTML = `
                    <label style="font-weight:600;">Angle:</label>
                    <input type="range" id="angle-input" class="angle-slider" min="0" max="360" value="${this.angle}" 
                           oninput="protractorTool.angle = parseInt(this.value); protractorTool.render();">
                    <span style="font-weight:600; min-width:60px;">${this.angle}¬∞</span>
                `;

                const canvas = document.createElement('canvas');
                canvas.width = 600;
                canvas.height = 400;
                canvas.style.display = 'block';
                canvas.style.margin = '0 auto';

                workspace.innerHTML = '';
                workspace.appendChild(angleDisplay);
                workspace.appendChild(angleControls);
                workspace.appendChild(canvas);

                this.drawProtractor(canvas);

                // Add angle classification
                const classification = document.createElement('div');
                classification.style.marginTop = '20px';
                classification.style.fontSize = '18px';
                classification.style.fontWeight = '600';
                
                let type = '';
                if (this.angle === 0) type = 'Zero Angle';
                else if (this.angle < 90) type = 'Acute Angle';
                else if (this.angle === 90) type = 'Right Angle';
                else if (this.angle < 180) type = 'Obtuse Angle';
                else if (this.angle === 180) type = 'Straight Angle';
                else if (this.angle < 360) type = 'Reflex Angle';
                else type = 'Full Rotation';
                
                classification.textContent = type;
                classification.style.color = this.angle === 90 ? '#10b981' : '#667eea';
                workspace.appendChild(classification);
            },

            drawProtractor(canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const centerX = 300;
                const centerY = 250;
                const radius = 150;

                // Draw semicircle protractor
                ctx.strokeStyle = '#1f2937';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, Math.PI, 0, false);
                ctx.stroke();

                // Draw tick marks
                for (let deg = 0; deg <= 180; deg += 10) {
                    const rad = (deg - 180) * Math.PI / 180;
                    const tickLength = deg % 30 === 0 ? 15 : 8;
                    
                    const x1 = centerX + Math.cos(rad) * radius;
                    const y1 = centerY + Math.sin(rad) * radius;
                    const x2 = centerX + Math.cos(rad) * (radius - tickLength);
                    const y2 = centerY + Math.sin(rad) * (radius - tickLength);
                    
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.lineWidth = deg % 30 === 0 ? 2 : 1;
                    ctx.stroke();

                    // Draw degree labels
                    if (deg % 30 === 0) {
                        const labelX = centerX + Math.cos(rad) * (radius - 30);
                        const labelY = centerY + Math.sin(rad) * (radius - 30);
                        ctx.fillStyle = '#374151';
                        ctx.font = 'bold 14px system-ui';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(deg + '¬∞', labelX, labelY);
                    }
                }

                // Draw base line
                ctx.strokeStyle = '#1f2937';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(centerX - radius, centerY);
                ctx.lineTo(centerX + radius, centerY);
                ctx.stroke();

                // Draw angle ray
                const angleRad = (this.angle - 180) * Math.PI / 180;
                const rayX = centerX + Math.cos(angleRad) * radius;
                const rayY = centerY + Math.sin(angleRad) * radius;
                
                ctx.strokeStyle = '#ef4444';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(rayX, rayY);
                ctx.stroke();

                // Draw angle arc
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(centerX, centerY, 50, Math.PI, (this.angle - 180) * Math.PI / 180, this.angle < 180);
                ctx.stroke();

                // Draw center point
                ctx.fillStyle = '#1f2937';
                ctx.beginPath();
                ctx.arc(centerX, centerY, 5, 0, Math.PI * 2);
                ctx.fill();
            }
        };

        // ==================== POLYGON BUILDER ====================
        const polygonTool = {
            name: 'Polygon Builder',
            instructions: 'Click on the canvas to add vertices. Double-click or click "Close Polygon" when done. The tool calculates perimeter and area automatically!',
            vertices: [],
            closed: false,

            init() {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '<div class="polygon-container" id="polygon-workspace"></div>';
                
                const controls = document.getElementById('main-controls');
                controls.innerHTML = `
                    <button class="btn btn-primary" onclick="polygonTool.closePolygon()">Close Polygon</button>
                    <button class="btn btn-secondary" onclick="polygonTool.makeRegular()">Make Regular</button>
                    <button class="btn btn-danger" onclick="polygonTool.clear()">Clear</button>
                `;

                this.render();
            },

            clear() {
                this.vertices = [];
                this.closed = false;
                this.render();
            },

            closePolygon() {
                if (this.vertices.length >= 3) {
                    this.closed = true;
                    this.render();
                    showFeedback('Polygon closed!', 'success');
                } else {
                    showFeedback('Need at least 3 vertices', 'error');
                }
            },

            makeRegular() {
                if (this.vertices.length < 3) {
                    showFeedback('Add at least 3 vertices first', 'error');
                    return;
                }
                
                const n = this.vertices.length;
                const centerX = 300;
                const centerY = 200;
                const radius = 120;
                
                this.vertices = [];
                for (let i = 0; i < n; i++) {
                    const angle = (i * 2 * Math.PI / n) - Math.PI / 2;
                    this.vertices.push({
                        x: centerX + Math.cos(angle) * radius,
                        y: centerY + Math.sin(angle) * radius
                    });
                }
                this.closed = true;
                this.render();
                showFeedback(`Created regular ${n}-gon`, 'success');
            },

            calculatePerimeter() {
                if (this.vertices.length < 2) return 0;
                let perim = 0;
                for (let i = 0; i < this.vertices.length; i++) {
                    const j = (i + 1) % this.vertices.length;
                    const dx = this.vertices[j].x - this.vertices[i].x;
                    const dy = this.vertices[j].y - this.vertices[i].y;
                    perim += Math.sqrt(dx * dx + dy * dy);
                }
                if (!this.closed && this.vertices.length > 0) {
                    // Subtract last segment if not closed
                    const n = this.vertices.length;
                    const dx = this.vertices[0].x - this.vertices[n-1].x;
                    const dy = this.vertices[0].y - this.vertices[n-1].y;
                    perim -= Math.sqrt(dx * dx + dy * dy);
                }
                return perim;
            },

            calculateArea() {
                if (this.vertices.length < 3 || !this.closed) return 0;
                let area = 0;
                for (let i = 0; i < this.vertices.length; i++) {
                    const j = (i + 1) % this.vertices.length;
                    area += this.vertices[i].x * this.vertices[j].y;
                    area -= this.vertices[j].x * this.vertices[i].y;
                }
                return Math.abs(area / 2);
            },

            render() {
                const workspace = document.getElementById('polygon-workspace');
                
                const canvas = document.createElement('canvas');
                canvas.className = 'polygon-canvas';
                canvas.width = 600;
                canvas.height = 400;

                canvas.addEventListener('click', (e) => {
                    if (this.closed) return;
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    this.vertices.push({ x, y });
                    this.render();
                });

                canvas.addEventListener('dblclick', (e) => {
                    e.preventDefault();
                    this.closePolygon();
                });

                workspace.innerHTML = '';
                workspace.appendChild(canvas);

                this.drawPolygon(canvas);

                // Info panel
                if (this.vertices.length > 0) {
                    const info = document.createElement('div');
                    info.className = 'polygon-info';
                    
                    const sides = this.vertices.length;
                    const perimeter = this.calculatePerimeter();
                    const area = this.calculateArea();
                    
                    info.innerHTML = `
                        <div>Vertices: ${sides}</div>
                        <div>Perimeter: ${perimeter.toFixed(2)} units</div>
                        ${this.closed ? `<div>Area: ${area.toFixed(2)} sq units</div>` : ''}
                        <div>Status: ${this.closed ? 'Closed' : 'Open'}</div>
                    `;
                    workspace.appendChild(info);
                }
            },

            drawPolygon(canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (this.vertices.length === 0) {
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '18px system-ui';
                    ctx.textAlign = 'center';
                    ctx.fillText('Click to add vertices', 300, 200);
                    return;
                }

                // Draw polygon
                ctx.beginPath();
                ctx.moveTo(this.vertices[0].x, this.vertices[0].y);
                for (let i = 1; i < this.vertices.length; i++) {
                    ctx.lineTo(this.vertices[i].x, this.vertices[i].y);
                }
                if (this.closed) {
                    ctx.closePath();
                    ctx.fillStyle = 'rgba(102, 126, 234, 0.2)';
                    ctx.fill();
                }
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 3;
                ctx.stroke();

                // Draw vertices
                this.vertices.forEach((v, i) => {
                    ctx.fillStyle = i === 0 ? '#10b981' : '#667eea';
                    ctx.beginPath();
                    ctx.arc(v.x, v.y, 6, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.strokeStyle = '#1f2937';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Label vertices
                    ctx.fillStyle = '#1f2937';
                    ctx.font = 'bold 12px system-ui';
                    ctx.textAlign = 'center';
                    ctx.fillText(String.fromCharCode(65 + i), v.x, v.y - 12);
                });
            }
        };

        // ==================== COORDINATE PLANE ====================
        const coordinateTool = {
            name: 'Coordinate Plane Plotter',
            instructions: 'Click on the grid to plot points. Points show their (x, y) coordinates. Use controls to add specific points or draw line segments.',
            points: [],
            gridSize: 20,
            xMin: -10,
            xMax: 10,
            yMin: -10,
            yMax: 10,

            init() {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '<div class="coordinate-container" id="coordinate-workspace"></div>';
                
                const controls = document.getElementById('main-controls');
                controls.innerHTML = `
                    <button class="btn btn-primary" onclick="coordinateTool.addPoint()">Add Point (x,y)</button>
                    <button class="btn btn-secondary" onclick="coordinateTool.connectPoints()">Connect Points</button>
                    <button class="btn btn-info" onclick="coordinateTool.showDistance()">Show Distance</button>
                    <button class="btn btn-danger" onclick="coordinateTool.clear()">Clear</button>
                `;

                this.render();
            },

            clear() {
                this.points = [];
                this.render();
            },

            addPoint() {
                const x = prompt('Enter x coordinate (-10 to 10):');
                if (x === null) return;
                const y = prompt('Enter y coordinate (-10 to 10):');
                if (y === null) return;
                
                const xVal = parseFloat(x);
                const yVal = parseFloat(y);
                
                if (isNaN(xVal) || isNaN(yVal)) {
                    showFeedback('Invalid coordinates', 'error');
                    return;
                }
                
                if (xVal < this.xMin || xVal > this.xMax || yVal < this.yMin || yVal > this.yMax) {
                    showFeedback('Coordinates out of range', 'error');
                    return;
                }
                
                this.points.push({ x: xVal, y: yVal });
                this.render();
                showFeedback(`Added point (${xVal}, ${yVal})`, 'success');
            },

            connectPoints() {
                if (this.points.length < 2) {
                    showFeedback('Need at least 2 points', 'error');
                    return;
                }
                this.points.forEach(p => p.connected = true);
                this.render();
                showFeedback('Points connected', 'success');
            },

            showDistance() {
                if (this.points.length < 2) {
                    showFeedback('Need at least 2 points', 'error');
                    return;
                }
                const p1 = this.points[this.points.length - 2];
                const p2 = this.points[this.points.length - 1];
                const dx = p2.x - p1.x;
                const dy = p2.y - p1.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                showFeedback(`Distance: ${dist.toFixed(2)} units`, 'success');
            },

            render() {
                const workspace = document.getElementById('coordinate-workspace');
                
                const canvas = document.createElement('canvas');
                canvas.className = 'coordinate-canvas';
                canvas.width = 600;
                canvas.height = 600;

                canvas.addEventListener('click', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const px = e.clientX - rect.left;
                    const py = e.clientY - rect.top;
                    
                    // Convert pixel to coordinate
                    const x = Math.round((px - 300) / this.gridSize);
                    const y = Math.round((300 - py) / this.gridSize);
                    
                    if (x >= this.xMin && x <= this.xMax && y >= this.yMin && y <= this.yMax) {
                        this.points.push({ x, y });
                        this.render();
                    }
                });

                workspace.innerHTML = '';
                workspace.appendChild(canvas);

                this.drawCoordinatePlane(canvas);

                // Point list
                if (this.points.length > 0) {
                    const list = document.createElement('div');
                    list.className = 'point-list';
                    list.innerHTML = '<h3 style="margin-bottom:10px;">Plotted Points:</h3>';
                    
                    this.points.forEach((p, i) => {
                        const item = document.createElement('div');
                        item.className = 'point-item';
                        item.innerHTML = `
                            <span class="coords">Point ${i + 1}: (${p.x}, ${p.y})</span>
                            <button class="btn btn-danger" style="padding:5px 10px; font-size:12px;" 
                                    onclick="coordinateTool.removePoint(${i})">√ó</button>
                        `;
                        list.appendChild(item);
                    });
                    
                    workspace.appendChild(list);
                }
            },

            removePoint(index) {
                this.points.splice(index, 1);
                this.render();
            },

            drawCoordinatePlane(canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const centerX = 300;
                const centerY = 300;

                // Draw grid
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let x = this.xMin; x <= this.xMax; x++) {
                    const px = centerX + x * this.gridSize;
                    ctx.beginPath();
                    ctx.moveTo(px, 0);
                    ctx.lineTo(px, 600);
                    ctx.stroke();
                }
                for (let y = this.yMin; y <= this.yMax; y++) {
                    const py = centerY - y * this.gridSize;
                    ctx.beginPath();
                    ctx.moveTo(0, py);
                    ctx.lineTo(600, py);
                    ctx.stroke();
                }

                // Draw axes
                ctx.strokeStyle = '#1f2937';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(0, centerY);
                ctx.lineTo(600, centerY);
                ctx.moveTo(centerX, 0);
                ctx.lineTo(centerX, 600);
                ctx.stroke();

                // Draw axis labels
                ctx.fillStyle = '#374151';
                ctx.font = '12px system-ui';
                ctx.textAlign = 'center';
                for (let x = this.xMin; x <= this.xMax; x++) {
                    if (x === 0) continue;
                    const px = centerX + x * this.gridSize;
                    ctx.fillText(x.toString(), px, centerY + 15);
                }
                ctx.textAlign = 'right';
                for (let y = this.yMin; y <= this.yMax; y++) {
                    if (y === 0) continue;
                    const py = centerY - y * this.gridSize;
                    ctx.fillText(y.toString(), centerX - 8, py + 4);
                }

                // Draw origin
                ctx.fillStyle = '#1f2937';
                ctx.font = 'bold 14px system-ui';
                ctx.textAlign = 'right';
                ctx.fillText('O', centerX - 8, centerY + 18);

                // Draw connecting lines
                if (this.points.some(p => p.connected)) {
                    ctx.strokeStyle = '#667eea';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    const connectedPoints = this.points.filter(p => p.connected);
                    if (connectedPoints.length > 0) {
                        const first = connectedPoints[0];
                        ctx.moveTo(centerX + first.x * this.gridSize, centerY - first.y * this.gridSize);
                        for (let i = 1; i < connectedPoints.length; i++) {
                            const p = connectedPoints[i];
                            ctx.lineTo(centerX + p.x * this.gridSize, centerY - p.y * this.gridSize);
                        }
                        ctx.stroke();
                    }
                }

                // Draw points
                this.points.forEach((p, i) => {
                    const px = centerX + p.x * this.gridSize;
                    const py = centerY - p.y * this.gridSize;
                    
                    ctx.fillStyle = '#ef4444';
                    ctx.beginPath();
                    ctx.arc(px, py, 6, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.strokeStyle = '#1f2937';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Label point
                    ctx.fillStyle = '#1f2937';
                    ctx.font = 'bold 12px system-ui';
                    ctx.textAlign = 'center';
                    ctx.fillText(`(${p.x},${p.y})`, px, py - 12);
                });
            }
        };

        // ==================== TRANSFORMATIONS ====================
        const transformTool = {
            name: 'Geometric Transformations',
            instructions: 'Draw a shape, then apply transformations: translation (slide), rotation (turn), reflection (flip), or dilation (scale).',
            originalShape: [],
            transformedShape: [],
            mode: 'translate',
            translateX: 3,
            translateY: 2,
            rotationAngle: 90,
            reflectionAxis: 'x',
            scaleFactor: 1.5,

            init() {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '<div class="transform-container" id="transform-workspace"></div>';
                
                const controls = document.getElementById('main-controls');
                controls.innerHTML = `
                    <button class="btn btn-primary" onclick="transformTool.createSquare()">Square</button>
                    <button class="btn btn-primary" onclick="transformTool.createTriangle()">Triangle</button>
                    <button class="btn btn-secondary" onclick="transformTool.applyTransform()">Apply Transform</button>
                    <button class="btn btn-danger" onclick="transformTool.clear()">Clear</button>
                `;

                if (this.originalShape.length === 0) {
                    this.createSquare();
                }
                
                this.render();
            },

            clear() {
                this.originalShape = [];
                this.transformedShape = [];
                this.render();
            },

            createSquare() {
                this.originalShape = [
                    { x: -2, y: -2 },
                    { x: 2, y: -2 },
                    { x: 2, y: 2 },
                    { x: -2, y: 2 }
                ];
                this.transformedShape = [];
                this.render();
            },

            createTriangle() {
                this.originalShape = [
                    { x: 0, y: 3 },
                    { x: -3, y: -2 },
                    { x: 3, y: -2 }
                ];
                this.transformedShape = [];
                this.render();
            },

            applyTransform() {
                if (this.originalShape.length === 0) {
                    showFeedback('Create a shape first', 'error');
                    return;
                }

                switch (this.mode) {
                    case 'translate':
                        this.transformedShape = this.originalShape.map(p => ({
                            x: p.x + this.translateX,
                            y: p.y + this.translateY
                        }));
                        showFeedback(`Translated by (${this.translateX}, ${this.translateY})`, 'success');
                        break;
                    
                    case 'rotate':
                        const rad = this.rotationAngle * Math.PI / 180;
                        this.transformedShape = this.originalShape.map(p => ({
                            x: p.x * Math.cos(rad) - p.y * Math.sin(rad),
                            y: p.x * Math.sin(rad) + p.y * Math.cos(rad)
                        }));
                        showFeedback(`Rotated ${this.rotationAngle}¬∞ around origin`, 'success');
                        break;
                    
                    case 'reflect':
                        if (this.reflectionAxis === 'x') {
                            this.transformedShape = this.originalShape.map(p => ({ x: p.x, y: -p.y }));
                            showFeedback('Reflected over x-axis', 'success');
                        } else if (this.reflectionAxis === 'y') {
                            this.transformedShape = this.originalShape.map(p => ({ x: -p.x, y: p.y }));
                            showFeedback('Reflected over y-axis', 'success');
                        } else {
                            this.transformedShape = this.originalShape.map(p => ({ x: p.y, y: p.x }));
                            showFeedback('Reflected over y=x', 'success');
                        }
                        break;
                    
                    case 'dilate':
                        this.transformedShape = this.originalShape.map(p => ({
                            x: p.x * this.scaleFactor,
                            y: p.y * this.scaleFactor
                        }));
                        showFeedback(`Dilated by factor ${this.scaleFactor}`, 'success');
                        break;
                }

                this.render();
            },

            render() {
                const workspace = document.getElementById('transform-workspace');
                
                // Mode selector
                const modeSelector = document.createElement('div');
                modeSelector.className = 'transform-controls';
                modeSelector.innerHTML = `
                    <div class="transform-mode ${this.mode === 'translate' ? 'active' : ''}" onclick="transformTool.setMode('translate')">
                        Translation
                    </div>
                    <div class="transform-mode ${this.mode === 'rotate' ? 'active' : ''}" onclick="transformTool.setMode('rotate')">
                        Rotation
                    </div>
                    <div class="transform-mode ${this.mode === 'reflect' ? 'active' : ''}" onclick="transformTool.setMode('reflect')">
                        Reflection
                    </div>
                    <div class="transform-mode ${this.mode === 'dilate' ? 'active' : ''}" onclick="transformTool.setMode('dilate')">
                        Dilation
                    </div>
                `;

                // Settings panel
                const settings = document.createElement('div');
                settings.style.margin = '20px 0';
                settings.style.padding = '15px';
                settings.style.background = '#f3f4f6';
                settings.style.borderRadius = '10px';
                settings.style.display = 'inline-block';

                if (this.mode === 'translate') {
                    settings.innerHTML = `
                        <label style="margin-right:15px;">
                            X: <input type="number" value="${this.translateX}" 
                                     onchange="transformTool.translateX = parseFloat(this.value)"
                                     style="width:60px; padding:5px; margin-left:5px;">
                        </label>
                        <label>
                            Y: <input type="number" value="${this.translateY}" 
                                     onchange="transformTool.translateY = parseFloat(this.value)"
                                     style="width:60px; padding:5px; margin-left:5px;">
                        </label>
                    `;
                } else if (this.mode === 'rotate') {
                    settings.innerHTML = `
                        <label>
                            Angle: <input type="number" value="${this.rotationAngle}" 
                                        onchange="transformTool.rotationAngle = parseFloat(this.value)"
                                        style="width:80px; padding:5px; margin-left:5px;">¬∞
                        </label>
                    `;
                } else if (this.mode === 'reflect') {
                    settings.innerHTML = `
                        <label style="margin-right:10px;">
                            <input type="radio" name="axis" value="x" ${this.reflectionAxis === 'x' ? 'checked' : ''}
                                   onchange="transformTool.reflectionAxis = 'x'"> X-axis
                        </label>
                        <label style="margin-right:10px;">
                            <input type="radio" name="axis" value="y" ${this.reflectionAxis === 'y' ? 'checked' : ''}
                                   onchange="transformTool.reflectionAxis = 'y'"> Y-axis
                        </label>
                        <label>
                            <input type="radio" name="axis" value="xy" ${this.reflectionAxis === 'xy' ? 'checked' : ''}
                                   onchange="transformTool.reflectionAxis = 'xy'"> y=x
                        </label>
                    `;
                } else if (this.mode === 'dilate') {
                    settings.innerHTML = `
                        <label>
                            Scale Factor: <input type="number" value="${this.scaleFactor}" step="0.1" min="0.1"
                                                onchange="transformTool.scaleFactor = parseFloat(this.value)"
                                                style="width:80px; padding:5px; margin-left:5px;">
                        </label>
                    `;
                }

                const canvas = document.createElement('canvas');
                canvas.className = 'transform-canvas';
                canvas.width = 600;
                canvas.height = 600;

                workspace.innerHTML = '';
                workspace.appendChild(modeSelector);
                workspace.appendChild(settings);
                workspace.appendChild(canvas);

                this.drawTransformation(canvas);
            },

            setMode(mode) {
                this.mode = mode;
                this.render();
            },

            drawTransformation(canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const centerX = 300;
                const centerY = 300;
                const gridSize = 30;

                // Draw grid
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let x = -10; x <= 10; x++) {
                    const px = centerX + x * gridSize;
                    ctx.beginPath();
                    ctx.moveTo(px, 0);
                    ctx.lineTo(px, 600);
                    ctx.stroke();
                }
                for (let y = -10; y <= 10; y++) {
                    const py = centerY - y * gridSize;
                    ctx.beginPath();
                    ctx.moveTo(0, py);
                    ctx.lineTo(600, py);
                    ctx.stroke();
                }

                // Draw axes
                ctx.strokeStyle = '#1f2937';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(0, centerY);
                ctx.lineTo(600, centerY);
                ctx.moveTo(centerX, 0);
                ctx.lineTo(centerX, 600);
                ctx.stroke();

                // Draw reflection axes if in reflect mode
                if (this.mode === 'reflect') {
                    ctx.strokeStyle = '#10b981';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    if (this.reflectionAxis === 'x') {
                        ctx.beginPath();
                        ctx.moveTo(0, centerY);
                        ctx.lineTo(600, centerY);
                        ctx.stroke();
                    } else if (this.reflectionAxis === 'y') {
                        ctx.beginPath();
                        ctx.moveTo(centerX, 0);
                        ctx.lineTo(centerX, 600);
                        ctx.stroke();
                    } else {
                        ctx.beginPath();
                        ctx.moveTo(0, 600);
                        ctx.lineTo(600, 0);
                        ctx.stroke();
                    }
                    ctx.setLineDash([]);
                }

                // Helper function to draw a shape
                const drawShape = (shape, color, label) => {
                    if (shape.length === 0) return;

                    ctx.beginPath();
                    ctx.moveTo(centerX + shape[0].x * gridSize, centerY - shape[0].y * gridSize);
                    for (let i = 1; i < shape.length; i++) {
                        ctx.lineTo(centerX + shape[i].x * gridSize, centerY - shape[i].y * gridSize);
                    }
                    ctx.closePath();
                    ctx.fillStyle = color;
                    ctx.fill();
                    ctx.strokeStyle = '#1f2937';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Draw vertices
                    shape.forEach(p => {
                        ctx.fillStyle = '#1f2937';
                        ctx.beginPath();
                        ctx.arc(centerX + p.x * gridSize, centerY - p.y * gridSize, 4, 0, Math.PI * 2);
                        ctx.fill();
                    });

                    // Label
                    if (shape.length > 0) {
                        const avgX = shape.reduce((sum, p) => sum + p.x, 0) / shape.length;
                        const avgY = shape.reduce((sum, p) => sum + p.y, 0) / shape.length;
                        ctx.fillStyle = '#1f2937';
                        ctx.font = 'bold 14px system-ui';
                        ctx.textAlign = 'center';
                        ctx.fillText(label, centerX + avgX * gridSize, centerY - avgY * gridSize);
                    }
                };

                // Draw original shape
                drawShape(this.originalShape, 'rgba(102, 126, 234, 0.5)', 'Original');

                // Draw transformed shape
                if (this.transformedShape.length > 0) {
                    drawShape(this.transformedShape, 'rgba(16, 185, 129, 0.5)', 'Transformed');
                }
            }
        };

        // ==================== FULLSCREEN TOGGLE ====================
        function toggleFullscreen() {
            const workspace = document.getElementById('workspace');
            const btn = document.getElementById('expand-btn');
            
            if (workspace.classList.contains('fullscreen-workspace')) {
                workspace.classList.remove('fullscreen-workspace');
                btn.textContent = '‚õ∂ Expand';
            } else {
                workspace.classList.add('fullscreen-workspace');
                btn.textContent = '‚úï Exit Fullscreen';
            }
            
            // Re-render current tool to adjust canvas sizes
            renderCurrentTool();
        }

        // Exit fullscreen on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const workspace = document.getElementById('workspace');
                if (workspace.classList.contains('fullscreen-workspace')) {
                    toggleFullscreen();
                }
            }
        });

        // ==================== ALGEBRA TILES ====================
        const algebraTilesTool = {
            name: 'Algebra Tiles',
            instructions: 'Drag tiles to build algebraic expressions. Blue squares = x¬≤, green rectangles = x, yellow squares = 1. Use for multiplying binomials, factoring, and simplifying.',
            tiles: [],

            init() {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '<div class="algebra-container" id="algebra-workspace"></div>';
                
                const controls = document.getElementById('main-controls');
                controls.innerHTML = `
                    <button class="btn btn-primary" onclick="algebraTilesTool.addTile('x2', 1)">+ x¬≤</button>
                    <button class="btn btn-primary" onclick="algebraTilesTool.addTile('x', 1)">+ x</button>
                    <button class="btn btn-primary" onclick="algebraTilesTool.addTile('1', 1)">+ 1</button>
                    <button class="btn btn-secondary" onclick="algebraTilesTool.addTile('x2', -1)">‚àí x¬≤</button>
                    <button class="btn btn-secondary" onclick="algebraTilesTool.addTile('x', -1)">‚àí x</button>
                    <button class="btn btn-secondary" onclick="algebraTilesTool.addTile('1', -1)">‚àí 1</button>
                    <button class="btn btn-info" onclick="algebraTilesTool.simplify()">Simplify</button>
                    <button class="btn btn-danger" onclick="algebraTilesTool.clear()">Clear</button>
                `;

                this.render();
            },

            addTile(type, sign) {
                this.tiles.push({
                    id: Date.now() + Math.random(),
                    type: type,
                    sign: sign
                });
                this.render();
            },

            clear() {
                this.tiles = [];
                this.render();
            },

            simplify() {
                const counts = { x2: 0, x: 0, '1': 0 };
                this.tiles.forEach(t => {
                    counts[t.type] += t.sign;
                });

                this.tiles = [];
                ['x2', 'x', '1'].forEach(type => {
                    const count = counts[type];
                    for (let i = 0; i < Math.abs(count); i++) {
                        this.tiles.push({
                            id: Date.now() + Math.random() + i,
                            type: type,
                            sign: count > 0 ? 1 : -1
                        });
                    }
                });

                this.render();
                
                let expr = '';
                if (counts.x2 !== 0) expr += `${counts.x2 > 0 && expr ? '+' : ''}${counts.x2}x¬≤`;
                if (counts.x !== 0) expr += `${counts.x > 0 && expr ? '+' : ''}${counts.x}x`;
                if (counts['1'] !== 0) expr += `${counts['1'] > 0 && expr ? '+' : ''}${counts['1']}`;
                if (!expr) expr = '0';
                
                showFeedback(`Simplified: ${expr}`, 'success');
            },

            render() {
                const workspace = document.getElementById('algebra-workspace');
                
                const palette = document.createElement('div');
                palette.className = 'algebra-palette';
                palette.innerHTML = '<h3 style="margin-bottom:10px;">Tile Palette</h3><p style="color:#6b7280;">Click buttons above to add tiles</p>';

                const zone = document.createElement('div');
                zone.className = 'algebra-zone';
                zone.innerHTML = '<h3 style="margin-bottom:15px;">Workspace</h3>';

                this.tiles.forEach((tile, idx) => {
                    const tileEl = document.createElement('div');
                    let className = 'tile ';
                    let label = '';
                    
                    if (tile.type === 'x2') {
                        className += 'tile-x2';
                        label = 'x¬≤';
                    } else if (tile.type === 'x') {
                        className += 'tile-x';
                        label = 'x';
                    } else {
                        className += 'tile-1';
                        label = '1';
                    }
                    
                    if (tile.sign < 0) {
                        className += ' tile-negative';
                        label = '‚àí' + label;
                    }
                    
                    tileEl.className = className;
                    tileEl.textContent = label;
                    tileEl.onclick = () => {
                        this.tiles.splice(idx, 1);
                        this.render();
                    };
                    zone.appendChild(tileEl);
                });

                workspace.innerHTML = '';
                workspace.appendChild(palette);
                workspace.appendChild(zone);

                if (this.tiles.length === 0) {
                    zone.innerHTML += '<p style="color:#9ca3af; margin-top:50px;">Click buttons to add algebra tiles</p>';
                }
            }
        };

        // ==================== BALANCE SCALE ====================
        const balanceTool = {
            name: 'Balance Scale',
            instructions: 'Solve equations by keeping the balance! Add, subtract, multiply, or divide the same value on both sides. The scale tips show which side is heavier.',
            leftSide: 'x + 3',
            rightSide: '7',

            init() {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '<div class="balance-container" id="balance-workspace"></div>';
                
                const controls = document.getElementById('main-controls');
                controls.innerHTML = `
                    <button class="btn btn-primary" onclick="balanceTool.operate('subtract', 3)">‚àí3 Both Sides</button>
                    <button class="btn btn-primary" onclick="balanceTool.operate('add', 5)">+5 Both Sides</button>
                    <button class="btn btn-secondary" onclick="balanceTool.operate('multiply', 2)">√ó2 Both Sides</button>
                    <button class="btn btn-secondary" onclick="balanceTool.operate('divide', 2)">√∑2 Both Sides</button>
                    <button class="btn btn-info" onclick="balanceTool.solve()">Solve</button>
                    <button class="btn btn-danger" onclick="balanceTool.reset()">Reset</button>
                `;

                this.render();
            },

            reset() {
                this.leftSide = 'x + 3';
                this.rightSide = '7';
                this.render();
            },

            operate(op, value) {
                const val = prompt(`Enter value to ${op} on both sides:`, value);
                if (val === null) return;
                const num = parseFloat(val);
                if (isNaN(num)) return;

                try {
                    let left = this.evaluateExpression(this.leftSide, 0, true);
                    let right = this.evaluateExpression(this.rightSide, 0, true);

                    if (op === 'add') {
                        this.leftSide = `(${this.leftSide}) + ${num}`;
                        this.rightSide = `(${this.rightSide}) + ${num}`;
                        showFeedback(`Added ${num} to both sides`, 'info');
                    } else if (op === 'subtract') {
                        this.leftSide = `(${this.leftSide}) - ${num}`;
                        this.rightSide = `(${this.rightSide}) - ${num}`;
                        showFeedback(`Subtracted ${num} from both sides`, 'info');
                    } else if (op === 'multiply') {
                        this.leftSide = `(${this.leftSide}) * ${num}`;
                        this.rightSide = `(${this.rightSide}) * ${num}`;
                        showFeedback(`Multiplied both sides by ${num}`, 'info');
                    } else if (op === 'divide') {
                        if (num === 0) {
                            showFeedback('Cannot divide by zero!', 'error');
                            return;
                        }
                        this.leftSide = `(${this.leftSide}) / ${num}`;
                        this.rightSide = `(${this.rightSide}) / ${num}`;
                        showFeedback(`Divided both sides by ${num}`, 'info');
                    }

                    this.render();
                } catch (e) {
                    showFeedback('Invalid operation', 'error');
                }
            },

            solve() {
                // Try to find x value that balances
                let found = false;
                for (let x = -100; x <= 100; x += 0.5) {
                    const left = this.evaluateExpression(this.leftSide, x);
                    const right = this.evaluateExpression(this.rightSide, x);
                    if (Math.abs(left - right) < 0.01) {
                        showFeedback(`Solution: x = ${x}`, 'success');
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    showFeedback('Could not find solution in range [-100, 100]', 'error');
                }
            },

            evaluateExpression(expr, x, isSymbolic = false) {
                try {
                    if (isSymbolic) return expr;
                    const replaced = expr.replace(/x/g, `(${x})`);
                    return eval(replaced);
                } catch (e) {
                    return 0;
                }
            },

            render() {
                const workspace = document.getElementById('balance-workspace');
                
                workspace.innerHTML = `
                    <h3 style="margin-bottom:20px;">Equation: ${this.leftSide} = ${this.rightSide}</h3>
                `;

                // Input panels
                const leftPanel = document.createElement('div');
                leftPanel.className = 'side-panel';
                leftPanel.innerHTML = `
                    <h4>Left Side</h4>
                    <input type="text" class="expression-input" value="${this.leftSide}" 
                           onchange="balanceTool.leftSide = this.value; balanceTool.render();">
                `;

                const rightPanel = document.createElement('div');
                rightPanel.className = 'side-panel';
                rightPanel.innerHTML = `
                    <h4>Right Side</h4>
                    <input type="text" class="expression-input" value="${this.rightSide}"
                           onchange="balanceTool.rightSide = this.value; balanceTool.render();">
                `;

                workspace.appendChild(leftPanel);
                workspace.appendChild(rightPanel);

                // Draw balance scale
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('class', 'scale-svg');
                svg.setAttribute('viewBox', '0 0 800 400');

                // Evaluate for visualization
                const leftVal = this.evaluateExpression(this.leftSide, 0);
                const rightVal = this.evaluateExpression(this.rightSide, 0);
                const diff = leftVal - rightVal;
                const maxTilt = 30;
                const tilt = Math.max(-maxTilt, Math.min(maxTilt, diff * 5));

                // Support beam
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', '200');
                line.setAttribute('y1', '200');
                line.setAttribute('x2', '600');
                line.setAttribute('y2', '200');
                line.setAttribute('stroke', '#1f2937');
                line.setAttribute('stroke-width', '8');
                line.setAttribute('transform', `rotate(${tilt} 400 200)`);
                svg.appendChild(line);

                // Central pivot
                const pivot = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                pivot.setAttribute('points', '380,200 420,200 400,230');
                pivot.setAttribute('fill', '#1f2937');
                svg.appendChild(pivot);

                // Left pan
                const leftPan = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                leftPan.setAttribute('x', '150');
                leftPan.setAttribute('y', '160');
                leftPan.setAttribute('width', '100');
                leftPan.setAttribute('height', '60');
                leftPan.setAttribute('fill', '#3b82f6');
                leftPan.setAttribute('stroke', '#1f2937');
                leftPan.setAttribute('stroke-width', '3');
                leftPan.setAttribute('rx', '5');
                leftPan.setAttribute('transform', `rotate(${tilt} 400 200)`);
                svg.appendChild(leftPan);

                // Right pan
                const rightPan = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rightPan.setAttribute('x', '550');
                rightPan.setAttribute('y', '160');
                rightPan.setAttribute('width', '100');
                rightPan.setAttribute('height', '60');
                rightPan.setAttribute('fill', '#10b981');
                rightPan.setAttribute('stroke', '#1f2937');
                rightPan.setAttribute('stroke-width', '3');
                rightPan.setAttribute('rx', '5');
                rightPan.setAttribute('transform', `rotate(${tilt} 400 200)`);
                svg.appendChild(rightPan);

                // Balance status
                const status = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                status.setAttribute('x', '400');
                status.setAttribute('y', '350');
                status.setAttribute('text-anchor', 'middle');
                status.setAttribute('font-size', '24');
                status.setAttribute('font-weight', 'bold');
                status.setAttribute('fill', Math.abs(diff) < 0.1 ? '#10b981' : '#ef4444');
                status.textContent = Math.abs(diff) < 0.1 ? '‚öñÔ∏è Balanced!' : (diff > 0 ? '‚Üê Heavier' : 'Heavier ‚Üí');
                svg.appendChild(status);

                workspace.appendChild(svg);
            }
        };

        // ==================== FUNCTION GRAPHER ====================
        const functionGrapherTool = {
            name: 'Function Grapher',
            instructions: 'Graph linear functions y = mx + b. Adjust slope (m) and y-intercept (b) with sliders to see how they affect the line.',
            m: 1,
            b: 0,

            init() {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '<div class="grapher-container" id="grapher-workspace"></div>';
                
                const controls = document.getElementById('main-controls');
                controls.innerHTML = `
                    <button class="btn btn-primary" onclick="functionGrapherTool.setFunction(1, 0)">y = x</button>
                    <button class="btn btn-primary" onclick="functionGrapherTool.setFunction(2, 3)">y = 2x + 3</button>
                    <button class="btn btn-primary" onclick="functionGrapherTool.setFunction(-1, 5)">y = ‚àíx + 5</button>
                    <button class="btn btn-primary" onclick="functionGrapherTool.setFunction(0.5, -2)">y = 0.5x ‚àí 2</button>
                    <button class="btn btn-danger" onclick="functionGrapherTool.reset()">Reset</button>
                `;

                this.render();
            },

            reset() {
                this.m = 1;
                this.b = 0;
                this.render();
            },

            setFunction(m, b) {
                this.m = m;
                this.b = b;
                this.render();
            },

            render() {
                const workspace = document.getElementById('grapher-workspace');
                
                // Slider controls
                const sliders = document.createElement('div');
                sliders.className = 'slider-controls';
                sliders.innerHTML = `
                    <h3 style="margin-bottom:20px;">Function: y = ${this.m}x + ${this.b}</h3>
                    <div class="slider-group">
                        <label>Slope (m):</label>
                        <input type="range" min="-5" max="5" step="0.1" value="${this.m}"
                               oninput="functionGrapherTool.m = parseFloat(this.value); functionGrapherTool.render();">
                        <span class="value-display">${this.m.toFixed(1)}</span>
                    </div>
                    <div class="slider-group">
                        <label>Y-intercept (b):</label>
                        <input type="range" min="-10" max="10" step="0.5" value="${this.b}"
                               oninput="functionGrapherTool.b = parseFloat(this.value); functionGrapherTool.render();">
                        <span class="value-display">${this.b.toFixed(1)}</span>
                    </div>
                `;

                const canvas = document.createElement('canvas');
                canvas.className = 'grapher-canvas';
                canvas.width = 600;
                canvas.height = 600;

                workspace.innerHTML = '';
                workspace.appendChild(sliders);
                workspace.appendChild(canvas);

                this.drawGraph(canvas);
            },

            drawGraph(canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const centerX = 300;
                const centerY = 300;
                const scale = 30;

                // Draw grid
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let x = -10; x <= 10; x++) {
                    const px = centerX + x * scale;
                    ctx.beginPath();
                    ctx.moveTo(px, 0);
                    ctx.lineTo(px, 600);
                    ctx.stroke();
                }
                for (let y = -10; y <= 10; y++) {
                    const py = centerY - y * scale;
                    ctx.beginPath();
                    ctx.moveTo(0, py);
                    ctx.lineTo(600, py);
                    ctx.stroke();
                }

                // Draw axes
                ctx.strokeStyle = '#1f2937';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(0, centerY);
                ctx.lineTo(600, centerY);
                ctx.moveTo(centerX, 0);
                ctx.lineTo(centerX, 600);
                ctx.stroke();

                // Draw function line
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 3;
                ctx.beginPath();
                for (let x = -10; x <= 10; x += 0.1) {
                    const y = this.m * x + this.b;
                    const px = centerX + x * scale;
                    const py = centerY - y * scale;
                    if (x === -10) {
                        ctx.moveTo(px, py);
                    } else {
                        ctx.lineTo(px, py);
                    }
                }
                ctx.stroke();

                // Draw y-intercept point
                const interceptY = this.b;
                ctx.fillStyle = '#ef4444';
                ctx.beginPath();
                ctx.arc(centerX, centerY - interceptY * scale, 6, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#1f2937';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Label
                ctx.fillStyle = '#1f2937';
                ctx.font = 'bold 14px system-ui';
                ctx.textAlign = 'center';
                ctx.fillText(`(0, ${this.b})`, centerX + 30, centerY - interceptY * scale - 10);

                // Draw slope indicator
                if (this.m !== 0) {
                    const startX = 0;
                    const startY = this.m * startX + this.b;
                    const endX = 1;
                    const endY = this.m * endX + this.b;

                    const px1 = centerX + startX * scale;
                    const py1 = centerY - startY * scale;
                    const px2 = centerX + endX * scale;
                    const py2 = centerY - endY * scale;

                    // Rise and run lines
                    ctx.strokeStyle = '#10b981';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(px1, py1);
                    ctx.lineTo(px2, py1);
                    ctx.lineTo(px2, py2);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    ctx.fillStyle = '#10b981';
                    ctx.font = 'bold 12px system-ui';
                    ctx.fillText('run = 1', px1 + scale / 2, py1 + 15);
                    ctx.fillText(`rise = ${this.m.toFixed(1)}`, px2 + 25, py1 - (py2 - py1) / 2);
                }
            }
        };

        // ==================== QUADRATIC VISUALIZER ====================
        const quadraticTool = {
            name: 'Quadratic Visualizer',
            instructions: 'Explore quadratic functions! Switch between standard form (ax¬≤ + bx + c), vertex form, and factored form. See vertex, axis of symmetry, and roots.',
            form: 'standard',
            a: 1,
            b: 0,
            c: 0,

            init() {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '<div class="quadratic-container" id="quadratic-workspace"></div>';
                
                const controls = document.getElementById('main-controls');
                controls.innerHTML = `
                    <button class="btn btn-primary" onclick="quadraticTool.setQuadratic(1, 0, 0)">y = x¬≤</button>
                    <button class="btn btn-primary" onclick="quadraticTool.setQuadratic(1, 0, -4)">y = x¬≤ ‚àí 4</button>
                    <button class="btn btn-primary" onclick="quadraticTool.setQuadratic(-1, 0, 9)">y = ‚àíx¬≤ + 9</button>
                    <button class="btn btn-primary" onclick="quadraticTool.setQuadratic(1, -4, 3)">y = x¬≤ ‚àí 4x + 3</button>
                    <button class="btn btn-danger" onclick="quadraticTool.reset()">Reset</button>
                `;

                this.render();
            },

            reset() {
                this.a = 1;
                this.b = 0;
                this.c = 0;
                this.render();
            },

            setQuadratic(a, b, c) {
                this.a = a;
                this.b = b;
                this.c = c;
                this.render();
            },

            render() {
                const workspace = document.getElementById('quadratic-workspace');
                
                // Form selector
                const formSelector = document.createElement('div');
                formSelector.className = 'form-selector';
                formSelector.innerHTML = `
                    <div class="form-btn ${this.form === 'standard' ? 'active' : ''}" 
                         onclick="quadraticTool.form = 'standard'; quadraticTool.render();">
                        Standard Form
                    </div>
                    <div class="form-btn ${this.form === 'vertex' ? 'active' : ''}"
                         onclick="quadraticTool.form = 'vertex'; quadraticTool.render();">
                        Vertex Form
                    </div>
                    <div class="form-btn ${this.form === 'factored' ? 'active' : ''}"
                         onclick="quadraticTool.form = 'factored'; quadraticTool.render();">
                        Factored Form
                    </div>
                `;

                // Sliders
                const sliders = document.createElement('div');
                sliders.className = 'slider-controls';
                sliders.innerHTML = `
                    <h3 style="margin-bottom:20px;">y = ${this.a}x¬≤ + ${this.b}x + ${this.c}</h3>
                    <div class="slider-group">
                        <label>a:</label>
                        <input type="range" min="-5" max="5" step="0.1" value="${this.a}"
                               oninput="quadraticTool.a = parseFloat(this.value); quadraticTool.render();">
                        <span class="value-display">${this.a.toFixed(1)}</span>
                    </div>
                    <div class="slider-group">
                        <label>b:</label>
                        <input type="range" min="-10" max="10" step="0.5" value="${this.b}"
                               oninput="quadraticTool.b = parseFloat(this.value); quadraticTool.render();">
                        <span class="value-display">${this.b.toFixed(1)}</span>
                    </div>
                    <div class="slider-group">
                        <label>c:</label>
                        <input type="range" min="-10" max="10" step="0.5" value="${this.c}"
                               oninput="quadraticTool.c = parseFloat(this.value); quadraticTool.render();">
                        <span class="value-display">${this.c.toFixed(1)}</span>
                    </div>
                `;

                const canvas = document.createElement('canvas');
                canvas.className = 'grapher-canvas';
                canvas.width = 600;
                canvas.height = 600;

                workspace.innerHTML = '';
                workspace.appendChild(formSelector);
                workspace.appendChild(sliders);
                workspace.appendChild(canvas);

                this.drawQuadratic(canvas);

                // Show vertex and form info
                const h = -this.b / (2 * this.a);
                const k = this.a * h * h + this.b * h + this.c;
                
                const info = document.createElement('div');
                info.style.marginTop = '20px';
                info.style.padding = '15px';
                info.style.background = '#f3f4f6';
                info.style.borderRadius = '10px';
                info.style.textAlign = 'left';
                info.style.maxWidth = '500px';
                info.style.margin = '20px auto';
                
                let formText = '';
                if (this.form === 'vertex') {
                    formText = `<strong>Vertex Form:</strong> y = ${this.a}(x ‚àí ${h.toFixed(2)})¬≤ + ${k.toFixed(2)}`;
                } else if (this.form === 'factored') {
                    const discriminant = this.b * this.b - 4 * this.a * this.c;
                    if (discriminant >= 0) {
                        const r1 = (-this.b + Math.sqrt(discriminant)) / (2 * this.a);
                        const r2 = (-this.b - Math.sqrt(discriminant)) / (2 * this.a);
                        formText = `<strong>Factored Form:</strong> y = ${this.a}(x ‚àí ${r1.toFixed(2)})(x ‚àí ${r2.toFixed(2)})`;
                    } else {
                        formText = `<strong>Factored Form:</strong> No real roots (discriminant < 0)`;
                    }
                } else {
                    formText = `<strong>Standard Form:</strong> y = ${this.a}x¬≤ + ${this.b}x + ${this.c}`;
                }
                
                info.innerHTML = `
                    ${formText}<br>
                    <strong>Vertex:</strong> (${h.toFixed(2)}, ${k.toFixed(2)})<br>
                    <strong>Axis of Symmetry:</strong> x = ${h.toFixed(2)}<br>
                    <strong>Opens:</strong> ${this.a > 0 ? 'Upward ‚¨ÜÔ∏è' : 'Downward ‚¨áÔ∏è'}
                `;
                
                workspace.appendChild(info);
            },

            drawQuadratic(canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const centerX = 300;
                const centerY = 300;
                const scale = 30;

                // Draw grid
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let x = -10; x <= 10; x++) {
                    const px = centerX + x * scale;
                    ctx.beginPath();
                    ctx.moveTo(px, 0);
                    ctx.lineTo(px, 600);
                    ctx.stroke();
                }
                for (let y = -10; y <= 10; y++) {
                    const py = centerY - y * scale;
                    ctx.beginPath();
                    ctx.moveTo(0, py);
                    ctx.lineTo(600, py);
                    ctx.stroke();
                }

                // Draw axes
                ctx.strokeStyle = '#1f2937';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(0, centerY);
                ctx.lineTo(600, centerY);
                ctx.moveTo(centerX, 0);
                ctx.lineTo(centerX, 600);
                ctx.stroke();

                // Draw parabola
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 3;
                ctx.beginPath();
                let started = false;
                for (let x = -10; x <= 10; x += 0.05) {
                    const y = this.a * x * x + this.b * x + this.c;
                    if (Math.abs(y) > 10) continue;
                    const px = centerX + x * scale;
                    const py = centerY - y * scale;
                    if (!started) {
                        ctx.moveTo(px, py);
                        started = true;
                    } else {
                        ctx.lineTo(px, py);
                    }
                }
                ctx.stroke();

                // Draw vertex
                const h = -this.b / (2 * this.a);
                const k = this.a * h * h + this.b * h + this.c;
                ctx.fillStyle = '#ef4444';
                ctx.beginPath();
                ctx.arc(centerX + h * scale, centerY - k * scale, 6, 0, Math.PI * 2);
                ctx.fill();

                // Draw axis of symmetry
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(centerX + h * scale, 0);
                ctx.lineTo(centerX + h * scale, 600);
                ctx.stroke();
                ctx.setLineDash([]);

                // Draw roots if they exist
                const discriminant = this.b * this.b - 4 * this.a * this.c;
                if (discriminant >= 0) {
                    const r1 = (-this.b + Math.sqrt(discriminant)) / (2 * this.a);
                    const r2 = (-this.b - Math.sqrt(discriminant)) / (2 * this.a);
                    
                    if (Math.abs(r1) <= 10) {
                        ctx.fillStyle = '#f59e0b';
                        ctx.beginPath();
                        ctx.arc(centerX + r1 * scale, centerY, 6, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    if (Math.abs(r2) <= 10 && Math.abs(r1 - r2) > 0.1) {
                        ctx.fillStyle = '#f59e0b';
                        ctx.beginPath();
                        ctx.arc(centerX + r2 * scale, centerY, 6, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            }
        };

        // ==================== SYSTEM OF EQUATIONS ====================
        const systemTool = {
            name: 'System of Equations Grapher',
            instructions: 'Graph two linear equations and find their intersection point (the solution). Adjust coefficients to see how the solution changes.',
            a1: 1, b1: 1, c1: 5,
            a2: 1, b2: -1, c2: 1,

            init() {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '<div class="system-container" id="system-workspace"></div>';
                
                const controls = document.getElementById('main-controls');
                controls.innerHTML = `
                    <button class="btn btn-primary" onclick="systemTool.setSystem(1,1,5,1,-1,1)">x + y = 5, x ‚àí y = 1</button>
                    <button class="btn btn-primary" onclick="systemTool.setSystem(2,1,7,1,-1,-1)">2x + y = 7, x ‚àí y = ‚àí1</button>
                    <button class="btn btn-secondary" onclick="systemTool.findSolution()">Find Solution</button>
                    <button class="btn btn-danger" onclick="systemTool.reset()">Reset</button>
                `;

                this.render();
            },

            reset() {
                this.a1 = 1; this.b1 = 1; this.c1 = 5;
                this.a2 = 1; this.b2 = -1; this.c2 = 1;
                this.render();
            },

            setSystem(a1, b1, c1, a2, b2, c2) {
                this.a1 = a1; this.b1 = b1; this.c1 = c1;
                this.a2 = a2; this.b2 = b2; this.c2 = c2;
                this.render();
            },

            findSolution() {
                // Solve using elimination/substitution
                const det = this.a1 * this.b2 - this.a2 * this.b1;
                
                if (Math.abs(det) < 0.001) {
                    showFeedback('Lines are parallel (no solution) or coincident (infinite solutions)', 'error');
                    return;
                }
                
                const x = (this.c1 * this.b2 - this.c2 * this.b1) / det;
                const y = (this.a1 * this.c2 - this.a2 * this.c1) / det;
                
                showFeedback(`Solution: x = ${x.toFixed(2)}, y = ${y.toFixed(2)}`, 'success');
            },

            render() {
                const workspace = document.getElementById('system-workspace');
                
                // Equation inputs
                const inputs = document.createElement('div');
                inputs.className = 'equation-inputs';
                inputs.innerHTML = `
                    <h3 style="margin-bottom:20px;">System of Equations</h3>
                    <div class="equation-row">
                        <input type="number" value="${this.a1}" step="0.5" 
                               onchange="systemTool.a1 = parseFloat(this.value); systemTool.render();">
                        <span>x +</span>
                        <input type="number" value="${this.b1}" step="0.5"
                               onchange="systemTool.b1 = parseFloat(this.value); systemTool.render();">
                        <span>y =</span>
                        <input type="number" value="${this.c1}" step="0.5"
                               onchange="systemTool.c1 = parseFloat(this.value); systemTool.render();">
                    </div>
                    <div class="equation-row">
                        <input type="number" value="${this.a2}" step="0.5"
                               onchange="systemTool.a2 = parseFloat(this.value); systemTool.render();">
                        <span>x +</span>
                        <input type="number" value="${this.b2}" step="0.5"
                               onchange="systemTool.b2 = parseFloat(this.value); systemTool.render();">
                        <span>y =</span>
                        <input type="number" value="${this.c2}" step="0.5"
                               onchange="systemTool.c2 = parseFloat(this.value); systemTool.render();">
                    </div>
                `;

                const canvas = document.createElement('canvas');
                canvas.className = 'grapher-canvas';
                canvas.width = 600;
                canvas.height = 600;

                workspace.innerHTML = '';
                workspace.appendChild(inputs);
                workspace.appendChild(canvas);

                this.drawSystem(canvas);

                // Show solution if exists
                const det = this.a1 * this.b2 - this.a2 * this.b1;
                if (Math.abs(det) >= 0.001) {
                    const x = (this.c1 * this.b2 - this.c2 * this.b1) / det;
                    const y = (this.a1 * this.c2 - this.a2 * this.c1) / det;
                    
                    const solution = document.createElement('div');
                    solution.className = 'solution-display';
                    solution.innerHTML = `
                        <strong>Intersection Point (Solution):</strong><br>
                        x = ${x.toFixed(2)}, y = ${y.toFixed(2)}
                    `;
                    workspace.appendChild(solution);
                }
            },

            drawSystem(canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const centerX = 300;
                const centerY = 300;
                const scale = 30;

                // Draw grid
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let x = -10; x <= 10; x++) {
                    const px = centerX + x * scale;
                    ctx.beginPath();
                    ctx.moveTo(px, 0);
                    ctx.lineTo(px, 600);
                    ctx.stroke();
                }
                for (let y = -10; y <= 10; y++) {
                    const py = centerY - y * scale;
                    ctx.beginPath();
                    ctx.moveTo(0, py);
                    ctx.lineTo(600, py);
                    ctx.stroke();
                }

                // Draw axes
                ctx.strokeStyle = '#1f2937';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(0, centerY);
                ctx.lineTo(600, centerY);
                ctx.moveTo(centerX, 0);
                ctx.lineTo(centerX, 600);
                ctx.stroke();

                // Draw first equation (blue)
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 3;
                ctx.beginPath();
                if (Math.abs(this.b1) > 0.001) {
                    // y = (c1 - a1*x) / b1
                    for (let x = -10; x <= 10; x += 0.1) {
                        const y = (this.c1 - this.a1 * x) / this.b1;
                        const px = centerX + x * scale;
                        const py = centerY - y * scale;
                        if (x === -10) ctx.moveTo(px, py);
                        else ctx.lineTo(px, py);
                    }
                } else {
                    // Vertical line x = c1/a1
                    const x = this.c1 / this.a1;
                    const px = centerX + x * scale;
                    ctx.moveTo(px, 0);
                    ctx.lineTo(px, 600);
                }
                ctx.stroke();

                // Draw second equation (green)
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 3;
                ctx.beginPath();
                if (Math.abs(this.b2) > 0.001) {
                    for (let x = -10; x <= 10; x += 0.1) {
                        const y = (this.c2 - this.a2 * x) / this.b2;
                        const px = centerX + x * scale;
                        const py = centerY - y * scale;
                        if (x === -10) ctx.moveTo(px, py);
                        else ctx.lineTo(px, py);
                    }
                } else {
                    const x = this.c2 / this.a2;
                    const px = centerX + x * scale;
                    ctx.moveTo(px, 0);
                    ctx.lineTo(px, 600);
                }
                ctx.stroke();

                // Draw intersection point
                const det = this.a1 * this.b2 - this.a2 * this.b1;
                if (Math.abs(det) >= 0.001) {
                    const x = (this.c1 * this.b2 - this.c2 * this.b1) / det;
                    const y = (this.a1 * this.c2 - this.a2 * this.c1) / det;
                    
                    if (Math.abs(x) <= 10 && Math.abs(y) <= 10) {
                        ctx.fillStyle = '#ef4444';
                        ctx.beginPath();
                        ctx.arc(centerX + x * scale, centerY - y * scale, 8, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.strokeStyle = '#1f2937';
                        ctx.lineWidth = 2;
                        ctx.stroke();

                        ctx.fillStyle = '#1f2937';
                        ctx.font = 'bold 14px system-ui';
                        ctx.textAlign = 'center';
                        ctx.fillText(`(${x.toFixed(1)}, ${y.toFixed(1)})`, 
                                    centerX + x * scale, centerY - y * scale - 15);
                    }
                }
            }
        };

        // ==================== PERCENTAGE GRID (100-SQUARE) ====================
        const percentGridTool = {
            name: 'Percentage Grid (100 Squares)',
            instructions: 'Click squares to fill them. Each square represents 1%. Click and drag to fill multiple squares at once.',
            filled: new Set(),
            isSelecting: false,

            init() {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '<div class="decimal-grid-container" id="grid-workspace"></div>';
                
                const controls = document.getElementById('main-controls');
                controls.innerHTML = `
                    <button class="btn btn-secondary" onclick="percentGridTool.fillPercent()">Fill Percentage</button>
                    <button class="btn btn-info" onclick="percentGridTool.showPercent()">Show Percentage</button>
                    <button class="btn btn-danger" onclick="percentGridTool.clear()">Clear</button>
                `;

                this.render();
            },

            clear() {
                this.filled.clear();
                this.render();
            },

            render() {
                const workspace = document.getElementById('grid-workspace');
                
                const grid = document.createElement('div');
                grid.className = 'grid-100';
                grid.id = 'percent-grid';

                for (let i = 0; i < 100; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.index = i;
                    
                    if (this.filled.has(i)) {
                        cell.classList.add('filled');
                    }

                    grid.appendChild(cell);
                }

                // Event listeners for selection
                grid.addEventListener('mousedown', (e) => this.startSelection(e));
                grid.addEventListener('mousemove', (e) => this.updateSelection(e));
                grid.addEventListener('mouseup', (e) => this.endSelection(e));
                grid.addEventListener('mouseleave', (e) => this.endSelection(e));

                const info = document.createElement('div');
                info.className = 'grid-info';
                const percent = this.filled.size;
                const decimal = (percent / 100).toFixed(2);
                info.textContent = `Filled: ${percent}% = ${decimal} = ${percent}/100`;

                workspace.innerHTML = '';
                workspace.appendChild(grid);
                workspace.appendChild(info);
            },

            startSelection(e) {
                if (e.target.classList.contains('grid-cell')) {
                    this.isSelecting = true;
                    const index = parseInt(e.target.dataset.index);
                    
                    if (this.filled.has(index)) {
                        this.filled.delete(index);
                        this.selectingMode = 'remove';
                    } else {
                        this.filled.add(index);
                        this.selectingMode = 'add';
                    }
                    this.render();
                }
            },

            updateSelection(e) {
                if (!this.isSelecting) return;
                
                if (e.target.classList.contains('grid-cell')) {
                    const index = parseInt(e.target.dataset.index);
                    if (this.selectingMode === 'add') {
                        this.filled.add(index);
                    } else {
                        this.filled.delete(index);
                    }
                    this.render();
                }
            },

            endSelection(e) {
                this.isSelecting = false;
            },

            fillPercent() {
                const value = prompt('Enter percentage to fill (0-100):');
                if (value === null) return;
                const num = parseInt(value);
                if (isNaN(num) || num < 0 || num > 100) {
                    showFeedback('Please enter a number between 0 and 100', 'error');
                    return;
                }
                
                this.filled.clear();
                for (let i = 0; i < num; i++) {
                    this.filled.add(i);
                }
                this.render();
                showFeedback(`Filled ${num}%`, 'success');
            },

            showPercent() {
                const percent = this.filled.size;
                const decimal = (percent / 100).toFixed(2);
                const fraction = `${percent}/100`;
                showFeedback(`${percent}% = ${decimal} = ${fraction}`, 'success');
            }
        };

        // ==================== TOOL REGISTRY ====================
        const tools = {
            'place-value': placeValueTool,
            'fractions': fractionsTool,
            'array': arrayTool,
            'division': divisionTool,
            'numberline': numberLineTool,
            'decimal-blocks': decimalBlocksTool,
            'decimal-line': decimalLineTool,
            'percent-grid': percentGridTool,
            'protractor': protractorTool,
            'polygon': polygonTool,
            'coordinate': coordinateTool,
            'transform': transformTool,
            'algebra-tiles': algebraTilesTool,
            'balance': balanceTool,
            'function-graph': functionGrapherTool,
            'quadratic': quadraticTool,
            'system': systemTool
        };

        // ==================== TOOL SWITCHING ====================
        function switchTool(toolType) {
            if (currentTool === toolType) return;
            
            // Clear workspace when switching
            blocks = [];
            selectedIds.clear();
            dragging = null;
            selectionRect = null;
            
            currentTool = toolType;
            const tool = tools[toolType];
            
            document.querySelectorAll('.manipulative-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === toolType) {
                    btn.classList.add('active');
                }
            });

            document.getElementById('workspace-title').textContent = tool.name;
            
            const instructions = document.getElementById('instructions');
            instructions.innerHTML = `<h3>How to use:</h3><p>${tool.instructions}</p>`;
            
            document.getElementById('feedback').classList.remove('show');
            
            tool.init();
        }

        function renderCurrentTool() {
            const tool = tools[currentTool];
            if (tool && tool.render) {
                tool.render();
            }
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.manipulative-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchTool(btn.dataset.type);
                });
            });

            const workspaceEl = document.getElementById('workspace');
            const controlsToggle = document.getElementById('controls-toggle');
            if (workspaceEl && controlsToggle) {
                controlsToggle.addEventListener('click', () => {
                    const collapsed = workspaceEl.classList.toggle('controls-minimized');
                    controlsToggle.setAttribute('aria-expanded', (!collapsed).toString());
                    controlsToggle.textContent = collapsed ? 'Show Controls' : 'Hide Controls';
                    controlsToggle.classList.toggle('active', collapsed);
                });
            }

            const sidebar = document.getElementById('topic-sidebar');
            const mainContent = document.querySelector('.main-content');
            const topicsToggle = document.getElementById('topics-toggle');
            if (sidebar && mainContent && topicsToggle) {
                topicsToggle.addEventListener('click', () => {
                    const collapsed = sidebar.classList.toggle('topics-collapsed');
                    topicsToggle.setAttribute('aria-expanded', (!collapsed).toString());
                    topicsToggle.textContent = collapsed ? 'Show Topics' : 'Hide Topics';
                    topicsToggle.classList.toggle('active', collapsed);
                    mainContent.classList.toggle('topics-collapsed', collapsed);
                });
            }

            switchTool('place-value');
        });
    </script>
</body>
</html>
